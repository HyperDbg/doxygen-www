<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HyperDbg Debugger: hyperdbg/hyperhv/header/hooks/ExecTrap.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">HyperDbg Debugger
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_exec_trap_8h.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">ExecTrap.h File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Header for the user-mode, kernel-mode execution traps' routines.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;pch.h&quot;</code><br />
</div>
<p><a href="_exec_trap_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html">_USER_KERNEL_EXECUTION_TRAP_STATE</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">The status user-mode, kernel-mode execution traps for processes.  <a href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:aa6e5dea9898627ec299bb261e8532643" id="r_aa6e5dea9898627ec299bb261e8532643"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aa6e5dea9898627ec299bb261e8532643">MAXIMUM_NUMBER_OF_PROCESSES_FOR_USER_KERNEL_EXEC_THREAD</a>&#160;&#160;&#160;100</td></tr>
<tr class="memdesc:aa6e5dea9898627ec299bb261e8532643"><td class="mdescLeft">&#160;</td><td class="mdescRight">maximum number of processes for a simultaneous user-mode, kernel-mode execution trap  <br /></td></tr>
<tr class="separator:aa6e5dea9898627ec299bb261e8532643"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="typedef-members" name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:ab1263e7915f5950e0bcce870fe7edddc" id="r_ab1263e7915f5950e0bcce870fe7edddc"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html">_USER_KERNEL_EXECUTION_TRAP_STATE</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ab1263e7915f5950e0bcce870fe7edddc">USER_KERNEL_EXECUTION_TRAP_STATE</a></td></tr>
<tr class="memdesc:ab1263e7915f5950e0bcce870fe7edddc"><td class="mdescLeft">&#160;</td><td class="mdescRight">The status user-mode, kernel-mode execution traps for processes.  <br /></td></tr>
<tr class="separator:ab1263e7915f5950e0bcce870fe7edddc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4e495d6a6eeddf3e5145cb4c731d2c48" id="r_a4e495d6a6eeddf3e5145cb4c731d2c48"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html">_USER_KERNEL_EXECUTION_TRAP_STATE</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a4e495d6a6eeddf3e5145cb4c731d2c48">PUSER_KERNEL_EXECUTION_TRAP_STATE</a></td></tr>
<tr class="separator:a4e495d6a6eeddf3e5145cb4c731d2c48"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a2995044b89b1a737eba0fc2621f4b697" id="r_a2995044b89b1a737eba0fc2621f4b697"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a2995044b89b1a737eba0fc2621f4b697">ExecTrapHandleCr3Vmexit</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu)</td></tr>
<tr class="memdesc:a2995044b89b1a737eba0fc2621f4b697"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handle MOV to CR3 vm-exits for hooking mode execution.  <br /></td></tr>
<tr class="separator:a2995044b89b1a737eba0fc2621f4b697"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aab11493ed60e326089cdeb660835bbbc" id="r_aab11493ed60e326089cdeb660835bbbc"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aab11493ed60e326089cdeb660835bbbc">ExecTrapChangeToUserDisabledMbecEptp</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu)</td></tr>
<tr class="memdesc:aab11493ed60e326089cdeb660835bbbc"><td class="mdescLeft">&#160;</td><td class="mdescRight">change to user-disabled MBEC EPTP  <br /></td></tr>
<tr class="separator:aab11493ed60e326089cdeb660835bbbc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8677e09ccac4d79be30150d8e4e97f3f" id="r_a8677e09ccac4d79be30150d8e4e97f3f"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a8677e09ccac4d79be30150d8e4e97f3f">ExecTrapChangeToKernelDisabledMbecEptp</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu)</td></tr>
<tr class="memdesc:a8677e09ccac4d79be30150d8e4e97f3f"><td class="mdescLeft">&#160;</td><td class="mdescRight">change to kernel-disabled MBEC EPTP  <br /></td></tr>
<tr class="separator:a8677e09ccac4d79be30150d8e4e97f3f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a22855316678446d7d33cda0836a1ee70" id="r_a22855316678446d7d33cda0836a1ee70"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a22855316678446d7d33cda0836a1ee70">ExecTrapRestoreToNormalEptp</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu)</td></tr>
<tr class="memdesc:a22855316678446d7d33cda0836a1ee70"><td class="mdescLeft">&#160;</td><td class="mdescRight">restore to normal EPTP  <br /></td></tr>
<tr class="separator:a22855316678446d7d33cda0836a1ee70"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af65579bb774da528e4cbb0804a1d1c2d" id="r_af65579bb774da528e4cbb0804a1d1c2d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af65579bb774da528e4cbb0804a1d1c2d">ExecTrapHandleMoveToAdjustedTrapState</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, <a class="el" href="include_2_s_d_k_2_headers_2_events_8h.html#aae7e83f1666860f94b796560cdf1d308">DEBUGGER_EVENT_MODE_TYPE</a> TargetMode)</td></tr>
<tr class="memdesc:af65579bb774da528e4cbb0804a1d1c2d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Restore the execution of the trap to adjusted trap state.  <br /></td></tr>
<tr class="separator:af65579bb774da528e4cbb0804a1d1c2d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af6305fef8652aa0c6b3035abe039078d" id="r_af6305fef8652aa0c6b3035abe039078d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af6305fef8652aa0c6b3035abe039078d">ExecTrapUninitialize</a> ()</td></tr>
<tr class="memdesc:af6305fef8652aa0c6b3035abe039078d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Uinitialize the needed structure for the reversing machine.  <br /></td></tr>
<tr class="separator:af6305fef8652aa0c6b3035abe039078d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:add9956ac777904d17c0263f2bea40d4d" id="r_add9956ac777904d17c0263f2bea40d4d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#add9956ac777904d17c0263f2bea40d4d">ExecTrapInitialize</a> ()</td></tr>
<tr class="memdesc:add9956ac777904d17c0263f2bea40d4d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the reversing machine based on service request.  <br /></td></tr>
<tr class="separator:add9956ac777904d17c0263f2bea40d4d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af633002780953873a81572f3cd9073a3" id="r_af633002780953873a81572f3cd9073a3"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af633002780953873a81572f3cd9073a3">ExecTrapHandleEptViolationVmexit</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, VMX_EXIT_QUALIFICATION_EPT_VIOLATION *ViolationQualification)</td></tr>
<tr class="memdesc:af633002780953873a81572f3cd9073a3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handle EPT Violations related to the MBEC hooks.  <br /></td></tr>
<tr class="separator:af633002780953873a81572f3cd9073a3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae57b218aacbb56f7e91df45486f3ef47" id="r_ae57b218aacbb56f7e91df45486f3ef47"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ae57b218aacbb56f7e91df45486f3ef47">ExecTrapAddProcessToWatchingList</a> (<a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:ae57b218aacbb56f7e91df45486f3ef47"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add the target process to the watching list.  <br /></td></tr>
<tr class="separator:ae57b218aacbb56f7e91df45486f3ef47"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa7ef8278f2f66d2ff1c9b28c85ecae16" id="r_aa7ef8278f2f66d2ff1c9b28c85ecae16"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aa7ef8278f2f66d2ff1c9b28c85ecae16">ExecTrapRemoveProcessFromWatchingList</a> (<a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:aa7ef8278f2f66d2ff1c9b28c85ecae16"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove the target process from the watching list.  <br /></td></tr>
<tr class="separator:aa7ef8278f2f66d2ff1c9b28c85ecae16"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Header for the user-mode, kernel-mode execution traps' routines. </p>
<dl class="section author"><dt>Author</dt><dd>Sina Karvandi (<a href="#" onclick="location.href='mai'+'lto:'+'sin'+'a@'+'hyp'+'er'+'dbg'+'.o'+'rg'; return false;">sina@<span class="obfuscator">.nosp@m.</span>hype<span class="obfuscator">.nosp@m.</span>rdbg.<span class="obfuscator">.nosp@m.</span>org</a>)</dd></dl>
<dl class="section version"><dt>Version</dt><dd>0.4 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2023-07-05</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>This project is released under the GNU Public License v3. </dd></dl>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="aa6e5dea9898627ec299bb261e8532643" name="aa6e5dea9898627ec299bb261e8532643"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa6e5dea9898627ec299bb261e8532643">&#9670;&#160;</a></span>MAXIMUM_NUMBER_OF_PROCESSES_FOR_USER_KERNEL_EXEC_THREAD</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAXIMUM_NUMBER_OF_PROCESSES_FOR_USER_KERNEL_EXEC_THREAD&#160;&#160;&#160;100</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>maximum number of processes for a simultaneous user-mode, kernel-mode execution trap </p>

</div>
</div>
<h2 class="groupheader">Typedef Documentation</h2>
<a id="a4e495d6a6eeddf3e5145cb4c731d2c48" name="a4e495d6a6eeddf3e5145cb4c731d2c48"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4e495d6a6eeddf3e5145cb4c731d2c48">&#9670;&#160;</a></span>PUSER_KERNEL_EXECUTION_TRAP_STATE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html">_USER_KERNEL_EXECUTION_TRAP_STATE</a> * <a class="el" href="#a4e495d6a6eeddf3e5145cb4c731d2c48">PUSER_KERNEL_EXECUTION_TRAP_STATE</a></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ab1263e7915f5950e0bcce870fe7edddc" name="ab1263e7915f5950e0bcce870fe7edddc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab1263e7915f5950e0bcce870fe7edddc">&#9670;&#160;</a></span>USER_KERNEL_EXECUTION_TRAP_STATE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html">_USER_KERNEL_EXECUTION_TRAP_STATE</a> <a class="el" href="#ab1263e7915f5950e0bcce870fe7edddc">USER_KERNEL_EXECUTION_TRAP_STATE</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The status user-mode, kernel-mode execution traps for processes. </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ae57b218aacbb56f7e91df45486f3ef47" name="ae57b218aacbb56f7e91df45486f3ef47"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae57b218aacbb56f7e91df45486f3ef47">&#9670;&#160;</a></span>ExecTrapAddProcessToWatchingList()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ExecTrapAddProcessToWatchingList </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>ProcessId</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Add the target process to the watching list. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ProcessId</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  895</span>{</div>
<div class="line"><span class="lineno">  896</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="_insertion_sort_8c.html#af4956353d71625cef96e1f984d1f965a">InsertionSortInsertItem</a>(&amp;<a class="code hl_variable" href="_global_variables_8h.html#a4975a1a51415ed672c7099dda529e37d">g_ExecTrapState</a>.<a class="code hl_variable" href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html#ae6f43f8059c6ce02d35b446b9bc2aff0">InterceptionProcessIds</a>[0],</div>
<div class="line"><span class="lineno">  897</span>                                   &amp;<a class="code hl_variable" href="_global_variables_8h.html#a4975a1a51415ed672c7099dda529e37d">g_ExecTrapState</a>.<a class="code hl_variable" href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html#a796bcde497482ba02bf633a74570a0c4">NumberOfItems</a>,</div>
<div class="line"><span class="lineno">  898</span>                                   <a class="code hl_define" href="#aa6e5dea9898627ec299bb261e8532643">MAXIMUM_NUMBER_OF_PROCESSES_FOR_USER_KERNEL_EXEC_THREAD</a>,</div>
<div class="line"><span class="lineno">  899</span>                                   (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)ProcessId);</div>
<div class="line"><span class="lineno">  900</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_aae17ebb9ef7279d026817fb22f8aebe9"><div class="ttname"><a href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></div><div class="ttdeci">unsigned __int64 UINT64</div><div class="ttdef"><b>Definition</b> BasicTypes.h:21</div></div>
<div class="ttc" id="a_exec_trap_8h_html_aa6e5dea9898627ec299bb261e8532643"><div class="ttname"><a href="#aa6e5dea9898627ec299bb261e8532643">MAXIMUM_NUMBER_OF_PROCESSES_FOR_USER_KERNEL_EXEC_THREAD</a></div><div class="ttdeci">#define MAXIMUM_NUMBER_OF_PROCESSES_FOR_USER_KERNEL_EXEC_THREAD</div><div class="ttdoc">maximum number of processes for a simultaneous user-mode, kernel-mode execution trap</div><div class="ttdef"><b>Definition</b> ExecTrap.h:23</div></div>
<div class="ttc" id="a_global_variables_8h_html_a4975a1a51415ed672c7099dda529e37d"><div class="ttname"><a href="_global_variables_8h.html#a4975a1a51415ed672c7099dda529e37d">g_ExecTrapState</a></div><div class="ttdeci">USER_KERNEL_EXECUTION_TRAP_STATE g_ExecTrapState</div><div class="ttdoc">State of the trap-flag.</div><div class="ttdef"><b>Definition</b> GlobalVariables.h:162</div></div>
<div class="ttc" id="a_insertion_sort_8c_html_af4956353d71625cef96e1f984d1f965a"><div class="ttname"><a href="_insertion_sort_8c.html#af4956353d71625cef96e1f984d1f965a">InsertionSortInsertItem</a></div><div class="ttdeci">BOOLEAN InsertionSortInsertItem(UINT64 ArrayPtr[], UINT32 *NumberOfItems, UINT32 MaxNumOfItems, UINT64 Key)</div><div class="ttdoc">Function to implement insertion sort.</div><div class="ttdef"><b>Definition</b> InsertionSort.c:24</div></div>
<div class="ttc" id="astruct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e_html_a796bcde497482ba02bf633a74570a0c4"><div class="ttname"><a href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html#a796bcde497482ba02bf633a74570a0c4">_USER_KERNEL_EXECUTION_TRAP_STATE::NumberOfItems</a></div><div class="ttdeci">UINT32 NumberOfItems</div><div class="ttdef"><b>Definition</b> ExecTrap.h:35</div></div>
<div class="ttc" id="astruct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e_html_ae6f43f8059c6ce02d35b446b9bc2aff0"><div class="ttname"><a href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html#ae6f43f8059c6ce02d35b446b9bc2aff0">_USER_KERNEL_EXECUTION_TRAP_STATE::InterceptionProcessIds</a></div><div class="ttdeci">UINT64 InterceptionProcessIds[MAXIMUM_NUMBER_OF_PROCESSES_FOR_USER_KERNEL_EXEC_THREAD]</div><div class="ttdef"><b>Definition</b> ExecTrap.h:36</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a8677e09ccac4d79be30150d8e4e97f3f" name="a8677e09ccac4d79be30150d8e4e97f3f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8677e09ccac4d79be30150d8e4e97f3f">&#9670;&#160;</a></span>ExecTrapChangeToKernelDisabledMbecEptp()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> ExecTrapChangeToKernelDisabledMbecEptp </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>change to kernel-disabled MBEC EPTP </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  732</span>{</div>
<div class="line"><span class="lineno">  733</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  734</span>    <span class="comment">// Change EPTP</span></div>
<div class="line"><span class="lineno">  735</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  736</span>    __vmx_vmwrite(VMCS_CTRL_EPT_POINTER, <a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a1d6d1b5324426281b587b38267aa5d00">ModeBasedKernelDisabledEptPointer</a>.AsUInt);</div>
<div class="line"><span class="lineno">  737</span> </div>
<div class="line"><span class="lineno">  738</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  739</span>    <span class="comment">// It&#39;s not on normal EPTP</span></div>
<div class="line"><span class="lineno">  740</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  741</span>    VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a266cabea79370927f063b9bf1041ced3">NotNormalEptp</a> = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  742</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdef"><b>Definition</b> BasicTypes.h:55</div></div>
<div class="ttc" id="a_global_variables_8h_html_a302f00c62e7ad092a9f44a3aa7452d99"><div class="ttname"><a href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a></div><div class="ttdeci">EPT_STATE * g_EptState</div><div class="ttdoc">Save the state and variables related to EPT.</div><div class="ttdef"><b>Definition</b> GlobalVariables.h:50</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a1d6d1b5324426281b587b38267aa5d00"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a1d6d1b5324426281b587b38267aa5d00">_EPT_STATE::ModeBasedKernelDisabledEptPointer</a></div><div class="ttdeci">EPT_POINTER ModeBasedKernelDisabledEptPointer</div><div class="ttdef"><b>Definition</b> Ept.h:125</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a266cabea79370927f063b9bf1041ced3"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a266cabea79370927f063b9bf1041ced3">_VIRTUAL_MACHINE_STATE::NotNormalEptp</a></div><div class="ttdeci">BOOLEAN NotNormalEptp</div><div class="ttdef"><b>Definition</b> State.h:300</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="aab11493ed60e326089cdeb660835bbbc" name="aab11493ed60e326089cdeb660835bbbc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aab11493ed60e326089cdeb660835bbbc">&#9670;&#160;</a></span>ExecTrapChangeToUserDisabledMbecEptp()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> ExecTrapChangeToUserDisabledMbecEptp </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>change to user-disabled MBEC EPTP </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  712</span>{</div>
<div class="line"><span class="lineno">  713</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  714</span>    <span class="comment">// Change EPTP</span></div>
<div class="line"><span class="lineno">  715</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  716</span>    __vmx_vmwrite(VMCS_CTRL_EPT_POINTER, <a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a5d5db70f115c934c1d970754d1435c8c">ModeBasedUserDisabledEptPointer</a>.AsUInt);</div>
<div class="line"><span class="lineno">  717</span> </div>
<div class="line"><span class="lineno">  718</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  719</span>    <span class="comment">// It&#39;s not on normal EPTP</span></div>
<div class="line"><span class="lineno">  720</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  721</span>    VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a266cabea79370927f063b9bf1041ced3">NotNormalEptp</a> = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  722</span>}</div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a5d5db70f115c934c1d970754d1435c8c"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a5d5db70f115c934c1d970754d1435c8c">_EPT_STATE::ModeBasedUserDisabledEptPointer</a></div><div class="ttdeci">EPT_POINTER ModeBasedUserDisabledEptPointer</div><div class="ttdef"><b>Definition</b> Ept.h:124</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a2995044b89b1a737eba0fc2621f4b697" name="a2995044b89b1a737eba0fc2621f4b697"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2995044b89b1a737eba0fc2621f4b697">&#9670;&#160;</a></span>ExecTrapHandleCr3Vmexit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> ExecTrapHandleCr3Vmexit </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Handle MOV to CR3 vm-exits for hooking mode execution. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  848</span>{</div>
<div class="line"><span class="lineno">  849</span>    <a class="code hl_typedef" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> Result;</div>
<div class="line"><span class="lineno">  850</span>    <a class="code hl_typedef" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>  Index;</div>
<div class="line"><span class="lineno">  851</span> </div>
<div class="line"><span class="lineno">  852</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  853</span>    <span class="comment">// Search the list of processes for the current process&#39;s user-execution</span></div>
<div class="line"><span class="lineno">  854</span>    <span class="comment">//  trap state</span></div>
<div class="line"><span class="lineno">  855</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  856</span>    Result = <a class="code hl_function" href="_binary_search_8c.html#ac1532f925279158a47a45e688224fb72">BinarySearchPerformSearchItem</a>(&amp;<a class="code hl_variable" href="_global_variables_8h.html#a4975a1a51415ed672c7099dda529e37d">g_ExecTrapState</a>.<a class="code hl_variable" href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html#ae6f43f8059c6ce02d35b446b9bc2aff0">InterceptionProcessIds</a>[0],</div>
<div class="line"><span class="lineno">  857</span>                                           <a class="code hl_variable" href="_global_variables_8h.html#a4975a1a51415ed672c7099dda529e37d">g_ExecTrapState</a>.<a class="code hl_variable" href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html#a796bcde497482ba02bf633a74570a0c4">NumberOfItems</a>,</div>
<div class="line"><span class="lineno">  858</span>                                           &amp;Index,</div>
<div class="line"><span class="lineno">  859</span>                                           (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)PsGetCurrentProcessId());</div>
<div class="line"><span class="lineno">  860</span> </div>
<div class="line"><span class="lineno">  861</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  862</span>    <span class="comment">// Check whether the procerss is in the list of interceptions or not</span></div>
<div class="line"><span class="lineno">  863</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  864</span>    <span class="keywordflow">if</span> (Result)</div>
<div class="line"><span class="lineno">  865</span>    {</div>
<div class="line"><span class="lineno">  866</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  867</span>        <span class="comment">// Enable MBEC to detect execution in user-mode</span></div>
<div class="line"><span class="lineno">  868</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  869</span>        <a class="code hl_function" href="_hv_8c.html#ab5ed1560d0c5fa592a40b0b75d8e1022">HvSetModeBasedExecutionEnableFlag</a>(<a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div>
<div class="line"><span class="lineno">  870</span>        VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a672ada3cf809bfdc4f1af22f30fb400b">MbecEnabled</a> = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  871</span> </div>
<div class="line"><span class="lineno">  872</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  873</span>        <span class="comment">// Trigger the event</span></div>
<div class="line"><span class="lineno">  874</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  875</span>        <a class="code hl_function" href="_dispatch_8c.html#ab42e4975ea7a08129dc29a40c011017c">DispatchEventMode</a>(VCpu, <a class="code hl_enumvalue" href="include_2_s_d_k_2_headers_2_events_8h.html#a6407fccecdb97d407d19d0fc68a599a6a4a5bc1a897e016d811069c5d59a4a185">DEBUGGER_EVENT_MODE_TYPE_KERNEL_MODE</a>, <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div>
<div class="line"><span class="lineno">  876</span>    }</div>
<div class="line"><span class="lineno">  877</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a672ada3cf809bfdc4f1af22f30fb400b">MbecEnabled</a>)</div>
<div class="line"><span class="lineno">  878</span>    {</div>
<div class="line"><span class="lineno">  879</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  880</span>        <span class="comment">// In case, the process is changed, we&#39;ve disable the MBEC</span></div>
<div class="line"><span class="lineno">  881</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  882</span>        <a class="code hl_function" href="_hv_8c.html#ab5ed1560d0c5fa592a40b0b75d8e1022">HvSetModeBasedExecutionEnableFlag</a>(<a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div>
<div class="line"><span class="lineno">  883</span>        VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a672ada3cf809bfdc4f1af22f30fb400b">MbecEnabled</a> = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  884</span>    }</div>
<div class="line"><span class="lineno">  885</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_a1cb18096b299d23458d3c7b85fd86555"><div class="ttname"><a href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div><div class="ttdeci">UCHAR BOOLEAN</div><div class="ttdef"><b>Definition</b> BasicTypes.h:39</div></div>
<div class="ttc" id="a_basic_types_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdef"><b>Definition</b> BasicTypes.h:54</div></div>
<div class="ttc" id="a_basic_types_8h_html_ae1e6edbbc26d6fbc71a90190d0266018"><div class="ttname"><a href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></div><div class="ttdeci">unsigned int UINT32</div><div class="ttdef"><b>Definition</b> BasicTypes.h:48</div></div>
<div class="ttc" id="a_binary_search_8c_html_ac1532f925279158a47a45e688224fb72"><div class="ttname"><a href="_binary_search_8c.html#ac1532f925279158a47a45e688224fb72">BinarySearchPerformSearchItem</a></div><div class="ttdeci">BOOLEAN BinarySearchPerformSearchItem(UINT64 ArrayPtr[], UINT32 NumberOfItems, UINT32 *ResultIndex, UINT64 Key)</div><div class="ttdoc">A utility function to perform the binary search.</div><div class="ttdef"><b>Definition</b> BinarySearch.c:46</div></div>
<div class="ttc" id="a_dispatch_8c_html_ab42e4975ea7a08129dc29a40c011017c"><div class="ttname"><a href="_dispatch_8c.html#ab42e4975ea7a08129dc29a40c011017c">DispatchEventMode</a></div><div class="ttdeci">VOID DispatchEventMode(VIRTUAL_MACHINE_STATE *VCpu, DEBUGGER_EVENT_MODE_TYPE TargetMode, BOOLEAN HandleState)</div><div class="ttdoc">Handling debugger functions related to user-mode/kernel-mode execution trap events.</div><div class="ttdef"><b>Definition</b> Dispatch.c:312</div></div>
<div class="ttc" id="a_hv_8c_html_ab5ed1560d0c5fa592a40b0b75d8e1022"><div class="ttname"><a href="_hv_8c.html#ab5ed1560d0c5fa592a40b0b75d8e1022">HvSetModeBasedExecutionEnableFlag</a></div><div class="ttdeci">VOID HvSetModeBasedExecutionEnableFlag(BOOLEAN Set)</div><div class="ttdoc">Set Mode-based Execution Control (MBEC) Enable bit.</div><div class="ttdef"><b>Definition</b> Hv.c:677</div></div>
<div class="ttc" id="ainclude_2_s_d_k_2_headers_2_events_8h_html_a6407fccecdb97d407d19d0fc68a599a6a4a5bc1a897e016d811069c5d59a4a185"><div class="ttname"><a href="include_2_s_d_k_2_headers_2_events_8h.html#a6407fccecdb97d407d19d0fc68a599a6a4a5bc1a897e016d811069c5d59a4a185">DEBUGGER_EVENT_MODE_TYPE_KERNEL_MODE</a></div><div class="ttdeci">@ DEBUGGER_EVENT_MODE_TYPE_KERNEL_MODE</div><div class="ttdef"><b>Definition</b> Events.h:207</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a672ada3cf809bfdc4f1af22f30fb400b"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a672ada3cf809bfdc4f1af22f30fb400b">_VIRTUAL_MACHINE_STATE::MbecEnabled</a></div><div class="ttdeci">BOOLEAN MbecEnabled</div><div class="ttdef"><b>Definition</b> State.h:301</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="af633002780953873a81572f3cd9073a3" name="af633002780953873a81572f3cd9073a3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af633002780953873a81572f3cd9073a3">&#9670;&#160;</a></span>ExecTrapHandleEptViolationVmexit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ExecTrapHandleEptViolationVmexit </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">VMX_EXIT_QUALIFICATION_EPT_VIOLATION *</td>          <td class="paramname"><span class="paramname"><em>ViolationQualification</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Handle EPT Violations related to the MBEC hooks. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">ViolationQualification</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  781</span>{</div>
<div class="line"><span class="lineno">  782</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  783</span>    <span class="comment">// Check if this mechanism is use or not</span></div>
<div class="line"><span class="lineno">  784</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  785</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="_global_variables_8h.html#afa6581e952ff0d7e78a6ff312ed942bd">g_ExecTrapInitialized</a>)</div>
<div class="line"><span class="lineno">  786</span>    {</div>
<div class="line"><span class="lineno">  787</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  788</span>    }</div>
<div class="line"><span class="lineno">  789</span> </div>
<div class="line"><span class="lineno">  790</span>    <span class="keywordflow">if</span> (!ViolationQualification-&gt;EptExecutableForUserMode &amp;&amp; ViolationQualification-&gt;ExecuteAccess)</div>
<div class="line"><span class="lineno">  791</span>    {</div>
<div class="line"><span class="lineno">  792</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  793</span>        <span class="comment">// For test purposes</span></div>
<div class="line"><span class="lineno">  794</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  795</span>        <span class="comment">// LogInfo(&quot;Reached to the user-mode of the process (0x%x) is executed address: %llx&quot;, PsGetCurrentProcessId(), VCpu-&gt;LastVmexitRip);</span></div>
<div class="line"><span class="lineno">  796</span> </div>
<div class="line"><span class="lineno">  797</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  798</span>        <span class="comment">// Suppress the RIP increment</span></div>
<div class="line"><span class="lineno">  799</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  800</span>        <a class="code hl_function" href="_hv_8c.html#a384185281b4d93ce4a401d66848d9049">HvSuppressRipIncrement</a>(VCpu);</div>
<div class="line"><span class="lineno">  801</span> </div>
<div class="line"><span class="lineno">  802</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  803</span>        <span class="comment">// Trigger the event</span></div>
<div class="line"><span class="lineno">  804</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  805</span>        <a class="code hl_function" href="_dispatch_8c.html#ab42e4975ea7a08129dc29a40c011017c">DispatchEventMode</a>(VCpu, <a class="code hl_enumvalue" href="include_2_s_d_k_2_headers_2_events_8h.html#a6407fccecdb97d407d19d0fc68a599a6ae33494f799de36316a0f45a07c99fab5">DEBUGGER_EVENT_MODE_TYPE_USER_MODE</a>, <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div>
<div class="line"><span class="lineno">  806</span> </div>
<div class="line"><span class="lineno">  807</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  808</span>    }</div>
<div class="line"><span class="lineno">  809</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ViolationQualification-&gt;EptExecutable &amp;&amp; ViolationQualification-&gt;ExecuteAccess)</div>
<div class="line"><span class="lineno">  810</span>    {</div>
<div class="line"><span class="lineno">  811</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  812</span>        <span class="comment">// For test purposes</span></div>
<div class="line"><span class="lineno">  813</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  814</span>        <span class="comment">// LogInfo(&quot;Reached to the kernel-mode of the process (0x%x) is executed address: %llx&quot;, PsGetCurrentProcessId(), VCpu-&gt;LastVmexitRip);</span></div>
<div class="line"><span class="lineno">  815</span> </div>
<div class="line"><span class="lineno">  816</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  817</span>        <span class="comment">// Suppress the RIP increment</span></div>
<div class="line"><span class="lineno">  818</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  819</span>        <a class="code hl_function" href="_hv_8c.html#a384185281b4d93ce4a401d66848d9049">HvSuppressRipIncrement</a>(VCpu);</div>
<div class="line"><span class="lineno">  820</span> </div>
<div class="line"><span class="lineno">  821</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  822</span>        <span class="comment">// Trigger the event</span></div>
<div class="line"><span class="lineno">  823</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  824</span>        <a class="code hl_function" href="_dispatch_8c.html#ab42e4975ea7a08129dc29a40c011017c">DispatchEventMode</a>(VCpu, <a class="code hl_enumvalue" href="include_2_s_d_k_2_headers_2_events_8h.html#a6407fccecdb97d407d19d0fc68a599a6a4a5bc1a897e016d811069c5d59a4a185">DEBUGGER_EVENT_MODE_TYPE_KERNEL_MODE</a>, <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div>
<div class="line"><span class="lineno">  825</span>    }</div>
<div class="line"><span class="lineno">  826</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  827</span>    {</div>
<div class="line"><span class="lineno">  828</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  829</span>        <span class="comment">// Unexpected violation</span></div>
<div class="line"><span class="lineno">  830</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  831</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  832</span>    }</div>
<div class="line"><span class="lineno">  833</span> </div>
<div class="line"><span class="lineno">  834</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  835</span>    <span class="comment">// It successfully handled by MBEC hooks</span></div>
<div class="line"><span class="lineno">  836</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  837</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  838</span>}</div>
<div class="ttc" id="a_global_variables_8h_html_afa6581e952ff0d7e78a6ff312ed942bd"><div class="ttname"><a href="_global_variables_8h.html#afa6581e952ff0d7e78a6ff312ed942bd">g_ExecTrapInitialized</a></div><div class="ttdeci">BOOLEAN g_ExecTrapInitialized</div><div class="ttdoc">Showes whether the execution trap handler is allowed to trigger an event or not.</div><div class="ttdef"><b>Definition</b> GlobalVariables.h:149</div></div>
<div class="ttc" id="a_hv_8c_html_a384185281b4d93ce4a401d66848d9049"><div class="ttname"><a href="_hv_8c.html#a384185281b4d93ce4a401d66848d9049">HvSuppressRipIncrement</a></div><div class="ttdeci">VOID HvSuppressRipIncrement(VIRTUAL_MACHINE_STATE *VCpu)</div><div class="ttdoc">Suppress the incrementation of RIP.</div><div class="ttdef"><b>Definition</b> Hv.c:324</div></div>
<div class="ttc" id="ainclude_2_s_d_k_2_headers_2_events_8h_html_a6407fccecdb97d407d19d0fc68a599a6ae33494f799de36316a0f45a07c99fab5"><div class="ttname"><a href="include_2_s_d_k_2_headers_2_events_8h.html#a6407fccecdb97d407d19d0fc68a599a6ae33494f799de36316a0f45a07c99fab5">DEBUGGER_EVENT_MODE_TYPE_USER_MODE</a></div><div class="ttdeci">@ DEBUGGER_EVENT_MODE_TYPE_USER_MODE</div><div class="ttdef"><b>Definition</b> Events.h:206</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="af65579bb774da528e4cbb0804a1d1c2d" name="af65579bb774da528e4cbb0804a1d1c2d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af65579bb774da528e4cbb0804a1d1c2d">&#9670;&#160;</a></span>ExecTrapHandleMoveToAdjustedTrapState()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> ExecTrapHandleMoveToAdjustedTrapState </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="include_2_s_d_k_2_headers_2_events_8h.html#aae7e83f1666860f94b796560cdf1d308">DEBUGGER_EVENT_MODE_TYPE</a></td>          <td class="paramname"><span class="paramname"><em>TargetMode</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Restore the execution of the trap to adjusted trap state. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">IsUserMode</td><td>Whether the execution event caused by a switch from kernel-to-user or otherwise user-to-kernel</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  754</span>{</div>
<div class="line"><span class="lineno">  755</span>    <span class="keywordflow">if</span> (TargetMode == <a class="code hl_enumvalue" href="include_2_s_d_k_2_headers_2_events_8h.html#a6407fccecdb97d407d19d0fc68a599a6ae33494f799de36316a0f45a07c99fab5">DEBUGGER_EVENT_MODE_TYPE_USER_MODE</a>)</div>
<div class="line"><span class="lineno">  756</span>    {</div>
<div class="line"><span class="lineno">  757</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  758</span>        <span class="comment">// Change EPT to kernel disabled</span></div>
<div class="line"><span class="lineno">  759</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  760</span>        <a class="code hl_function" href="_exec_trap_8c.html#a8677e09ccac4d79be30150d8e4e97f3f">ExecTrapChangeToKernelDisabledMbecEptp</a>(VCpu);</div>
<div class="line"><span class="lineno">  761</span>    }</div>
<div class="line"><span class="lineno">  762</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TargetMode == <a class="code hl_enumvalue" href="include_2_s_d_k_2_headers_2_events_8h.html#a6407fccecdb97d407d19d0fc68a599a6a4a5bc1a897e016d811069c5d59a4a185">DEBUGGER_EVENT_MODE_TYPE_KERNEL_MODE</a>)</div>
<div class="line"><span class="lineno">  763</span>    {</div>
<div class="line"><span class="lineno">  764</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  765</span>        <span class="comment">// Change EPT to user disabled</span></div>
<div class="line"><span class="lineno">  766</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  767</span>        <a class="code hl_function" href="_exec_trap_8c.html#aab11493ed60e326089cdeb660835bbbc">ExecTrapChangeToUserDisabledMbecEptp</a>(VCpu);</div>
<div class="line"><span class="lineno">  768</span>    }</div>
<div class="line"><span class="lineno">  769</span>}</div>
<div class="ttc" id="a_exec_trap_8c_html_a8677e09ccac4d79be30150d8e4e97f3f"><div class="ttname"><a href="_exec_trap_8c.html#a8677e09ccac4d79be30150d8e4e97f3f">ExecTrapChangeToKernelDisabledMbecEptp</a></div><div class="ttdeci">VOID ExecTrapChangeToKernelDisabledMbecEptp(VIRTUAL_MACHINE_STATE *VCpu)</div><div class="ttdoc">change to kernel-disabled MBEC EPTP</div><div class="ttdef"><b>Definition</b> ExecTrap.c:731</div></div>
<div class="ttc" id="a_exec_trap_8c_html_aab11493ed60e326089cdeb660835bbbc"><div class="ttname"><a href="_exec_trap_8c.html#aab11493ed60e326089cdeb660835bbbc">ExecTrapChangeToUserDisabledMbecEptp</a></div><div class="ttdeci">VOID ExecTrapChangeToUserDisabledMbecEptp(VIRTUAL_MACHINE_STATE *VCpu)</div><div class="ttdoc">change to user-disabled MBEC EPTP</div><div class="ttdef"><b>Definition</b> ExecTrap.c:711</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="add9956ac777904d17c0263f2bea40d4d" name="add9956ac777904d17c0263f2bea40d4d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#add9956ac777904d17c0263f2bea40d4d">&#9670;&#160;</a></span>ExecTrapInitialize()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ExecTrapInitialize </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize the reversing machine based on service request. </p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  498</span>{</div>
<div class="line"><span class="lineno">  499</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  500</span>    <span class="comment">// Check if the reversing machine is already initialized</span></div>
<div class="line"><span class="lineno">  501</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  502</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="_global_variables_8h.html#afa6581e952ff0d7e78a6ff312ed942bd">g_ExecTrapInitialized</a>)</div>
<div class="line"><span class="lineno">  503</span>    {</div>
<div class="line"><span class="lineno">  504</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  505</span>        <span class="comment">// Already initialized</span></div>
<div class="line"><span class="lineno">  506</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  507</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  508</span>    }</div>
<div class="line"><span class="lineno">  509</span> </div>
<div class="line"><span class="lineno">  510</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  511</span>    <span class="comment">// Check if MBEC supported by this processors</span></div>
<div class="line"><span class="lineno">  512</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  513</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="_global_variables_8h.html#a3c92f787270f29f40a4fb1b3440a3baa">g_CompatibilityCheck</a>.<a class="code hl_variable" href="struct___c_o_m_p_a_t_i_b_i_l_i_t_y___c_h_e_c_k_s___s_t_a_t_u_s.html#a3a377db9e59b8f90f23e5efddbfb1f04">ModeBasedExecutionSupport</a>)</div>
<div class="line"><span class="lineno">  514</span>    {</div>
<div class="line"><span class="lineno">  515</span>        <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a>(<span class="stringliteral">&quot;Your processor doesn&#39;t support Mode-Based Execution Controls (MBEC), which is a needed feature for this functionality :(\n&quot;</span></div>
<div class="line"><span class="lineno">  516</span>                <span class="stringliteral">&quot;MBEC is available on processors starting from the 7th generation (Kaby Lake) and onwards&quot;</span>);</div>
<div class="line"><span class="lineno">  517</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  518</span>    }</div>
<div class="line"><span class="lineno">  519</span> </div>
<div class="line"><span class="lineno">  520</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  521</span>    <span class="comment">// Read the RAM regions</span></div>
<div class="line"><span class="lineno">  522</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  523</span>    <a class="code hl_function" href="_exec_trap_8c.html#a0571b6d68997e7b97ef207a03a36b4db">ExecTrapReadRamPhysicalRegions</a>();</div>
<div class="line"><span class="lineno">  524</span> </div>
<div class="line"><span class="lineno">  525</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  526</span>    <span class="comment">// Allocate MBEC EPT page-table (user-disabled)</span></div>
<div class="line"><span class="lineno">  527</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  528</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_exec_trap_8c.html#a1858986163fff7e8c4c03acf356333dd">ExecTrapAllocateUserDisabledMbecEptPageTable</a>())</div>
<div class="line"><span class="lineno">  529</span>    {</div>
<div class="line"><span class="lineno">  530</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  531</span>        <span class="comment">// There was an error allocating MBEC page table for EPT tables</span></div>
<div class="line"><span class="lineno">  532</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  533</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  534</span>    }</div>
<div class="line"><span class="lineno">  535</span> </div>
<div class="line"><span class="lineno">  536</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  537</span>    <span class="comment">// Allocate MBEC EPT page-table (kernel-disabled)</span></div>
<div class="line"><span class="lineno">  538</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  539</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_exec_trap_8c.html#ac13c7109ba4912afaa20b0863c9f1aff">ExecTrapAllocateKernelDisabledMbecEptPageTable</a>())</div>
<div class="line"><span class="lineno">  540</span>    {</div>
<div class="line"><span class="lineno">  541</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  542</span>        <span class="comment">// Free the user-disabled page-table buffer</span></div>
<div class="line"><span class="lineno">  543</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  544</span>        MmFreeContiguousMemory(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a687493817a152a6b58587f6ac0d966aa">ModeBasedUserDisabledEptPageTable</a>);</div>
<div class="line"><span class="lineno">  545</span>        <a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a687493817a152a6b58587f6ac0d966aa">ModeBasedUserDisabledEptPageTable</a> = <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno">  546</span> </div>
<div class="line"><span class="lineno">  547</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  548</span>        <span class="comment">// There was an error allocating MBEC page table for EPT tables</span></div>
<div class="line"><span class="lineno">  549</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  550</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  551</span>    }</div>
<div class="line"><span class="lineno">  552</span> </div>
<div class="line"><span class="lineno">  553</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  554</span>    <span class="comment">// Call the function responsible for initializing Mode-based hooks</span></div>
<div class="line"><span class="lineno">  555</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  556</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_mode_based_exec_hook_8c.html#acdd2b35b31c0fd7bd59b60533b63623f">ModeBasedExecHookInitialize</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno">  557</span>    {</div>
<div class="line"><span class="lineno">  558</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  559</span>        <span class="comment">// Free the user-disabled page-table buffer</span></div>
<div class="line"><span class="lineno">  560</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  561</span>        MmFreeContiguousMemory(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a687493817a152a6b58587f6ac0d966aa">ModeBasedUserDisabledEptPageTable</a>);</div>
<div class="line"><span class="lineno">  562</span>        <a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a687493817a152a6b58587f6ac0d966aa">ModeBasedUserDisabledEptPageTable</a> = <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno">  563</span> </div>
<div class="line"><span class="lineno">  564</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  565</span>        <span class="comment">// Free the kernel-disabled page-table buffer</span></div>
<div class="line"><span class="lineno">  566</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  567</span>        MmFreeContiguousMemory(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a1489f161b42ab410a8a7c1e9dcdcea99">ModeBasedKernelDisabledEptPageTable</a>);</div>
<div class="line"><span class="lineno">  568</span>        <a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a1489f161b42ab410a8a7c1e9dcdcea99">ModeBasedKernelDisabledEptPageTable</a> = <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno">  569</span> </div>
<div class="line"><span class="lineno">  570</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  571</span>        <span class="comment">// The initialization was not successful</span></div>
<div class="line"><span class="lineno">  572</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  573</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  574</span>    }</div>
<div class="line"><span class="lineno">  575</span> </div>
<div class="line"><span class="lineno">  576</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  577</span>    <span class="comment">// Change EPT on all core&#39;s to a MBEC supported EPTP</span></div>
<div class="line"><span class="lineno">  578</span>    <span class="comment">// (No longer needed as the starting phase of the process uses EPT hooks)</span></div>
<div class="line"><span class="lineno">  579</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  580</span>    <a class="code hl_function" href="_broadcast_8c.html#a01df1ea5ca8b282ccbcadae40132fb69">BroadcastChangeToMbecSupportedEptpOnAllProcessors</a>();</div>
<div class="line"><span class="lineno">  581</span> </div>
<div class="line"><span class="lineno">  582</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  583</span>    <span class="comment">// Indicate that the reversing machine is initialized</span></div>
<div class="line"><span class="lineno">  584</span>    <span class="comment">// It should be initialized here BEFORE broadcasting mov 2 cr3 exiting</span></div>
<div class="line"><span class="lineno">  585</span>    <span class="comment">// because an EPT violation might be thrown before we enabled it from</span></div>
<div class="line"><span class="lineno">  586</span>    <span class="comment">// here</span></div>
<div class="line"><span class="lineno">  587</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  588</span>    <a class="code hl_variable" href="_global_variables_8h.html#afa6581e952ff0d7e78a6ff312ed942bd">g_ExecTrapInitialized</a> = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  589</span> </div>
<div class="line"><span class="lineno">  590</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  591</span>    <span class="comment">// Enable Mode-based execution control by broadcasting MOV to CR3 exiting</span></div>
<div class="line"><span class="lineno">  592</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  593</span>    <a class="code hl_function" href="_broadcast_8c.html#ad399387aeaaae4be8180107318d1ed62">BroadcastEnableMovToCr3ExitingOnAllProcessors</a>();</div>
<div class="line"><span class="lineno">  594</span> </div>
<div class="line"><span class="lineno">  595</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  596</span>}</div>
<div class="ttc" id="a_broadcast_8c_html_a01df1ea5ca8b282ccbcadae40132fb69"><div class="ttname"><a href="_broadcast_8c.html#a01df1ea5ca8b282ccbcadae40132fb69">BroadcastChangeToMbecSupportedEptpOnAllProcessors</a></div><div class="ttdeci">VOID BroadcastChangeToMbecSupportedEptpOnAllProcessors()</div><div class="ttdoc">routines for changing EPTP to an MBEC supported EPTP</div><div class="ttdef"><b>Definition</b> Broadcast.c:447</div></div>
<div class="ttc" id="a_broadcast_8c_html_ad399387aeaaae4be8180107318d1ed62"><div class="ttname"><a href="_broadcast_8c.html#ad399387aeaaae4be8180107318d1ed62">BroadcastEnableMovToCr3ExitingOnAllProcessors</a></div><div class="ttdeci">VOID BroadcastEnableMovToCr3ExitingOnAllProcessors()</div><div class="ttdoc">routines for debugging threads (enable mov-to-cr3 exiting)</div><div class="ttdef"><b>Definition</b> Broadcast.c:436</div></div>
<div class="ttc" id="a_exec_trap_8c_html_a0571b6d68997e7b97ef207a03a36b4db"><div class="ttname"><a href="_exec_trap_8c.html#a0571b6d68997e7b97ef207a03a36b4db">ExecTrapReadRamPhysicalRegions</a></div><div class="ttdeci">VOID ExecTrapReadRamPhysicalRegions()</div><div class="ttdoc">Read the RAM regions (physical address)</div><div class="ttdef"><b>Definition</b> ExecTrap.c:459</div></div>
<div class="ttc" id="a_exec_trap_8c_html_a1858986163fff7e8c4c03acf356333dd"><div class="ttname"><a href="_exec_trap_8c.html#a1858986163fff7e8c4c03acf356333dd">ExecTrapAllocateUserDisabledMbecEptPageTable</a></div><div class="ttdeci">BOOLEAN ExecTrapAllocateUserDisabledMbecEptPageTable()</div><div class="ttdoc">Initialize the needed structure for hooking user-mode execution.</div><div class="ttdef"><b>Definition</b> ExecTrap.c:255</div></div>
<div class="ttc" id="a_exec_trap_8c_html_ac13c7109ba4912afaa20b0863c9f1aff"><div class="ttname"><a href="_exec_trap_8c.html#ac13c7109ba4912afaa20b0863c9f1aff">ExecTrapAllocateKernelDisabledMbecEptPageTable</a></div><div class="ttdeci">BOOLEAN ExecTrapAllocateKernelDisabledMbecEptPageTable()</div><div class="ttdoc">Initialize the needed structure for hooking kernel-mode execution.</div><div class="ttdef"><b>Definition</b> ExecTrap.c:319</div></div>
<div class="ttc" id="a_global_variables_8h_html_a3c92f787270f29f40a4fb1b3440a3baa"><div class="ttname"><a href="_global_variables_8h.html#a3c92f787270f29f40a4fb1b3440a3baa">g_CompatibilityCheck</a></div><div class="ttdeci">COMPATIBILITY_CHECKS_STATUS g_CompatibilityCheck</div><div class="ttdoc">Different attributes and compatibility checks of the current processor.</div><div class="ttdef"><b>Definition</b> GlobalVariables.h:26</div></div>
<div class="ttc" id="a_hyper_dbg_hyper_log_intrinsics_8h_html_a97b0adbd65790fb90734daa8e5245a04"><div class="ttname"><a href="_hyper_dbg_hyper_log_intrinsics_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a></div><div class="ttdeci">#define LogInfo(format,...)</div><div class="ttdoc">Define log variables.</div><div class="ttdef"><b>Definition</b> HyperDbgHyperLogIntrinsics.h:71</div></div>
<div class="ttc" id="a_mode_based_exec_hook_8c_html_acdd2b35b31c0fd7bd59b60533b63623f"><div class="ttname"><a href="_mode_based_exec_hook_8c.html#acdd2b35b31c0fd7bd59b60533b63623f">ModeBasedExecHookInitialize</a></div><div class="ttdeci">BOOLEAN ModeBasedExecHookInitialize()</div><div class="ttdoc">Initialize the needed structure for hooking mode execution.</div><div class="ttdef"><b>Definition</b> ModeBasedExecHook.c:185</div></div>
<div class="ttc" id="anamespacetest-case-generator_html_a9a4eff80432bb93d2796381610dd86c3"><div class="ttname"><a href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">test-case-generator.NULL</a></div><div class="ttdeci">NULL()</div><div class="ttdef"><b>Definition</b> test-case-generator.py:530</div></div>
<div class="ttc" id="astruct___c_o_m_p_a_t_i_b_i_l_i_t_y___c_h_e_c_k_s___s_t_a_t_u_s_html_a3a377db9e59b8f90f23e5efddbfb1f04"><div class="ttname"><a href="struct___c_o_m_p_a_t_i_b_i_l_i_t_y___c_h_e_c_k_s___s_t_a_t_u_s.html#a3a377db9e59b8f90f23e5efddbfb1f04">_COMPATIBILITY_CHECKS_STATUS::ModeBasedExecutionSupport</a></div><div class="ttdeci">BOOLEAN ModeBasedExecutionSupport</div><div class="ttdef"><b>Definition</b> CompatibilityChecks.h:28</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a1489f161b42ab410a8a7c1e9dcdcea99"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a1489f161b42ab410a8a7c1e9dcdcea99">_EPT_STATE::ModeBasedKernelDisabledEptPageTable</a></div><div class="ttdeci">PVMM_EPT_PAGE_TABLE ModeBasedKernelDisabledEptPageTable</div><div class="ttdef"><b>Definition</b> Ept.h:123</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a687493817a152a6b58587f6ac0d966aa"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a687493817a152a6b58587f6ac0d966aa">_EPT_STATE::ModeBasedUserDisabledEptPageTable</a></div><div class="ttdeci">PVMM_EPT_PAGE_TABLE ModeBasedUserDisabledEptPageTable</div><div class="ttdef"><b>Definition</b> Ept.h:122</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="aa7ef8278f2f66d2ff1c9b28c85ecae16" name="aa7ef8278f2f66d2ff1c9b28c85ecae16"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa7ef8278f2f66d2ff1c9b28c85ecae16">&#9670;&#160;</a></span>ExecTrapRemoveProcessFromWatchingList()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ExecTrapRemoveProcessFromWatchingList </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>ProcessId</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove the target process from the watching list. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ProcessId</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  910</span>{</div>
<div class="line"><span class="lineno">  911</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="_insertion_sort_8c.html#a7132f7eebd8c326f710aa5ac6273d2d6">InsertionSortDeleteItem</a>(&amp;<a class="code hl_variable" href="_global_variables_8h.html#a4975a1a51415ed672c7099dda529e37d">g_ExecTrapState</a>.<a class="code hl_variable" href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html#ae6f43f8059c6ce02d35b446b9bc2aff0">InterceptionProcessIds</a>[0],</div>
<div class="line"><span class="lineno">  912</span>                                   &amp;<a class="code hl_variable" href="_global_variables_8h.html#a4975a1a51415ed672c7099dda529e37d">g_ExecTrapState</a>.<a class="code hl_variable" href="struct___u_s_e_r___k_e_r_n_e_l___e_x_e_c_u_t_i_o_n___t_r_a_p___s_t_a_t_e.html#a796bcde497482ba02bf633a74570a0c4">NumberOfItems</a>,</div>
<div class="line"><span class="lineno">  913</span>                                   (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)ProcessId);</div>
<div class="line"><span class="lineno">  914</span>}</div>
<div class="ttc" id="a_insertion_sort_8c_html_a7132f7eebd8c326f710aa5ac6273d2d6"><div class="ttname"><a href="_insertion_sort_8c.html#a7132f7eebd8c326f710aa5ac6273d2d6">InsertionSortDeleteItem</a></div><div class="ttdeci">BOOLEAN InsertionSortDeleteItem(UINT64 ArrayPtr[], UINT32 *NumberOfItems, UINT32 Index)</div><div class="ttdoc">Function to implement insertion sort.</div><div class="ttdef"><b>Definition</b> InsertionSort.c:66</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a22855316678446d7d33cda0836a1ee70" name="a22855316678446d7d33cda0836a1ee70"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a22855316678446d7d33cda0836a1ee70">&#9670;&#160;</a></span>ExecTrapRestoreToNormalEptp()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> ExecTrapRestoreToNormalEptp </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>restore to normal EPTP </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  672</span>{</div>
<div class="line"><span class="lineno">  673</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  674</span>    <span class="comment">// Change EPTP</span></div>
<div class="line"><span class="lineno">  675</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  676</span>    __vmx_vmwrite(VMCS_CTRL_EPT_POINTER, VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a4c5c6fd61c83853d21e270e87cdea179">EptPointer</a>.AsUInt);</div>
<div class="line"><span class="lineno">  677</span> </div>
<div class="line"><span class="lineno">  678</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  679</span>    <span class="comment">// It&#39;s on normal EPTP</span></div>
<div class="line"><span class="lineno">  680</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  681</span>    VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a266cabea79370927f063b9bf1041ced3">NotNormalEptp</a> = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  682</span>}</div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a4c5c6fd61c83853d21e270e87cdea179"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a4c5c6fd61c83853d21e270e87cdea179">_VIRTUAL_MACHINE_STATE::EptPointer</a></div><div class="ttdeci">EPT_POINTER EptPointer</div><div class="ttdef"><b>Definition</b> State.h:341</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="af6305fef8652aa0c6b3035abe039078d" name="af6305fef8652aa0c6b3035abe039078d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af6305fef8652aa0c6b3035abe039078d">&#9670;&#160;</a></span>ExecTrapUninitialize()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> ExecTrapUninitialize </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Uinitialize the needed structure for the reversing machine. </p>
<p>should be called from vmx non-root mode</p>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  606</span>{</div>
<div class="line"><span class="lineno">  607</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  608</span>    <span class="comment">// Check if it&#39;s already initialized</span></div>
<div class="line"><span class="lineno">  609</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  610</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="_global_variables_8h.html#afa6581e952ff0d7e78a6ff312ed942bd">g_ExecTrapInitialized</a>)</div>
<div class="line"><span class="lineno">  611</span>    {</div>
<div class="line"><span class="lineno">  612</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  613</span>    }</div>
<div class="line"><span class="lineno">  614</span> </div>
<div class="line"><span class="lineno">  615</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  616</span>    <span class="comment">// Indicate that the uninitialization phase started</span></div>
<div class="line"><span class="lineno">  617</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  618</span>    <a class="code hl_variable" href="_global_variables_8h.html#a0a4399a3814cd63654f47ac6f4f5ad02">g_ExecTrapUnInitializationStarted</a> = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  619</span> </div>
<div class="line"><span class="lineno">  620</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  621</span>    <span class="comment">// Disable MOV to CR3 exiting</span></div>
<div class="line"><span class="lineno">  622</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  623</span>    <a class="code hl_function" href="_broadcast_8c.html#afbdc3a135b42022a6041d1c69c1b18f3">BroadcastDisableMovToCr3ExitingOnAllProcessors</a>();</div>
<div class="line"><span class="lineno">  624</span> </div>
<div class="line"><span class="lineno">  625</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  626</span>    <span class="comment">// Restore to normal EPTP</span></div>
<div class="line"><span class="lineno">  627</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  628</span>    <a class="code hl_function" href="_broadcast_8c.html#a95a301a59c6a3b2fe4e6d87f9c02a39a">BroadcastRestoreToNormalEptpOnAllProcessors</a>();</div>
<div class="line"><span class="lineno">  629</span> </div>
<div class="line"><span class="lineno">  630</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  631</span>    <span class="comment">// Uninitialize the mode-based execution controls</span></div>
<div class="line"><span class="lineno">  632</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  633</span>    <a class="code hl_function" href="_mode_based_exec_hook_8c.html#a17a8e377b4679423f8c80f9dab0f113a">ModeBasedExecHookUninitialize</a>();</div>
<div class="line"><span class="lineno">  634</span> </div>
<div class="line"><span class="lineno">  635</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  636</span>    <span class="comment">// Indicate that the execution traps are disabled</span></div>
<div class="line"><span class="lineno">  637</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  638</span>    <a class="code hl_variable" href="_global_variables_8h.html#afa6581e952ff0d7e78a6ff312ed942bd">g_ExecTrapInitialized</a> = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  639</span> </div>
<div class="line"><span class="lineno">  640</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  641</span>    <span class="comment">// Indicate that the uninitialization phase finished</span></div>
<div class="line"><span class="lineno">  642</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  643</span>    <a class="code hl_variable" href="_global_variables_8h.html#a0a4399a3814cd63654f47ac6f4f5ad02">g_ExecTrapUnInitializationStarted</a> = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  644</span> </div>
<div class="line"><span class="lineno">  645</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  646</span>    <span class="comment">// Free Identity Page Table for MBEC hooks (user-disabled)</span></div>
<div class="line"><span class="lineno">  647</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  648</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a687493817a152a6b58587f6ac0d966aa">ModeBasedUserDisabledEptPageTable</a> != NULL)</div>
<div class="line"><span class="lineno">  649</span>    {</div>
<div class="line"><span class="lineno">  650</span>        MmFreeContiguousMemory(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a687493817a152a6b58587f6ac0d966aa">ModeBasedUserDisabledEptPageTable</a>);</div>
<div class="line"><span class="lineno">  651</span>        <a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a687493817a152a6b58587f6ac0d966aa">ModeBasedUserDisabledEptPageTable</a> = <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno">  652</span>    }</div>
<div class="line"><span class="lineno">  653</span> </div>
<div class="line"><span class="lineno">  654</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  655</span>    <span class="comment">// Free Identity Page Table for MBEC hooks (kernel-disabled)</span></div>
<div class="line"><span class="lineno">  656</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  657</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a1489f161b42ab410a8a7c1e9dcdcea99">ModeBasedKernelDisabledEptPageTable</a> != NULL)</div>
<div class="line"><span class="lineno">  658</span>    {</div>
<div class="line"><span class="lineno">  659</span>        MmFreeContiguousMemory(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a1489f161b42ab410a8a7c1e9dcdcea99">ModeBasedKernelDisabledEptPageTable</a>);</div>
<div class="line"><span class="lineno">  660</span>        <a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a1489f161b42ab410a8a7c1e9dcdcea99">ModeBasedKernelDisabledEptPageTable</a> = <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno">  661</span>    }</div>
<div class="line"><span class="lineno">  662</span>}</div>
<div class="ttc" id="a_broadcast_8c_html_a95a301a59c6a3b2fe4e6d87f9c02a39a"><div class="ttname"><a href="_broadcast_8c.html#a95a301a59c6a3b2fe4e6d87f9c02a39a">BroadcastRestoreToNormalEptpOnAllProcessors</a></div><div class="ttdeci">VOID BroadcastRestoreToNormalEptpOnAllProcessors()</div><div class="ttdoc">routines for restoring EPTP to normal EPTP</div><div class="ttdef"><b>Definition</b> Broadcast.c:458</div></div>
<div class="ttc" id="a_broadcast_8c_html_afbdc3a135b42022a6041d1c69c1b18f3"><div class="ttname"><a href="_broadcast_8c.html#afbdc3a135b42022a6041d1c69c1b18f3">BroadcastDisableMovToCr3ExitingOnAllProcessors</a></div><div class="ttdeci">VOID BroadcastDisableMovToCr3ExitingOnAllProcessors()</div><div class="ttdoc">routines for debugging threads (disable mov-to-cr3 exiting)</div><div class="ttdef"><b>Definition</b> Broadcast.c:491</div></div>
<div class="ttc" id="a_global_variables_8h_html_a0a4399a3814cd63654f47ac6f4f5ad02"><div class="ttname"><a href="_global_variables_8h.html#a0a4399a3814cd63654f47ac6f4f5ad02">g_ExecTrapUnInitializationStarted</a></div><div class="ttdeci">BOOLEAN g_ExecTrapUnInitializationStarted</div><div class="ttdoc">Showes whether the uninitialization of the exec trap is started or not.</div><div class="ttdef"><b>Definition</b> GlobalVariables.h:156</div></div>
<div class="ttc" id="a_mode_based_exec_hook_8c_html_a17a8e377b4679423f8c80f9dab0f113a"><div class="ttname"><a href="_mode_based_exec_hook_8c.html#a17a8e377b4679423f8c80f9dab0f113a">ModeBasedExecHookUninitialize</a></div><div class="ttdeci">VOID ModeBasedExecHookUninitialize()</div><div class="ttdoc">Uinitialize the needed structure for hooking mode execution.</div><div class="ttdef"><b>Definition</b> ModeBasedExecHook.c:247</div></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_53a6cdbae347618e9ee76d4be5c6ea96.html">hyperdbg</a></li><li class="navelem"><a class="el" href="dir_e536aab728f7b0abbbf7dc8fdcfcc81b.html">hyperhv</a></li><li class="navelem"><a class="el" href="dir_c1e9402aa68d313bf3c169dd8660abb3.html">header</a></li><li class="navelem"><a class="el" href="dir_128f5da10fd3fee7ea78db82045dc048.html">hooks</a></li><li class="navelem"><a class="el" href="_exec_trap_8h.html">ExecTrap.h</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
