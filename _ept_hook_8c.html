<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HyperDbg Debugger: hyperdbg/hyperhv/code/hooks/ept-hook/EptHook.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">HyperDbg Debugger
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_ept_hook_8c.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">EptHook.c File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Implementation of different EPT hidden hooks functions.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;pch.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a07e6c832deccdf103509a4d362897a7f" id="r_a07e6c832deccdf103509a4d362897a7f"><td class="memItemLeft" align="right" valign="top">_Must_inspect_result_&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a07e6c832deccdf103509a4d362897a7f">_Success_</a> (return==<a class="el" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</td></tr>
<tr class="memdesc:a07e6c832deccdf103509a4d362897a7f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check whether the desired PhysicalAddress is already in the g_EptState-&gt;HookedPagesList hooks or not.  <br /></td></tr>
<tr class="separator:a07e6c832deccdf103509a4d362897a7f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5bc373b3d6bea35f4e06a221bec6a90b" id="r_a5bc373b3d6bea35f4e06a221bec6a90b"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a5bc373b3d6bea35f4e06a221bec6a90b">EptHookReservePreallocatedPoolsForEptHooks</a> (<a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> Count)</td></tr>
<tr class="memdesc:a5bc373b3d6bea35f4e06a221bec6a90b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reserve pre-allocated pools for EPT hooks.  <br /></td></tr>
<tr class="separator:a5bc373b3d6bea35f4e06a221bec6a90b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abb1bb8e5caaed9c63ffcfad80a2d0ebd" id="r_abb1bb8e5caaed9c63ffcfad80a2d0ebd"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#abb1bb8e5caaed9c63ffcfad80a2d0ebd">EptHookAllocateExtraHookingPagesForMemoryMonitorsAndExecEptHooks</a> (<a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> Count)</td></tr>
<tr class="memdesc:abb1bb8e5caaed9c63ffcfad80a2d0ebd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Allocate (reserve) extra pages for storing details of page hooks for memory monitor and regular hidden breakpoit exec EPT hooks.  <br /></td></tr>
<tr class="separator:abb1bb8e5caaed9c63ffcfad80a2d0ebd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af62063007bc1450386954e16032ce5fd" id="r_af62063007bc1450386954e16032ce5fd"><td class="memItemLeft" align="right" valign="top">PVOID&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af62063007bc1450386954e16032ce5fd">ExAllocatePoolWithTagHook</a> (POOL_TYPE <a class="el" href="_hooks_8h.html#a5d405dff9ba7e6c73d78857f415965f4">PoolType</a>, SIZE_T <a class="el" href="_hooks_8h.html#a61083d5dde730c2afd10a336322aaaac">NumberOfBytes</a>, <a class="el" href="_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_hooks_8h.html#aba7c9f3767dcc5232354d3d17ceedb61">Tag</a>)</td></tr>
<tr class="memdesc:af62063007bc1450386954e16032ce5fd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Hook function that HooksExAllocatePoolWithTag.  <br /></td></tr>
<tr class="separator:af62063007bc1450386954e16032ce5fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a32f950fc6247cece400187114bac26ab" id="r_a32f950fc6247cece400187114bac26ab"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a32f950fc6247cece400187114bac26ab">EptHookPerformPageHook</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, PVOID TargetAddress, <a class="el" href="_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> ProcessCr3)</td></tr>
<tr class="memdesc:a32f950fc6247cece400187114bac26ab"><td class="mdescLeft">&#160;</td><td class="mdescRight">The main function that performs EPT page hook with hidden breakpoint.  <br /></td></tr>
<tr class="separator:a32f950fc6247cece400187114bac26ab"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acb85a5366d63e1484261f3c32dfb4f64" id="r_acb85a5366d63e1484261f3c32dfb4f64"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#acb85a5366d63e1484261f3c32dfb4f64">EptHookPerformHook</a> (PVOID TargetAddress, <a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId, <a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ApplyDirectlyFromVmxRoot)</td></tr>
<tr class="memdesc:acb85a5366d63e1484261f3c32dfb4f64"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function invokes a VMCALL to set the hook and broadcast the exiting for the breakpoints on exception bitmap.  <br /></td></tr>
<tr class="separator:acb85a5366d63e1484261f3c32dfb4f64"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abcbdb9cd3dbdf238b8b5d484522855e3" id="r_abcbdb9cd3dbdf238b8b5d484522855e3"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#abcbdb9cd3dbdf238b8b5d484522855e3">EptHook</a> (PVOID TargetAddress, <a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:abcbdb9cd3dbdf238b8b5d484522855e3"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function invokes a VMCALL to set the hook and broadcast the exiting for the breakpoints on exception bitmap.  <br /></td></tr>
<tr class="separator:abcbdb9cd3dbdf238b8b5d484522855e3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1d3773a49e29eaf03835b7a064817646" id="r_a1d3773a49e29eaf03835b7a064817646"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a1d3773a49e29eaf03835b7a064817646">EptHookFromVmxRoot</a> (PVOID TargetAddress)</td></tr>
<tr class="memdesc:a1d3773a49e29eaf03835b7a064817646"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function invokes a direct VMCALL to setup the hook.  <br /></td></tr>
<tr class="separator:a1d3773a49e29eaf03835b7a064817646"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a03c810703f75ca09341a4d70e02293c3" id="r_a03c810703f75ca09341a4d70e02293c3"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a03c810703f75ca09341a4d70e02293c3">EptHookRestoreSingleHookToOriginalEntry</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, SIZE_T PhysicalAddress, <a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> OriginalEntry)</td></tr>
<tr class="memdesc:a03c810703f75ca09341a4d70e02293c3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove and Invalidate Hook in TLB (Hidden Detours and if counter of hidden breakpoint is zero)  <br /></td></tr>
<tr class="separator:a03c810703f75ca09341a4d70e02293c3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0b2a50efc209dfa3aedcd756c7128607" id="r_a0b2a50efc209dfa3aedcd756c7128607"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a0b2a50efc209dfa3aedcd756c7128607">EptHookRestoreAllHooksToOriginalEntry</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu)</td></tr>
<tr class="memdesc:a0b2a50efc209dfa3aedcd756c7128607"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove and Invalidate Hook in TLB.  <br /></td></tr>
<tr class="separator:a0b2a50efc209dfa3aedcd756c7128607"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a50935db932e916707520e63212e9e688" id="r_a50935db932e916707520e63212e9e688"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a50935db932e916707520e63212e9e688">EptHookWriteAbsoluteJump</a> (PCHAR TargetBuffer, SIZE_T TargetAddress)</td></tr>
<tr class="memdesc:a50935db932e916707520e63212e9e688"><td class="mdescLeft">&#160;</td><td class="mdescRight">Write an absolute x64 jump to an arbitrary address to a buffer.  <br /></td></tr>
<tr class="separator:a50935db932e916707520e63212e9e688"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8767a6d054fe785e66068e32b4466b87" id="r_a8767a6d054fe785e66068e32b4466b87"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a8767a6d054fe785e66068e32b4466b87">EptHookWriteAbsoluteJump2</a> (PCHAR TargetBuffer, SIZE_T TargetAddress)</td></tr>
<tr class="memdesc:a8767a6d054fe785e66068e32b4466b87"><td class="mdescLeft">&#160;</td><td class="mdescRight">Write an absolute x64 jump to an arbitrary address to a buffer.  <br /></td></tr>
<tr class="separator:a8767a6d054fe785e66068e32b4466b87"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1a97cf8a3d1243edf02539139bbfb617" id="r_a1a97cf8a3d1243edf02539139bbfb617"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a1a97cf8a3d1243edf02539139bbfb617">EptHookInstructionMemory</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a> Hook, <a class="el" href="_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> ProcessCr3, PVOID TargetFunction, PVOID TargetFunctionInSafeMemory, PVOID HookFunction)</td></tr>
<tr class="memdesc:a1a97cf8a3d1243edf02539139bbfb617"><td class="mdescLeft">&#160;</td><td class="mdescRight">Hook instructions.  <br /></td></tr>
<tr class="separator:a1a97cf8a3d1243edf02539139bbfb617"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aadbcf1945213c68375c8871dbecc3971" id="r_aadbcf1945213c68375c8871dbecc3971"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aadbcf1945213c68375c8871dbecc3971">EptHookPerformPageHookMonitorAndInlineHook</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, PVOID HookingDetails, <a class="el" href="_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> ProcessCr3, <a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> PageHookMask)</td></tr>
<tr class="memdesc:aadbcf1945213c68375c8871dbecc3971"><td class="mdescLeft">&#160;</td><td class="mdescRight">The main function that performs EPT page hook with hidden detours and monitor.  <br /></td></tr>
<tr class="separator:aadbcf1945213c68375c8871dbecc3971"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a55a664f6c354dacfe2dd66c1ae4415e8" id="r_a55a664f6c354dacfe2dd66c1ae4415e8"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a55a664f6c354dacfe2dd66c1ae4415e8">EptHookPerformMemoryOrInlineHook</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, <a class="el" href="_data_types_8h.html#ab19c4c1932f3ad9dfeb7168bab678ee0">EPT_HOOKS_ADDRESS_DETAILS_FOR_EPTHOOK2</a> *EptHook2AddressDetails, <a class="el" href="_data_types_8h.html#ad14bc163543c2acede2c878c50aeca14">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *MemoryAddressDetails, <a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId, <a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHiddenHook2, <a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ApplyDirectlyFromVmxRoot)</td></tr>
<tr class="memdesc:a55a664f6c354dacfe2dd66c1ae4415e8"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function allocates a buffer in VMX Non Root Mode and then invokes a VMCALL to set the hook.  <br /></td></tr>
<tr class="separator:a55a664f6c354dacfe2dd66c1ae4415e8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2935a49abe92cf51319ef81e20f8ac14" id="r_a2935a49abe92cf51319ef81e20f8ac14"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a2935a49abe92cf51319ef81e20f8ac14">EptHookInlineHook</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, PVOID TargetAddress, PVOID HookFunction, <a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:a2935a49abe92cf51319ef81e20f8ac14"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function applies EPT hook 2 (inline) to the target EPT table.  <br /></td></tr>
<tr class="separator:a2935a49abe92cf51319ef81e20f8ac14"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acc6e339c3d8b2700e46862591cd5458b" id="r_acc6e339c3d8b2700e46862591cd5458b"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#acc6e339c3d8b2700e46862591cd5458b">EptHookMonitorHook</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, <a class="el" href="_data_types_8h.html#ad14bc163543c2acede2c878c50aeca14">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *HookingDetails, <a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:acc6e339c3d8b2700e46862591cd5458b"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function applies monitor hooks to the target EPT table.  <br /></td></tr>
<tr class="separator:acc6e339c3d8b2700e46862591cd5458b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5b9714c9baeabde116049cd66622a00a" id="r_a5b9714c9baeabde116049cd66622a00a"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a5b9714c9baeabde116049cd66622a00a">EptHookInlineHookFromVmxRoot</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, PVOID TargetAddress, PVOID HookFunction)</td></tr>
<tr class="memdesc:a5b9714c9baeabde116049cd66622a00a"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function applies EPT inline to the target EPT table.  <br /></td></tr>
<tr class="separator:a5b9714c9baeabde116049cd66622a00a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a308b3a4a443a479190f2f09599eae906" id="r_a308b3a4a443a479190f2f09599eae906"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a308b3a4a443a479190f2f09599eae906">EptHookMonitorFromVmxRoot</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, <a class="el" href="_data_types_8h.html#ad14bc163543c2acede2c878c50aeca14">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *MemoryAddressDetails)</td></tr>
<tr class="memdesc:a308b3a4a443a479190f2f09599eae906"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function applies EPT monitor hooks to the target EPT table.  <br /></td></tr>
<tr class="separator:a308b3a4a443a479190f2f09599eae906"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a47fe46d2ddd86f75aeeeeaa38fafe3eb" id="r_a47fe46d2ddd86f75aeeeeaa38fafe3eb"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a47fe46d2ddd86f75aeeeeaa38fafe3eb">EptHookHandleHookedPage</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, <a class="el" href="hyperhv_2header_2common_2_state_8h.html#a2ef230620f7c5617f62c8022159293fb">EPT_HOOKED_PAGE_DETAIL</a> *HookedEntryDetails, VMX_EXIT_QUALIFICATION_EPT_VIOLATION ViolationQualification, SIZE_T PhysicalAddress, <a class="el" href="_data_types_8h.html#a732f5fb65b66d5b23321a9b1c69e64d1">EPT_HOOKS_CONTEXT</a> *LastContext, <a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> *IgnoreReadOrWriteOrExec, <a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> *IsExecViolation)</td></tr>
<tr class="memdesc:a47fe46d2ddd86f75aeeeeaa38fafe3eb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handles page hooks (trigger events)  <br /></td></tr>
<tr class="separator:a47fe46d2ddd86f75aeeeeaa38fafe3eb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acac4eff03b2197ae43e4c13f382e20b5" id="r_acac4eff03b2197ae43e4c13f382e20b5"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a> (<a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> <a class="el" href="_hyper_dbg_script_imports_8h.html#a3f7c5b71d899e923be0a80d4ac7902fe">Address</a>)</td></tr>
<tr class="memdesc:acac4eff03b2197ae43e4c13f382e20b5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove the entry from g_EptHook2sDetourListHead in the case of !epthook2 details.  <br /></td></tr>
<tr class="separator:acac4eff03b2197ae43e4c13f382e20b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd0179b7c5730f636141dfea2afcdc5a" id="r_acd0179b7c5730f636141dfea2afcdc5a"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#acd0179b7c5730f636141dfea2afcdc5a">EptHookGetCountOfEpthooks</a> (<a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsEptHook2)</td></tr>
<tr class="memdesc:acd0179b7c5730f636141dfea2afcdc5a"><td class="mdescLeft">&#160;</td><td class="mdescRight">get the length of active EPT hooks (!epthook and !epthook2)  <br /></td></tr>
<tr class="separator:acd0179b7c5730f636141dfea2afcdc5a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a15af39b643632343c25539a4931084ce" id="r_a15af39b643632343c25539a4931084ce"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a15af39b643632343c25539a4931084ce">EptHookUnHookSingleAddressDetoursAndMonitor</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry, <a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ApplyDirectlyFromVmxRoot, <a class="el" href="_data_types_8h.html#a27c1e2d2980e51cf66a1c72b3f08ba13">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> *TargetUnhookingDetails)</td></tr>
<tr class="memdesc:a15af39b643632343c25539a4931084ce"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove single hook of detours type.  <br /></td></tr>
<tr class="separator:a15af39b643632343c25539a4931084ce"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a20926ad378e67d34368b5a8cd6306ad5" id="r_a20926ad378e67d34368b5a8cd6306ad5"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a20926ad378e67d34368b5a8cd6306ad5">EptHookHandleMonitorTrapFlag</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu)</td></tr>
<tr class="memdesc:a20926ad378e67d34368b5a8cd6306ad5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handle vm-exits for Monitor Trap Flag to restore previous state.  <br /></td></tr>
<tr class="separator:a20926ad378e67d34368b5a8cd6306ad5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab65f9dabbdc5421ee817b6962b4fbbc3" id="r_ab65f9dabbdc5421ee817b6962b4fbbc3"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ab65f9dabbdc5421ee817b6962b4fbbc3">EptHookUnHookSingleAddressHiddenBreakpoint</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry, <a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VirtualAddress, <a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ApplyDirectlyFromVmxRoot, <a class="el" href="_data_types_8h.html#a27c1e2d2980e51cf66a1c72b3f08ba13">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> *TargetUnhookingDetails)</td></tr>
<tr class="memdesc:ab65f9dabbdc5421ee817b6962b4fbbc3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove single hook of hidden breakpoint type.  <br /></td></tr>
<tr class="separator:ab65f9dabbdc5421ee817b6962b4fbbc3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af8b74d71541023dd924e0a7c01a6c3c1" id="r_af8b74d71541023dd924e0a7c01a6c3c1"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af8b74d71541023dd924e0a7c01a6c3c1">EptHookPerformUnHookSingleAddress</a> (<a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VirtualAddress, <a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> PhysAddress, <a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> HookingTag, <a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId, <a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> ApplyDirectlyFromVmxRoot, <a class="el" href="_data_types_8h.html#a27c1e2d2980e51cf66a1c72b3f08ba13">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> *TargetUnhookingDetails)</td></tr>
<tr class="memdesc:af8b74d71541023dd924e0a7c01a6c3c1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove single hook from the hooked pages list and invalidate TLB.  <br /></td></tr>
<tr class="separator:af8b74d71541023dd924e0a7c01a6c3c1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5304ad90d3cc4ecdc64a7c4868877435" id="r_a5304ad90d3cc4ecdc64a7c4868877435"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a5304ad90d3cc4ecdc64a7c4868877435">EptHookUnHookAllByHookingTag</a> (<a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> HookingTag)</td></tr>
<tr class="memdesc:a5304ad90d3cc4ecdc64a7c4868877435"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove all hooks from the hooked pages by the given hooking tag.  <br /></td></tr>
<tr class="separator:a5304ad90d3cc4ecdc64a7c4868877435"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af811dff7684ead032bf5439bfab2b928" id="r_af811dff7684ead032bf5439bfab2b928"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af811dff7684ead032bf5439bfab2b928">EptHookUnHookSingleHookByHookingTagFromVmxRoot</a> (<a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> HookingTag, <a class="el" href="_data_types_8h.html#a27c1e2d2980e51cf66a1c72b3f08ba13">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> *TargetUnhookingDetails)</td></tr>
<tr class="memdesc:af811dff7684ead032bf5439bfab2b928"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove single hook from the hooked pages by the given hooking tag.  <br /></td></tr>
<tr class="separator:af811dff7684ead032bf5439bfab2b928"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a24ce2115ab4514ec8eed08d0911b64d6" id="r_a24ce2115ab4514ec8eed08d0911b64d6"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a24ce2115ab4514ec8eed08d0911b64d6">EptHookUnHookSingleAddress</a> (<a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VirtualAddress, <a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> PhysAddress, <a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:a24ce2115ab4514ec8eed08d0911b64d6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove single hook from the hooked pages list and invalidate TLB.  <br /></td></tr>
<tr class="separator:a24ce2115ab4514ec8eed08d0911b64d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a80ec91bc8431e536aa32d2e182444f17" id="r_a80ec91bc8431e536aa32d2e182444f17"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a80ec91bc8431e536aa32d2e182444f17">EptHookUnHookSingleAddressFromVmxRoot</a> (<a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VirtualAddress, <a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> PhysAddress, <a class="el" href="_data_types_8h.html#a27c1e2d2980e51cf66a1c72b3f08ba13">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> *TargetUnhookingDetails)</td></tr>
<tr class="memdesc:a80ec91bc8431e536aa32d2e182444f17"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove single hook from the hooked pages list and invalidate TLB.  <br /></td></tr>
<tr class="separator:a80ec91bc8431e536aa32d2e182444f17"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac8845ca75f3b4c267d3542d20621f547" id="r_ac8845ca75f3b4c267d3542d20621f547"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ac8845ca75f3b4c267d3542d20621f547">EptHookUnHookAll</a> ()</td></tr>
<tr class="memdesc:ac8845ca75f3b4c267d3542d20621f547"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove all hooks from the hooked pages list and invalidate TLB @detailsShould be called from Vmx Non-root.  <br /></td></tr>
<tr class="separator:ac8845ca75f3b4c267d3542d20621f547"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2d6894b9430a2758f65c2a646ee6c872" id="r_a2d6894b9430a2758f65c2a646ee6c872"><td class="memItemLeft" align="right" valign="top">PVOID&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a2d6894b9430a2758f65c2a646ee6c872">EptHook2GeneralDetourEventHandler</a> (<a class="el" href="_basic_types_8h.html#a2bd4673df5e6e2fb371d770f3f2886d9">PGUEST_REGS</a> Regs, PVOID CalledFrom)</td></tr>
<tr class="memdesc:a2d6894b9430a2758f65c2a646ee6c872"><td class="mdescLeft">&#160;</td><td class="mdescRight">routines to generally handle breakpoint hit for detour  <br /></td></tr>
<tr class="separator:a2d6894b9430a2758f65c2a646ee6c872"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a54499f05708f5cf69df924d7cf92ba89" id="r_a54499f05708f5cf69df924d7cf92ba89"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a54499f05708f5cf69df924d7cf92ba89">EptHookModifyInstructionFetchState</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, PVOID PhysicalAddress, <a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsUnset)</td></tr>
<tr class="memdesc:a54499f05708f5cf69df924d7cf92ba89"><td class="mdescLeft">&#160;</td><td class="mdescRight">Change PML EPT state for execution (execute) @detail should be called from VMX-root.  <br /></td></tr>
<tr class="separator:a54499f05708f5cf69df924d7cf92ba89"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1dc01f084128845b23788d6f384df6ab" id="r_a1dc01f084128845b23788d6f384df6ab"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a1dc01f084128845b23788d6f384df6ab">EptHookModifyPageReadState</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, PVOID PhysicalAddress, <a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsUnset)</td></tr>
<tr class="memdesc:a1dc01f084128845b23788d6f384df6ab"><td class="mdescLeft">&#160;</td><td class="mdescRight">Change PML EPT state for read @detail should be called from VMX-root.  <br /></td></tr>
<tr class="separator:a1dc01f084128845b23788d6f384df6ab"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a04587a27698f5cc43cd9c2c13a6736c5" id="r_a04587a27698f5cc43cd9c2c13a6736c5"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a04587a27698f5cc43cd9c2c13a6736c5">EptHookModifyPageWriteState</a> (<a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, PVOID PhysicalAddress, <a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsUnset)</td></tr>
<tr class="memdesc:a04587a27698f5cc43cd9c2c13a6736c5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Change PML EPT state for write @detail should be called from VMX-root.  <br /></td></tr>
<tr class="separator:a04587a27698f5cc43cd9c2c13a6736c5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implementation of different EPT hidden hooks functions. </p>
<dl class="section author"><dt>Author</dt><dd>Sina Karvandi (<a href="#" onclick="location.href='mai'+'lto:'+'sin'+'a@'+'hyp'+'er'+'dbg'+'.o'+'rg'; return false;">sina@<span class="obfuscator">.nosp@m.</span>hype<span class="obfuscator">.nosp@m.</span>rdbg.<span class="obfuscator">.nosp@m.</span>org</a>)</dd></dl>
<p>All the R/W hooks, Execute hooks and hardware register simulators are implemented here</p>
<dl class="section version"><dt>Version</dt><dd>0.1 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2020-04-11</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>This project is released under the GNU Public License v3. </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a07e6c832deccdf103509a4d362897a7f" name="a07e6c832deccdf103509a4d362897a7f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a07e6c832deccdf103509a4d362897a7f">&#9670;&#160;</a></span>_Success_()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Must_inspect_result_ _Success_ </td>
          <td>(</td>
          <td class="paramtype">return</td>          <td class="paramname"><span class="paramname"><em></em></span><span class="paramdefsep"> = </span><span class="paramdefval">=&#160;<a class="el" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check whether the desired PhysicalAddress is already in the g_EptState-&gt;HookedPagesList hooks or not. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PhysicalBaseAddress</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PEPT_HOOKED_PAGE_DETAIL if the address was already hooked, or FALSE </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">   27</span>{</div>
<div class="line"><span class="lineno">   28</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList, CurrEntity)</div>
<div class="line"><span class="lineno">   29</span>    {</div>
<div class="line"><span class="lineno">   30</span>        <span class="keywordflow">if</span> (CurrEntity-&gt;PhysicalBaseAddress == PhysicalBaseAddress)</div>
<div class="line"><span class="lineno">   31</span>        {</div>
<div class="line"><span class="lineno">   32</span>            <span class="keywordflow">return</span> CurrEntity;</div>
<div class="line"><span class="lineno">   33</span>        }</div>
<div class="line"><span class="lineno">   34</span>    }</div>
<div class="line"><span class="lineno">   35</span> </div>
<div class="line"><span class="lineno">   36</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno">   37</span>}</div>
<div class="ttc" id="a_global_variables_8h_html_a302f00c62e7ad092a9f44a3aa7452d99"><div class="ttname"><a href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a></div><div class="ttdeci">EPT_STATE * g_EptState</div><div class="ttdoc">Save the state and variables related to EPT.</div><div class="ttdef"><b>Definition</b> GlobalVariables.h:50</div></div>
<div class="ttc" id="a_meta_macros_8h_html_ae6305b9ffbb1d946674b7b98431a67e9"><div class="ttname"><a href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a></div><div class="ttdeci">#define LIST_FOR_EACH_LINK(_head, _struct_type, _member, _var)</div><div class="ttdef"><b>Definition</b> MetaMacros.h:34</div></div>
<div class="ttc" id="anamespacetest-case-generator_html_a9a4eff80432bb93d2796381610dd86c3"><div class="ttname"><a href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">test-case-generator.NULL</a></div><div class="ttdeci">NULL()</div><div class="ttdef"><b>Definition</b> test-case-generator.py:530</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">_EPT_HOOKED_PAGE_DETAIL</a></div><div class="ttdoc">Structure to save the state of each hooked pages.</div><div class="ttdef"><b>Definition</b> State.h:163</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a2503c5862b1bb2b779e2185b4097aa15"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">_EPT_STATE::HookedPagesList</a></div><div class="ttdeci">LIST_ENTRY HookedPagesList</div><div class="ttdef"><b>Definition</b> Ept.h:118</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="abcbdb9cd3dbdf238b8b5d484522855e3" name="abcbdb9cd3dbdf238b8b5d484522855e3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abcbdb9cd3dbdf238b8b5d484522855e3">&#9670;&#160;</a></span>EptHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHook </td>
          <td>(</td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>TargetAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>ProcessId</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function invokes a VMCALL to set the hook and broadcast the exiting for the breakpoints on exception bitmap. </p>
<p>Hook in VMX non-root Mode (hidden breakpoint)</p>
<p>this command uses hidden breakpoints (0xcc) to hook, THIS FUNCTION SHOULD BE CALLED WHEN THE VMLAUNCH ALREADY EXECUTED, it is because, broadcasting to enable exception bitmap for breakpoint is not clear here, if we want to broadcast to enable exception bitmaps on all cores when vmlaunch is not executed then that's ok but a user might call this function when we didn't configure the vmcs, it's a problem! we can solve it by giving a hint to vmcs configure function to make it ok for future configuration but that sounds stupid, I think it's better to not support this feature. Btw, debugger won't use this function in the above mentioned method, so we won't have any problem with this This function should be called from VMX non-root mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id to translate based on that process's cr3</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  606</span>{</div>
<div class="line"><span class="lineno">  607</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  608</span>    <span class="comment">// Should be called from vmx non-root</span></div>
<div class="line"><span class="lineno">  609</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  610</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno">  611</span>    {</div>
<div class="line"><span class="lineno">  612</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  613</span>    }</div>
<div class="line"><span class="lineno">  614</span> </div>
<div class="line"><span class="lineno">  615</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="#acb85a5366d63e1484261f3c32dfb4f64">EptHookPerformHook</a>(TargetAddress, ProcessId, <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div>
<div class="line"><span class="lineno">  616</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdef"><b>Definition</b> BasicTypes.h:55</div></div>
<div class="ttc" id="a_basic_types_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdef"><b>Definition</b> BasicTypes.h:54</div></div>
<div class="ttc" id="a_ept_hook_8c_html_acb85a5366d63e1484261f3c32dfb4f64"><div class="ttname"><a href="#acb85a5366d63e1484261f3c32dfb4f64">EptHookPerformHook</a></div><div class="ttdeci">BOOLEAN EptHookPerformHook(PVOID TargetAddress, UINT32 ProcessId, BOOLEAN ApplyDirectlyFromVmxRoot)</div><div class="ttdoc">This function invokes a VMCALL to set the hook and broadcast the exiting for the breakpoints on excep...</div><div class="ttdef"><b>Definition</b> EptHook.c:533</div></div>
<div class="ttc" id="a_vmx_8c_html_a21a5facaf10e8fbeb70dd00942e51ef1"><div class="ttname"><a href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a></div><div class="ttdeci">BOOLEAN VmxGetCurrentExecutionMode()</div><div class="ttdoc">Check current execution mode (vmx-root and non-root)</div><div class="ttdef"><b>Definition</b> Vmx.c:222</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a2d6894b9430a2758f65c2a646ee6c872" name="a2d6894b9430a2758f65c2a646ee6c872"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2d6894b9430a2758f65c2a646ee6c872">&#9670;&#160;</a></span>EptHook2GeneralDetourEventHandler()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PVOID EptHook2GeneralDetourEventHandler </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a2bd4673df5e6e2fb371d770f3f2886d9">PGUEST_REGS</a></td>          <td class="paramname"><span class="paramname"><em>Regs</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>CalledFrom</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>routines to generally handle breakpoint hit for detour </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Regs</td><td></td></tr>
    <tr><td class="paramname">CalledFrom</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PVOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 2484</span>{</div>
<div class="line"><span class="lineno"> 2485</span>    PLIST_ENTRY       TempList    = 0;</div>
<div class="line"><span class="lineno"> 2486</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html">EPT_HOOKS_CONTEXT</a> TempContext = {0};</div>
<div class="line"><span class="lineno"> 2487</span> </div>
<div class="line"><span class="lineno"> 2488</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2489</span>    <span class="comment">// The RSP register is the at the RCX and we just added (reverse by stack) to it&#39;s</span></div>
<div class="line"><span class="lineno"> 2490</span>    <span class="comment">// values by the size of the GUEST_REGS</span></div>
<div class="line"><span class="lineno"> 2491</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2492</span>    Regs-&gt;<a class="code hl_variable" href="struct_g_u_e_s_t___r_e_g_s.html#a04918d3fe8010c01a6bd3f1ba4e11bc2">rsp</a> = (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)Regs - <span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct_g_u_e_s_t___r_e_g_s.html">GUEST_REGS</a>);</div>
<div class="line"><span class="lineno"> 2493</span> </div>
<div class="line"><span class="lineno"> 2494</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2495</span>    <span class="comment">// test</span></div>
<div class="line"><span class="lineno"> 2496</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2497</span> </div>
<div class="line"><span class="lineno"> 2498</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2499</span>    <span class="comment">// LogInfo(&quot;Hidden Hooked function Called with : rcx = 0x%llx , rdx = 0x%llx , r8 = 0x%llx ,  r9 = 0x%llx&quot;,</span></div>
<div class="line"><span class="lineno"> 2500</span>    <span class="comment">//        Regs-&gt;rcx,</span></div>
<div class="line"><span class="lineno"> 2501</span>    <span class="comment">//        Regs-&gt;rdx,</span></div>
<div class="line"><span class="lineno"> 2502</span>    <span class="comment">//        Regs-&gt;r8,</span></div>
<div class="line"><span class="lineno"> 2503</span>    <span class="comment">//        Regs-&gt;r9);</span></div>
<div class="line"><span class="lineno"> 2504</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2505</span> </div>
<div class="line"><span class="lineno"> 2506</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2507</span>    <span class="comment">// Create temporary context</span></div>
<div class="line"><span class="lineno"> 2508</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2509</span>    TempContext.<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#a2f5080d315f72646f57eda6e61e1aff1">VirtualAddress</a>  = (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)CalledFrom;</div>
<div class="line"><span class="lineno"> 2510</span>    TempContext.<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#afc81b90725dc9bc78a4a7b0cdf5a314b">PhysicalAddress</a> = <a class="code hl_function" href="_conversion_8c.html#ab7aedff95075e77cd8fbe128f01d2853">VirtualAddressToPhysicalAddress</a>(CalledFrom);</div>
<div class="line"><span class="lineno"> 2511</span> </div>
<div class="line"><span class="lineno"> 2512</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2513</span>    <span class="comment">// Create a temporary VCpu</span></div>
<div class="line"><span class="lineno"> 2514</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2515</span>    <a class="code hl_struct" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html">VIRTUAL_MACHINE_STATE</a> * VCpu = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[KeGetCurrentProcessorNumberEx(NULL)];</div>
<div class="line"><span class="lineno"> 2516</span> </div>
<div class="line"><span class="lineno"> 2517</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2518</span>    <span class="comment">// Set the register for the temporary VCpu</span></div>
<div class="line"><span class="lineno"> 2519</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2520</span>    VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aae00ab92fdce5f90e65edb3bd10ae696">Regs</a> = Regs;</div>
<div class="line"><span class="lineno"> 2521</span> </div>
<div class="line"><span class="lineno"> 2522</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2523</span>    <span class="comment">// As the context to event trigger, we send the address of function</span></div>
<div class="line"><span class="lineno"> 2524</span>    <span class="comment">// which is current hidden hook is triggered for it</span></div>
<div class="line"><span class="lineno"> 2525</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2526</span>    <a class="code hl_function" href="_dispatch_8c.html#abdd5d2cff9ea39a842046b1af7a72c51">DispatchEventHiddenHookExecDetours</a>(VCpu, &amp;TempContext);</div>
<div class="line"><span class="lineno"> 2527</span> </div>
<div class="line"><span class="lineno"> 2528</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2529</span>    <span class="comment">// Iterate through the list of hooked pages details to find</span></div>
<div class="line"><span class="lineno"> 2530</span>    <span class="comment">// and return where want to jump after this functions</span></div>
<div class="line"><span class="lineno"> 2531</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2532</span>    TempList = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a>;</div>
<div class="line"><span class="lineno"> 2533</span> </div>
<div class="line"><span class="lineno"> 2534</span>    <span class="keywordflow">while</span> (&amp;<a class="code hl_variable" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a> != TempList-&gt;Flink)</div>
<div class="line"><span class="lineno"> 2535</span>    {</div>
<div class="line"><span class="lineno"> 2536</span>        TempList                                          = TempList-&gt;Flink;</div>
<div class="line"><span class="lineno"> 2537</span>        <a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">PHIDDEN_HOOKS_DETOUR_DETAILS</a> CurrentHookedDetails = CONTAINING_RECORD(TempList, <a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">HIDDEN_HOOKS_DETOUR_DETAILS</a>, OtherHooksList);</div>
<div class="line"><span class="lineno"> 2538</span> </div>
<div class="line"><span class="lineno"> 2539</span>        <span class="keywordflow">if</span> (CurrentHookedDetails-&gt;<a class="code hl_variable" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a5b7e945d9dd258586acd7e0268c8f11a">HookedFunctionAddress</a> == CalledFrom)</div>
<div class="line"><span class="lineno"> 2540</span>        {</div>
<div class="line"><span class="lineno"> 2541</span>            <span class="keywordflow">return</span> CurrentHookedDetails-&gt;<a class="code hl_variable" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a89757e40877fd300bf09ab3b45642f28">ReturnAddress</a>;</div>
<div class="line"><span class="lineno"> 2542</span>        }</div>
<div class="line"><span class="lineno"> 2543</span>    }</div>
<div class="line"><span class="lineno"> 2544</span> </div>
<div class="line"><span class="lineno"> 2545</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2546</span>    <span class="comment">// If we reach here, means that we didn&#39;t find the return address</span></div>
<div class="line"><span class="lineno"> 2547</span>    <span class="comment">// that&#39;s an error, generally we can&#39;t do anything but as the user</span></div>
<div class="line"><span class="lineno"> 2548</span>    <span class="comment">// might already cleaned the hook and the structures are removed</span></div>
<div class="line"><span class="lineno"> 2549</span>    <span class="comment">// so we just return the original caller address and continue the</span></div>
<div class="line"><span class="lineno"> 2550</span>    <span class="comment">// guest normally</span></div>
<div class="line"><span class="lineno"> 2551</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2552</span>    <span class="keywordflow">return</span> CalledFrom;</div>
<div class="line"><span class="lineno"> 2553</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_aae17ebb9ef7279d026817fb22f8aebe9"><div class="ttname"><a href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></div><div class="ttdeci">unsigned __int64 UINT64</div><div class="ttdef"><b>Definition</b> BasicTypes.h:21</div></div>
<div class="ttc" id="a_conversion_8c_html_ab7aedff95075e77cd8fbe128f01d2853"><div class="ttname"><a href="_conversion_8c.html#ab7aedff95075e77cd8fbe128f01d2853">VirtualAddressToPhysicalAddress</a></div><div class="ttdeci">_Use_decl_annotations_ UINT64 VirtualAddressToPhysicalAddress(_In_ PVOID VirtualAddress)</div><div class="ttdoc">Converts Virtual Address to Physical Address.</div><div class="ttdef"><b>Definition</b> Conversion.c:154</div></div>
<div class="ttc" id="a_dispatch_8c_html_abdd5d2cff9ea39a842046b1af7a72c51"><div class="ttname"><a href="_dispatch_8c.html#abdd5d2cff9ea39a842046b1af7a72c51">DispatchEventHiddenHookExecDetours</a></div><div class="ttdeci">VOID DispatchEventHiddenHookExecDetours(VIRTUAL_MACHINE_STATE *VCpu, PVOID Context)</div><div class="ttdoc">Handling debugger functions related to hidden hook exec detours events.</div><div class="ttdef"><b>Definition</b> Dispatch.c:984</div></div>
<div class="ttc" id="a_global_variables_8h_html_a04bac1f4beef0dcf1ce1a4d9ce72ea76"><div class="ttname"><a href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a></div><div class="ttdeci">VIRTUAL_MACHINE_STATE * g_GuestState</div><div class="ttdoc">Save the state and variables related to virtualization on each to logical core.</div><div class="ttdef"><b>Definition</b> GlobalVariables.h:38</div></div>
<div class="ttc" id="a_global_variables_8h_html_a90f5a18f43567010690d8d7927619fa0"><div class="ttname"><a href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a></div><div class="ttdeci">LIST_ENTRY g_EptHook2sDetourListHead</div><div class="ttdoc">List header of hidden hooks detour.</div><div class="ttdef"><b>Definition</b> GlobalVariables.h:62</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t_html"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html">_EPT_HOOKS_CONTEXT</a></div><div class="ttdoc">Temporary $context used in some EPT hook commands.</div><div class="ttdef"><b>Definition</b> DataTypes.h:320</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t_html_a2f5080d315f72646f57eda6e61e1aff1"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#a2f5080d315f72646f57eda6e61e1aff1">_EPT_HOOKS_CONTEXT::VirtualAddress</a></div><div class="ttdeci">UINT64 VirtualAddress</div><div class="ttdef"><b>Definition</b> DataTypes.h:323</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t_html_afc81b90725dc9bc78a4a7b0cdf5a314b"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#afc81b90725dc9bc78a4a7b0cdf5a314b">_EPT_HOOKS_CONTEXT::PhysicalAddress</a></div><div class="ttdeci">UINT64 PhysicalAddress</div><div class="ttdef"><b>Definition</b> DataTypes.h:322</div></div>
<div class="ttc" id="astruct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s_html"><div class="ttname"><a href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">_HIDDEN_HOOKS_DETOUR_DETAILS</a></div><div class="ttdoc">Details of detours style EPT hooks.</div><div class="ttdef"><b>Definition</b> Hooks.h:74</div></div>
<div class="ttc" id="astruct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s_html_a5b7e945d9dd258586acd7e0268c8f11a"><div class="ttname"><a href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a5b7e945d9dd258586acd7e0268c8f11a">_HIDDEN_HOOKS_DETOUR_DETAILS::HookedFunctionAddress</a></div><div class="ttdeci">PVOID HookedFunctionAddress</div><div class="ttdef"><b>Definition</b> Hooks.h:76</div></div>
<div class="ttc" id="astruct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s_html_a89757e40877fd300bf09ab3b45642f28"><div class="ttname"><a href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a89757e40877fd300bf09ab3b45642f28">_HIDDEN_HOOKS_DETOUR_DETAILS::ReturnAddress</a></div><div class="ttdeci">PVOID ReturnAddress</div><div class="ttdef"><b>Definition</b> Hooks.h:77</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html">_VIRTUAL_MACHINE_STATE</a></div><div class="ttdoc">The status of each core after and before VMX.</div><div class="ttdef"><b>Definition</b> State.h:290</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_aae00ab92fdce5f90e65edb3bd10ae696"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aae00ab92fdce5f90e65edb3bd10ae696">_VIRTUAL_MACHINE_STATE::Regs</a></div><div class="ttdeci">GUEST_REGS * Regs</div><div class="ttdef"><b>Definition</b> State.h:305</div></div>
<div class="ttc" id="astruct_g_u_e_s_t___r_e_g_s_html"><div class="ttname"><a href="struct_g_u_e_s_t___r_e_g_s.html">GUEST_REGS</a></div><div class="ttdef"><b>Definition</b> BasicTypes.h:70</div></div>
<div class="ttc" id="astruct_g_u_e_s_t___r_e_g_s_html_a04918d3fe8010c01a6bd3f1ba4e11bc2"><div class="ttname"><a href="struct_g_u_e_s_t___r_e_g_s.html#a04918d3fe8010c01a6bd3f1ba4e11bc2">GUEST_REGS::rsp</a></div><div class="ttdeci">UINT64 rsp</div><div class="ttdef"><b>Definition</b> BasicTypes.h:79</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="abb1bb8e5caaed9c63ffcfad80a2d0ebd" name="abb1bb8e5caaed9c63ffcfad80a2d0ebd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abb1bb8e5caaed9c63ffcfad80a2d0ebd">&#9670;&#160;</a></span>EptHookAllocateExtraHookingPagesForMemoryMonitorsAndExecEptHooks()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookAllocateExtraHookingPagesForMemoryMonitorsAndExecEptHooks </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>Count</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Allocate (reserve) extra pages for storing details of page hooks for memory monitor and regular hidden breakpoit exec EPT hooks. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Count</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  111</span>{</div>
<div class="line"><span class="lineno">  112</span>    <a class="code hl_typedef" href="_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ProcessorsCount;</div>
<div class="line"><span class="lineno">  113</span> </div>
<div class="line"><span class="lineno">  114</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  115</span>    <span class="comment">// Get number of processors</span></div>
<div class="line"><span class="lineno">  116</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  117</span>    ProcessorsCount = KeQueryActiveProcessorCount(0);</div>
<div class="line"><span class="lineno">  118</span> </div>
<div class="line"><span class="lineno">  119</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  120</span>    <span class="comment">// Request pages to be allocated for converting 2MB to 4KB pages</span></div>
<div class="line"><span class="lineno">  121</span>    <span class="comment">// Each core needs its own splitting page-tables</span></div>
<div class="line"><span class="lineno">  122</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  123</span>    <a class="code hl_function" href="_pool_manager_8c.html#a3660fd340db1240d410e847fb1ffe3d8">PoolManagerRequestAllocation</a>(<span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t.html">VMM_EPT_DYNAMIC_SPLIT</a>),</div>
<div class="line"><span class="lineno">  124</span>                                 Count * ProcessorsCount,</div>
<div class="line"><span class="lineno">  125</span>                                 <a class="code hl_enumvalue" href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a09f33e69ad8e184c21efd29fa2fe7380">SPLIT_2MB_PAGING_TO_4KB_PAGE</a>);</div>
<div class="line"><span class="lineno">  126</span> </div>
<div class="line"><span class="lineno">  127</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  128</span>    <span class="comment">// Request pages to be allocated for paged hook details</span></div>
<div class="line"><span class="lineno">  129</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  130</span>    <a class="code hl_function" href="_pool_manager_8c.html#a3660fd340db1240d410e847fb1ffe3d8">PoolManagerRequestAllocation</a>(<span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>),</div>
<div class="line"><span class="lineno">  131</span>                                 Count,</div>
<div class="line"><span class="lineno">  132</span>                                 <a class="code hl_enumvalue" href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a1c4249f84cf779cd4cdd72ee27de08c1">TRACKING_HOOKED_PAGES</a>);</div>
<div class="line"><span class="lineno">  133</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_af632da489ebc3708ec3ab6791ee53fa4"><div class="ttname"><a href="_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></div><div class="ttdeci">unsigned long ULONG</div><div class="ttdef"><b>Definition</b> BasicTypes.h:37</div></div>
<div class="ttc" id="a_data_types_8h_html_ad130f0bae4db97169873223d0aad9a63a09f33e69ad8e184c21efd29fa2fe7380"><div class="ttname"><a href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a09f33e69ad8e184c21efd29fa2fe7380">SPLIT_2MB_PAGING_TO_4KB_PAGE</a></div><div class="ttdeci">@ SPLIT_2MB_PAGING_TO_4KB_PAGE</div><div class="ttdef"><b>Definition</b> DataTypes.h:43</div></div>
<div class="ttc" id="a_data_types_8h_html_ad130f0bae4db97169873223d0aad9a63a1c4249f84cf779cd4cdd72ee27de08c1"><div class="ttname"><a href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a1c4249f84cf779cd4cdd72ee27de08c1">TRACKING_HOOKED_PAGES</a></div><div class="ttdeci">@ TRACKING_HOOKED_PAGES</div><div class="ttdef"><b>Definition</b> DataTypes.h:41</div></div>
<div class="ttc" id="a_pool_manager_8c_html_a3660fd340db1240d410e847fb1ffe3d8"><div class="ttname"><a href="_pool_manager_8c.html#a3660fd340db1240d410e847fb1ffe3d8">PoolManagerRequestAllocation</a></div><div class="ttdeci">BOOLEAN PoolManagerRequestAllocation(SIZE_T Size, UINT32 Count, POOL_ALLOCATION_INTENTION Intention)</div><div class="ttdoc">Request to allocate new buffers.</div><div class="ttdef"><b>Definition</b> PoolManager.c:415</div></div>
<div class="ttc" id="astruct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t_html"><div class="ttname"><a href="struct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t.html">_VMM_EPT_DYNAMIC_SPLIT</a></div><div class="ttdoc">Split 2MB granularity to 4 KB granularity.</div><div class="ttdef"><b>Definition</b> Ept.h:135</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1d3773a49e29eaf03835b7a064817646" name="a1d3773a49e29eaf03835b7a064817646"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1d3773a49e29eaf03835b7a064817646">&#9670;&#160;</a></span>EptHookFromVmxRoot()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookFromVmxRoot </td>
          <td>(</td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>TargetAddress</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function invokes a direct VMCALL to setup the hook. </p>
<p>the caller of this function should make sure to 1) broadcast to all cores to intercept breakpoints (#BPs) and after calling this function 2) the caller should broadcast to all cores to invalidate their EPTPs This function should be called from VMX root-mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  632</span>{</div>
<div class="line"><span class="lineno">  633</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  634</span>    <span class="comment">// Should be called from VMX root-mode</span></div>
<div class="line"><span class="lineno">  635</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  636</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno">  637</span>    {</div>
<div class="line"><span class="lineno">  638</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  639</span>    }</div>
<div class="line"><span class="lineno">  640</span> </div>
<div class="line"><span class="lineno">  641</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="#acb85a5366d63e1484261f3c32dfb4f64">EptHookPerformHook</a>(TargetAddress, <a class="code hl_define" href="_basic_types_8h.html#a32ab457827837bf5ac123dd0fd8326ae">NULL_ZERO</a>, <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div>
<div class="line"><span class="lineno">  642</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_a32ab457827837bf5ac123dd0fd8326ae"><div class="ttname"><a href="_basic_types_8h.html#a32ab457827837bf5ac123dd0fd8326ae">NULL_ZERO</a></div><div class="ttdeci">#define NULL_ZERO</div><div class="ttdef"><b>Definition</b> BasicTypes.h:51</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="acd0179b7c5730f636141dfea2afcdc5a" name="acd0179b7c5730f636141dfea2afcdc5a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acd0179b7c5730f636141dfea2afcdc5a">&#9670;&#160;</a></span>EptHookGetCountOfEpthooks()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> EptHookGetCountOfEpthooks </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></td>          <td class="paramname"><span class="paramname"><em>IsEptHook2</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>get the length of active EPT hooks (!epthook and !epthook2) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">IsEptHook2</td><td>Whether the length should be for !epthook or !epthook2</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT32 Count of remained breakpoints </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1866</span>{</div>
<div class="line"><span class="lineno"> 1867</span>    <a class="code hl_typedef" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> Count = 0;</div>
<div class="line"><span class="lineno"> 1868</span> </div>
<div class="line"><span class="lineno"> 1869</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList, HookedEntry)</div>
<div class="line"><span class="lineno"> 1870</span>    {</div>
<div class="line"><span class="lineno"> 1871</span>        <span class="keywordflow">if</span> (IsEptHook2)</div>
<div class="line"><span class="lineno"> 1872</span>        {</div>
<div class="line"><span class="lineno"> 1873</span>            <span class="keywordflow">if</span> (HookedEntry-&gt;IsHiddenBreakpoint == <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno"> 1874</span>            {</div>
<div class="line"><span class="lineno"> 1875</span>                Count++;</div>
<div class="line"><span class="lineno"> 1876</span>            }</div>
<div class="line"><span class="lineno"> 1877</span>        }</div>
<div class="line"><span class="lineno"> 1878</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1879</span>        {</div>
<div class="line"><span class="lineno"> 1880</span>            <span class="keywordflow">if</span> (HookedEntry-&gt;IsHiddenBreakpoint == <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 1881</span>            {</div>
<div class="line"><span class="lineno"> 1882</span>                Count++;</div>
<div class="line"><span class="lineno"> 1883</span>            }</div>
<div class="line"><span class="lineno"> 1884</span>        }</div>
<div class="line"><span class="lineno"> 1885</span>    }</div>
<div class="line"><span class="lineno"> 1886</span> </div>
<div class="line"><span class="lineno"> 1887</span>    <span class="keywordflow">return</span> Count;</div>
<div class="line"><span class="lineno"> 1888</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_ae1e6edbbc26d6fbc71a90190d0266018"><div class="ttname"><a href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></div><div class="ttdeci">unsigned int UINT32</div><div class="ttdef"><b>Definition</b> BasicTypes.h:48</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a47fe46d2ddd86f75aeeeeaa38fafe3eb" name="a47fe46d2ddd86f75aeeeeaa38fafe3eb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a47fe46d2ddd86f75aeeeeaa38fafe3eb">&#9670;&#160;</a></span>EptHookHandleHookedPage()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookHandleHookedPage </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#a2ef230620f7c5617f62c8022159293fb">EPT_HOOKED_PAGE_DETAIL</a> *</td>          <td class="paramname"><span class="paramname"><em>HookedEntryDetails</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">VMX_EXIT_QUALIFICATION_EPT_VIOLATION</td>          <td class="paramname"><span class="paramname"><em>ViolationQualification</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SIZE_T</td>          <td class="paramname"><span class="paramname"><em>PhysicalAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_data_types_8h.html#a732f5fb65b66d5b23321a9b1c69e64d1">EPT_HOOKS_CONTEXT</a> *</td>          <td class="paramname"><span class="paramname"><em>LastContext</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> *</td>          <td class="paramname"><span class="paramname"><em>IgnoreReadOrWriteOrExec</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> *</td>          <td class="paramname"><span class="paramname"><em>IsExecViolation</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Handles page hooks (trigger events) </p>
<p>Handle hooked pages in Vmx-root mode.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">HookedEntryDetails</td><td>The entry that describes the hooked page </td></tr>
    <tr><td class="paramname">ViolationQualification</td><td>The exit qualification of vm-exit </td></tr>
    <tr><td class="paramname">PhysicalAddress</td><td>The physical address that cause this vm-exit </td></tr>
    <tr><td class="paramname">LastContext</td><td>The last (current) context of the execution </td></tr>
    <tr><td class="paramname">IgnoreReadOrWriteOrExec</td><td>Whether to ignore the event effects or not </td></tr>
    <tr><td class="paramname">IsExecViolation</td><td>Whether it's execution violation or not executing the post triggering of the event or not</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns TRUE if the function was hook was handled or returns false if there was an unexpected ept violation </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1693</span>{</div>
<div class="line"><span class="lineno"> 1694</span>    <a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>  ExactAccessedVirtualAddress;</div>
<div class="line"><span class="lineno"> 1695</span>    <a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>  AlignedVirtualAddress;</div>
<div class="line"><span class="lineno"> 1696</span>    <a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>  AlignedPhysicalAddress;</div>
<div class="line"><span class="lineno"> 1697</span>    <a class="code hl_typedef" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsTriggeringPostEventAllowed = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1698</span> </div>
<div class="line"><span class="lineno"> 1699</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1700</span>    <span class="comment">// Get alignment</span></div>
<div class="line"><span class="lineno"> 1701</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1702</span>    AlignedVirtualAddress  = (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_define" href="libhyperdbg_2header_2_common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(HookedEntryDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">VirtualAddress</a>);</div>
<div class="line"><span class="lineno"> 1703</span>    AlignedPhysicalAddress = (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_define" href="libhyperdbg_2header_2_common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(PhysicalAddress);</div>
<div class="line"><span class="lineno"> 1704</span> </div>
<div class="line"><span class="lineno"> 1705</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1706</span>    <span class="comment">// Let&#39;s read the exact address that was accessed</span></div>
<div class="line"><span class="lineno"> 1707</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1708</span>    ExactAccessedVirtualAddress = AlignedVirtualAddress + PhysicalAddress - AlignedPhysicalAddress;</div>
<div class="line"><span class="lineno"> 1709</span> </div>
<div class="line"><span class="lineno"> 1710</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1711</span>    <span class="comment">// Set the last context</span></div>
<div class="line"><span class="lineno"> 1712</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1713</span>    LastContext-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#a126adf6a860749899a8530e2d9605dc9">HookingTag</a>      = HookedEntryDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac39ed4ba1bfdc7f59b54cd3b0675c007">HookingTag</a>;</div>
<div class="line"><span class="lineno"> 1714</span>    LastContext-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#afc81b90725dc9bc78a4a7b0cdf5a314b">PhysicalAddress</a> = PhysicalAddress;</div>
<div class="line"><span class="lineno"> 1715</span>    LastContext-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#a2f5080d315f72646f57eda6e61e1aff1">VirtualAddress</a>  = ExactAccessedVirtualAddress;</div>
<div class="line"><span class="lineno"> 1716</span> </div>
<div class="line"><span class="lineno"> 1717</span>    <span class="keywordflow">if</span> (!ViolationQualification.EptReadable &amp;&amp; ViolationQualification.ReadAccess)</div>
<div class="line"><span class="lineno"> 1718</span>    {</div>
<div class="line"><span class="lineno"> 1719</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1720</span>        <span class="comment">// LogInfo(&quot;Guest RIP : 0x%llx tries to read the page at : 0x%llx&quot;, GuestRip, ExactAccessedAddress);</span></div>
<div class="line"><span class="lineno"> 1721</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1722</span> </div>
<div class="line"><span class="lineno"> 1723</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1724</span>        <span class="comment">// Set last violation</span></div>
<div class="line"><span class="lineno"> 1725</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1726</span>        HookedEntryDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afd0c818e0a415c2705cc35d41bd9353c">LastViolation</a> = <a class="code hl_enumvalue" href="hyperhv_2header_2common_2_state_8h.html#a2aae817402261f30cbfd9de3d9d220d4a7849d04c368acecf4949a278bff19813">EPT_HOOKED_LAST_VIOLATION_READ</a>;</div>
<div class="line"><span class="lineno"> 1727</span> </div>
<div class="line"><span class="lineno"> 1728</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1729</span>        <span class="comment">// Trigger the event related to Monitor Read and Monitor Read &amp; Write and</span></div>
<div class="line"><span class="lineno"> 1730</span>        <span class="comment">// Monitor Read &amp; Execute and Monitor Read &amp; Write &amp; Execute</span></div>
<div class="line"><span class="lineno"> 1731</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1732</span>        *IgnoreReadOrWriteOrExec = <a class="code hl_function" href="_dispatch_8c.html#aebd5f93678619ac6e74debd886d42988">DispatchEventHiddenHookPageReadWriteExecuteReadPreEvent</a>(VCpu, LastContext, &amp;IsTriggeringPostEventAllowed);</div>
<div class="line"><span class="lineno"> 1733</span> </div>
<div class="line"><span class="lineno"> 1734</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1735</span>        <span class="comment">// It&#39;s not an execution violation</span></div>
<div class="line"><span class="lineno"> 1736</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1737</span>        *IsExecViolation = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1738</span>    }</div>
<div class="line"><span class="lineno"> 1739</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ViolationQualification.EptWriteable &amp;&amp; ViolationQualification.WriteAccess)</div>
<div class="line"><span class="lineno"> 1740</span>    {</div>
<div class="line"><span class="lineno"> 1741</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1742</span>        <span class="comment">// LogInfo(&quot;Guest RIP : 0x%llx tries to write on the page at : 0x%llx&quot;, GuestRip, ExactAccessedAddress);</span></div>
<div class="line"><span class="lineno"> 1743</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1744</span> </div>
<div class="line"><span class="lineno"> 1745</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1746</span>        <span class="comment">// Set last violation</span></div>
<div class="line"><span class="lineno"> 1747</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1748</span>        HookedEntryDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afd0c818e0a415c2705cc35d41bd9353c">LastViolation</a> = <a class="code hl_enumvalue" href="hyperhv_2header_2common_2_state_8h.html#a2aae817402261f30cbfd9de3d9d220d4ade23221c074c645b6b52fa926924b98e">EPT_HOOKED_LAST_VIOLATION_WRITE</a>;</div>
<div class="line"><span class="lineno"> 1749</span> </div>
<div class="line"><span class="lineno"> 1750</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1751</span>        <span class="comment">// Trigger the event related to Monitor Write and Monitor Read &amp; Write and</span></div>
<div class="line"><span class="lineno"> 1752</span>        <span class="comment">// Monitor Write &amp; Execute and Monitor Read &amp; Write &amp; Execute</span></div>
<div class="line"><span class="lineno"> 1753</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1754</span>        *IgnoreReadOrWriteOrExec = <a class="code hl_function" href="_dispatch_8c.html#a3afed71e259f9f6c1e0524317b391cb2">DispatchEventHiddenHookPageReadWriteExecuteWritePreEvent</a>(VCpu, LastContext, &amp;IsTriggeringPostEventAllowed);</div>
<div class="line"><span class="lineno"> 1755</span> </div>
<div class="line"><span class="lineno"> 1756</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1757</span>        <span class="comment">// It&#39;s not an execution violation</span></div>
<div class="line"><span class="lineno"> 1758</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1759</span>        *IsExecViolation = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1760</span>    }</div>
<div class="line"><span class="lineno"> 1761</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ViolationQualification.EptExecutable &amp;&amp; ViolationQualification.ExecuteAccess)</div>
<div class="line"><span class="lineno"> 1762</span>    {</div>
<div class="line"><span class="lineno"> 1763</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1764</span>        <span class="comment">// LogInfo(&quot;Guest RIP : 0x%llx tries to execute the page at : 0x%llx&quot;, GuestRip, ExactAccessedAddress);</span></div>
<div class="line"><span class="lineno"> 1765</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1766</span> </div>
<div class="line"><span class="lineno"> 1767</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1768</span>        <span class="comment">// Set last violation</span></div>
<div class="line"><span class="lineno"> 1769</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1770</span>        HookedEntryDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afd0c818e0a415c2705cc35d41bd9353c">LastViolation</a> = <a class="code hl_enumvalue" href="hyperhv_2header_2common_2_state_8h.html#a2aae817402261f30cbfd9de3d9d220d4ac536284d0d986169d289419b36822c3a">EPT_HOOKED_LAST_VIOLATION_EXEC</a>;</div>
<div class="line"><span class="lineno"> 1771</span> </div>
<div class="line"><span class="lineno"> 1772</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1773</span>        <span class="comment">// Trigger the event related to Monitor Execute and Monitor Read &amp; Execute and</span></div>
<div class="line"><span class="lineno"> 1774</span>        <span class="comment">// Monitor Write &amp; Execute and Monitor Read &amp; Write &amp; Execute</span></div>
<div class="line"><span class="lineno"> 1775</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1776</span>        *IgnoreReadOrWriteOrExec = <a class="code hl_function" href="_dispatch_8c.html#a85600db927f918baefeec1d3d03b84da">DispatchEventHiddenHookPageReadWriteExecuteExecutePreEvent</a>(VCpu, LastContext, &amp;IsTriggeringPostEventAllowed);</div>
<div class="line"><span class="lineno"> 1777</span> </div>
<div class="line"><span class="lineno"> 1778</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1779</span>        <span class="comment">// It&#39;s an execution violation</span></div>
<div class="line"><span class="lineno"> 1780</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1781</span>        *IsExecViolation = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1782</span>    }</div>
<div class="line"><span class="lineno"> 1783</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1784</span>    {</div>
<div class="line"><span class="lineno"> 1785</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1786</span>        <span class="comment">// triggering post event is not allowed as it&#39;s not valid</span></div>
<div class="line"><span class="lineno"> 1787</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1788</span>        HookedEntryDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ad458b314b35c4f269cb7998b04ab28ea">IsPostEventTriggerAllowed</a> = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1789</span> </div>
<div class="line"><span class="lineno"> 1790</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1791</span>        <span class="comment">// there was an unexpected ept violation</span></div>
<div class="line"><span class="lineno"> 1792</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1793</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1794</span>    }</div>
<div class="line"><span class="lineno"> 1795</span> </div>
<div class="line"><span class="lineno"> 1796</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1797</span>    <span class="comment">// Set whether the post event trigger is allowed or not</span></div>
<div class="line"><span class="lineno"> 1798</span>    <span class="comment">// If only one event short-circuit a special EPT hook the &#39;post&#39; mode will be ignored for all of the same events</span></div>
<div class="line"><span class="lineno"> 1799</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1800</span>    <span class="keywordflow">if</span> (*IgnoreReadOrWriteOrExec == <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno"> 1801</span>    {</div>
<div class="line"><span class="lineno"> 1802</span>        HookedEntryDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ad458b314b35c4f269cb7998b04ab28ea">IsPostEventTriggerAllowed</a> = IsTriggeringPostEventAllowed;</div>
<div class="line"><span class="lineno"> 1803</span>    }</div>
<div class="line"><span class="lineno"> 1804</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1805</span>    {</div>
<div class="line"><span class="lineno"> 1806</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1807</span>        <span class="comment">// Ignoring read/write/exec will remove the &#39;post&#39; event</span></div>
<div class="line"><span class="lineno"> 1808</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1809</span>        HookedEntryDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ad458b314b35c4f269cb7998b04ab28ea">IsPostEventTriggerAllowed</a> = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1810</span>    }</div>
<div class="line"><span class="lineno"> 1811</span> </div>
<div class="line"><span class="lineno"> 1812</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1813</span>    <span class="comment">// Means that restore the Entry to the previous state after current</span></div>
<div class="line"><span class="lineno"> 1814</span>    <span class="comment">// instruction executed in the guest</span></div>
<div class="line"><span class="lineno"> 1815</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1816</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1817</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_a1cb18096b299d23458d3c7b85fd86555"><div class="ttname"><a href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div><div class="ttdeci">UCHAR BOOLEAN</div><div class="ttdef"><b>Definition</b> BasicTypes.h:39</div></div>
<div class="ttc" id="a_dispatch_8c_html_a3afed71e259f9f6c1e0524317b391cb2"><div class="ttname"><a href="_dispatch_8c.html#a3afed71e259f9f6c1e0524317b391cb2">DispatchEventHiddenHookPageReadWriteExecuteWritePreEvent</a></div><div class="ttdeci">BOOLEAN DispatchEventHiddenHookPageReadWriteExecuteWritePreEvent(VIRTUAL_MACHINE_STATE *VCpu, PVOID Context, BOOLEAN *IsTriggeringPostEventAllowed)</div><div class="ttdoc">Handling debugger functions related to read &amp; write &amp; execute, write events (pre)</div><div class="ttdef"><b>Definition</b> Dispatch.c:1102</div></div>
<div class="ttc" id="a_dispatch_8c_html_a85600db927f918baefeec1d3d03b84da"><div class="ttname"><a href="_dispatch_8c.html#a85600db927f918baefeec1d3d03b84da">DispatchEventHiddenHookPageReadWriteExecuteExecutePreEvent</a></div><div class="ttdeci">BOOLEAN DispatchEventHiddenHookPageReadWriteExecuteExecutePreEvent(VIRTUAL_MACHINE_STATE *VCpu, PVOID Context, BOOLEAN *IsTriggeringPostEventAllowed)</div><div class="ttdoc">Handling debugger functions related to read &amp; write &amp; execute, execute events (pre)</div><div class="ttdef"><b>Definition</b> Dispatch.c:1196</div></div>
<div class="ttc" id="a_dispatch_8c_html_aebd5f93678619ac6e74debd886d42988"><div class="ttname"><a href="_dispatch_8c.html#aebd5f93678619ac6e74debd886d42988">DispatchEventHiddenHookPageReadWriteExecuteReadPreEvent</a></div><div class="ttdeci">BOOLEAN DispatchEventHiddenHookPageReadWriteExecuteReadPreEvent(VIRTUAL_MACHINE_STATE *VCpu, PVOID Context, BOOLEAN *IsTriggeringPostEventAllowed)</div><div class="ttdoc">Handling debugger functions related to read &amp; write &amp; execute, read events (pre)</div><div class="ttdef"><b>Definition</b> Dispatch.c:1008</div></div>
<div class="ttc" id="ahyperhv_2header_2common_2_state_8h_html_a2aae817402261f30cbfd9de3d9d220d4a7849d04c368acecf4949a278bff19813"><div class="ttname"><a href="hyperhv_2header_2common_2_state_8h.html#a2aae817402261f30cbfd9de3d9d220d4a7849d04c368acecf4949a278bff19813">EPT_HOOKED_LAST_VIOLATION_READ</a></div><div class="ttdeci">@ EPT_HOOKED_LAST_VIOLATION_READ</div><div class="ttdef"><b>Definition</b> State.h:64</div></div>
<div class="ttc" id="ahyperhv_2header_2common_2_state_8h_html_a2aae817402261f30cbfd9de3d9d220d4ac536284d0d986169d289419b36822c3a"><div class="ttname"><a href="hyperhv_2header_2common_2_state_8h.html#a2aae817402261f30cbfd9de3d9d220d4ac536284d0d986169d289419b36822c3a">EPT_HOOKED_LAST_VIOLATION_EXEC</a></div><div class="ttdeci">@ EPT_HOOKED_LAST_VIOLATION_EXEC</div><div class="ttdef"><b>Definition</b> State.h:66</div></div>
<div class="ttc" id="ahyperhv_2header_2common_2_state_8h_html_a2aae817402261f30cbfd9de3d9d220d4ade23221c074c645b6b52fa926924b98e"><div class="ttname"><a href="hyperhv_2header_2common_2_state_8h.html#a2aae817402261f30cbfd9de3d9d220d4ade23221c074c645b6b52fa926924b98e">EPT_HOOKED_LAST_VIOLATION_WRITE</a></div><div class="ttdeci">@ EPT_HOOKED_LAST_VIOLATION_WRITE</div><div class="ttdef"><b>Definition</b> State.h:65</div></div>
<div class="ttc" id="alibhyperdbg_2header_2_common_8h_html_aa02188de52b66a3aa5e1aecc6bd963ae"><div class="ttname"><a href="libhyperdbg_2header_2_common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a></div><div class="ttdeci">#define PAGE_ALIGN(Va)</div><div class="ttdoc">Aligning a page.</div><div class="ttdef"><b>Definition</b> common.h:75</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a3464acbaf76a38d67558d8ff3bee342f"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">_EPT_HOOKED_PAGE_DETAIL::VirtualAddress</a></div><div class="ttdeci">UINT64 VirtualAddress</div><div class="ttdoc">The virtual address from the caller perspective view (cr3)</div><div class="ttdef"><b>Definition</b> State.h:175</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_ac39ed4ba1bfdc7f59b54cd3b0675c007"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac39ed4ba1bfdc7f59b54cd3b0675c007">_EPT_HOOKED_PAGE_DETAIL::HookingTag</a></div><div class="ttdeci">UINT64 HookingTag</div><div class="ttdoc">Tag used for notifying the caller.</div><div class="ttdef"><b>Definition</b> State.h:202</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_ad458b314b35c4f269cb7998b04ab28ea"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ad458b314b35c4f269cb7998b04ab28ea">_EPT_HOOKED_PAGE_DETAIL::IsPostEventTriggerAllowed</a></div><div class="ttdeci">BOOLEAN IsPostEventTriggerAllowed</div><div class="ttdoc">This field shows whether the hook should call the post event trigger after restoring the state or not...</div><div class="ttdef"><b>Definition</b> State.h:248</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_afd0c818e0a415c2705cc35d41bd9353c"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afd0c818e0a415c2705cc35d41bd9353c">_EPT_HOOKED_PAGE_DETAIL::LastViolation</a></div><div class="ttdeci">EPT_HOOKED_LAST_VIOLATION LastViolation</div><div class="ttdoc">This field shows the last violation happened to this EPT hook.</div><div class="ttdef"><b>Definition</b> State.h:253</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t_html_a126adf6a860749899a8530e2d9605dc9"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#a126adf6a860749899a8530e2d9605dc9">_EPT_HOOKS_CONTEXT::HookingTag</a></div><div class="ttdeci">UINT64 HookingTag</div><div class="ttdef"><b>Definition</b> DataTypes.h:321</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a20926ad378e67d34368b5a8cd6306ad5" name="a20926ad378e67d34368b5a8cd6306ad5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a20926ad378e67d34368b5a8cd6306ad5">&#9670;&#160;</a></span>EptHookHandleMonitorTrapFlag()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookHandleMonitorTrapFlag </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Handle vm-exits for Monitor Trap Flag to restore previous state. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1964</span>{</div>
<div class="line"><span class="lineno"> 1965</span>    PVOID TargetPage;</div>
<div class="line"><span class="lineno"> 1966</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1967</span>    <span class="comment">// Pointer to the page entry in the page table</span></div>
<div class="line"><span class="lineno"> 1968</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1969</span>    TargetPage = <a class="code hl_function" href="_ept_8c.html#aca998ecbfe4b433dbb307e5ab1fbcc41">EptGetPml1Entry</a>(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a1146a24bffa5a804261021a69cf0a00d">EptPageTable</a>, VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a9b2af0257a3f605df8780f3a62be01cf">MtfEptHookRestorePoint</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a>);</div>
<div class="line"><span class="lineno"> 1970</span> </div>
<div class="line"><span class="lineno"> 1971</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1972</span>    <span class="comment">// restore the hooked state</span></div>
<div class="line"><span class="lineno"> 1973</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1974</span>    <a class="code hl_function" href="_ept_8c.html#af587165cde98b98b7e5c2c2cc826757c">EptSetPML1AndInvalidateTLB</a>(VCpu,</div>
<div class="line"><span class="lineno"> 1975</span>                               TargetPage,</div>
<div class="line"><span class="lineno"> 1976</span>                               VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a9b2af0257a3f605df8780f3a62be01cf">MtfEptHookRestorePoint</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a87563a62e848638473d980314b01d28b">ChangedEntry</a>,</div>
<div class="line"><span class="lineno"> 1977</span>                               InveptSingleContext);</div>
<div class="line"><span class="lineno"> 1978</span> </div>
<div class="line"><span class="lineno"> 1979</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1980</span>    <span class="comment">// Check to trigger the post event (for events relating the !monitor command</span></div>
<div class="line"><span class="lineno"> 1981</span>    <span class="comment">// and the emulation hardware debug registers)</span></div>
<div class="line"><span class="lineno"> 1982</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1983</span>    <span class="keywordflow">if</span> (VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a9b2af0257a3f605df8780f3a62be01cf">MtfEptHookRestorePoint</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ad458b314b35c4f269cb7998b04ab28ea">IsPostEventTriggerAllowed</a>)</div>
<div class="line"><span class="lineno"> 1984</span>    {</div>
<div class="line"><span class="lineno"> 1985</span>        <span class="keywordflow">if</span> (VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a9b2af0257a3f605df8780f3a62be01cf">MtfEptHookRestorePoint</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afd0c818e0a415c2705cc35d41bd9353c">LastViolation</a> == <a class="code hl_enumvalue" href="hyperhv_2header_2common_2_state_8h.html#a2aae817402261f30cbfd9de3d9d220d4a7849d04c368acecf4949a278bff19813">EPT_HOOKED_LAST_VIOLATION_READ</a>)</div>
<div class="line"><span class="lineno"> 1986</span>        {</div>
<div class="line"><span class="lineno"> 1987</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1988</span>            <span class="comment">// This is a &quot;read&quot; hook</span></div>
<div class="line"><span class="lineno"> 1989</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1990</span>            <a class="code hl_function" href="_dispatch_8c.html#a4e48998eb9fc107f98f9759b9b323e0c">DispatchEventHiddenHookPageReadWriteExecReadPostEvent</a>(VCpu,</div>
<div class="line"><span class="lineno"> 1991</span>                                                                  &amp;VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a9b2af0257a3f605df8780f3a62be01cf">MtfEptHookRestorePoint</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a59fdf10619377cfa0697486767d1ed81">LastContextState</a>);</div>
<div class="line"><span class="lineno"> 1992</span>        }</div>
<div class="line"><span class="lineno"> 1993</span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a9b2af0257a3f605df8780f3a62be01cf">MtfEptHookRestorePoint</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afd0c818e0a415c2705cc35d41bd9353c">LastViolation</a> == <a class="code hl_enumvalue" href="hyperhv_2header_2common_2_state_8h.html#a2aae817402261f30cbfd9de3d9d220d4ade23221c074c645b6b52fa926924b98e">EPT_HOOKED_LAST_VIOLATION_WRITE</a>)</div>
<div class="line"><span class="lineno"> 1994</span>        {</div>
<div class="line"><span class="lineno"> 1995</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1996</span>            <span class="comment">// This is a &quot;write&quot; hook</span></div>
<div class="line"><span class="lineno"> 1997</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1998</span>            <a class="code hl_function" href="_dispatch_8c.html#a6b479b4139a23747b75523910f9b9417">DispatchEventHiddenHookPageReadWriteExecWritePostEvent</a>(VCpu,</div>
<div class="line"><span class="lineno"> 1999</span>                                                                   &amp;VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a9b2af0257a3f605df8780f3a62be01cf">MtfEptHookRestorePoint</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a59fdf10619377cfa0697486767d1ed81">LastContextState</a>);</div>
<div class="line"><span class="lineno"> 2000</span>        }</div>
<div class="line"><span class="lineno"> 2001</span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a9b2af0257a3f605df8780f3a62be01cf">MtfEptHookRestorePoint</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afd0c818e0a415c2705cc35d41bd9353c">LastViolation</a> == <a class="code hl_enumvalue" href="hyperhv_2header_2common_2_state_8h.html#a2aae817402261f30cbfd9de3d9d220d4ac536284d0d986169d289419b36822c3a">EPT_HOOKED_LAST_VIOLATION_EXEC</a>)</div>
<div class="line"><span class="lineno"> 2002</span>        {</div>
<div class="line"><span class="lineno"> 2003</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2004</span>            <span class="comment">// This is a &quot;execute&quot; hook</span></div>
<div class="line"><span class="lineno"> 2005</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2006</span>            <a class="code hl_function" href="_dispatch_8c.html#ab78373fcc45e3dc72db25e4475bbff24">DispatchEventHiddenHookPageReadWriteExecExecutePostEvent</a>(VCpu,</div>
<div class="line"><span class="lineno"> 2007</span>                                                                     &amp;VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a9b2af0257a3f605df8780f3a62be01cf">MtfEptHookRestorePoint</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a59fdf10619377cfa0697486767d1ed81">LastContextState</a>);</div>
<div class="line"><span class="lineno"> 2008</span>        }</div>
<div class="line"><span class="lineno"> 2009</span>    }</div>
<div class="line"><span class="lineno"> 2010</span> </div>
<div class="line"><span class="lineno"> 2011</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2012</span>    <span class="comment">// Check for user-mode attaching mechanisms and callback</span></div>
<div class="line"><span class="lineno"> 2013</span>    <span class="comment">// (we call it here, because this callback might change the EPTP entries and invalidate EPTP)</span></div>
<div class="line"><span class="lineno"> 2014</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2015</span>    <a class="code hl_function" href="_callback_8c.html#a572ff09ec55a935fa9384ed06f85e02e">VmmCallbackRestoreEptState</a>(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#ad166851f334095bff309813f73ea394e">CoreId</a>);</div>
<div class="line"><span class="lineno"> 2016</span>}</div>
<div class="ttc" id="a_callback_8c_html_a572ff09ec55a935fa9384ed06f85e02e"><div class="ttname"><a href="_callback_8c.html#a572ff09ec55a935fa9384ed06f85e02e">VmmCallbackRestoreEptState</a></div><div class="ttdeci">BOOLEAN VmmCallbackRestoreEptState(UINT32 CoreId)</div><div class="ttdoc">routine callback to restore EPT state</div><div class="ttdef"><b>Definition</b> Callback.c:294</div></div>
<div class="ttc" id="a_dispatch_8c_html_a4e48998eb9fc107f98f9759b9b323e0c"><div class="ttname"><a href="_dispatch_8c.html#a4e48998eb9fc107f98f9759b9b323e0c">DispatchEventHiddenHookPageReadWriteExecReadPostEvent</a></div><div class="ttdeci">VOID DispatchEventHiddenHookPageReadWriteExecReadPostEvent(VIRTUAL_MACHINE_STATE *VCpu, PVOID Context)</div><div class="ttdoc">Handling debugger functions related to read &amp; write &amp; execute, read events (post)</div><div class="ttdef"><b>Definition</b> Dispatch.c:1289</div></div>
<div class="ttc" id="a_dispatch_8c_html_a6b479b4139a23747b75523910f9b9417"><div class="ttname"><a href="_dispatch_8c.html#a6b479b4139a23747b75523910f9b9417">DispatchEventHiddenHookPageReadWriteExecWritePostEvent</a></div><div class="ttdeci">VOID DispatchEventHiddenHookPageReadWriteExecWritePostEvent(VIRTUAL_MACHINE_STATE *VCpu, PVOID Context)</div><div class="ttdoc">Handling debugger functions related to read &amp; write &amp; execute, write events (post)</div><div class="ttdef"><b>Definition</b> Dispatch.c:1336</div></div>
<div class="ttc" id="a_dispatch_8c_html_ab78373fcc45e3dc72db25e4475bbff24"><div class="ttname"><a href="_dispatch_8c.html#ab78373fcc45e3dc72db25e4475bbff24">DispatchEventHiddenHookPageReadWriteExecExecutePostEvent</a></div><div class="ttdeci">VOID DispatchEventHiddenHookPageReadWriteExecExecutePostEvent(VIRTUAL_MACHINE_STATE *VCpu, PVOID Context)</div><div class="ttdoc">Handling debugger functions related to read &amp; write &amp; execute, execute events (post)</div><div class="ttdef"><b>Definition</b> Dispatch.c:1381</div></div>
<div class="ttc" id="a_ept_8c_html_aca998ecbfe4b433dbb307e5ab1fbcc41"><div class="ttname"><a href="_ept_8c.html#aca998ecbfe4b433dbb307e5ab1fbcc41">EptGetPml1Entry</a></div><div class="ttdeci">PEPT_PML1_ENTRY EptGetPml1Entry(PVMM_EPT_PAGE_TABLE EptPageTable, SIZE_T PhysicalAddress)</div><div class="ttdoc">Get the PML1 entry for this physical address if the page is split.</div><div class="ttdef"><b>Definition</b> Ept.c:304</div></div>
<div class="ttc" id="a_ept_8c_html_af587165cde98b98b7e5c2c2cc826757c"><div class="ttname"><a href="_ept_8c.html#af587165cde98b98b7e5c2c2cc826757c">EptSetPML1AndInvalidateTLB</a></div><div class="ttdeci">_Use_decl_annotations_ VOID EptSetPML1AndInvalidateTLB(VIRTUAL_MACHINE_STATE *VCpu, PEPT_PML1_ENTRY EntryAddress, EPT_PML1_ENTRY EntryValue, INVEPT_TYPE InvalidationType)</div><div class="ttdoc">This function set the specific PML1 entry in a spinlock protected area then invalidate the TLB.</div><div class="ttdef"><b>Definition</b> Ept.c:1075</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a59fdf10619377cfa0697486767d1ed81"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a59fdf10619377cfa0697486767d1ed81">_EPT_HOOKED_PAGE_DETAIL::LastContextState</a></div><div class="ttdeci">EPT_HOOKS_CONTEXT LastContextState</div><div class="ttdoc">Temporary context for the post event monitors It shows the context of the last address that triggered...</div><div class="ttdef"><b>Definition</b> State.h:242</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a87563a62e848638473d980314b01d28b"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a87563a62e848638473d980314b01d28b">_EPT_HOOKED_PAGE_DETAIL::ChangedEntry</a></div><div class="ttdeci">EPT_PML1_ENTRY ChangedEntry</div><div class="ttdoc">The original page entry. Will be copied back when the hook is remove from the page.</div><div class="ttdef"><b>Definition</b> State.h:219</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_afb78ebcdb15c9df1fc20831d93203019"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">_EPT_HOOKED_PAGE_DETAIL::PhysicalBaseAddress</a></div><div class="ttdeci">SIZE_T PhysicalBaseAddress</div><div class="ttdoc">The base address of the page. Used to find this structure in the list of page hooks when a hook is hi...</div><div class="ttdef"><b>Definition</b> State.h:187</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a1146a24bffa5a804261021a69cf0a00d"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a1146a24bffa5a804261021a69cf0a00d">_VIRTUAL_MACHINE_STATE::EptPageTable</a></div><div class="ttdeci">PVMM_EPT_PAGE_TABLE EptPageTable</div><div class="ttdef"><b>Definition</b> State.h:342</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a9b2af0257a3f605df8780f3a62be01cf"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a9b2af0257a3f605df8780f3a62be01cf">_VIRTUAL_MACHINE_STATE::MtfEptHookRestorePoint</a></div><div class="ttdeci">PEPT_HOOKED_PAGE_DETAIL MtfEptHookRestorePoint</div><div class="ttdef"><b>Definition</b> State.h:331</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_ad166851f334095bff309813f73ea394e"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#ad166851f334095bff309813f73ea394e">_VIRTUAL_MACHINE_STATE::CoreId</a></div><div class="ttdeci">UINT32 CoreId</div><div class="ttdef"><b>Definition</b> State.h:306</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a2935a49abe92cf51319ef81e20f8ac14" name="a2935a49abe92cf51319ef81e20f8ac14"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2935a49abe92cf51319ef81e20f8ac14">&#9670;&#160;</a></span>EptHookInlineHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookInlineHook </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>TargetAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>HookFunction</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>ProcessId</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function applies EPT hook 2 (inline) to the target EPT table. </p>
<p>Hook in VMX non-root mode (hidden detours)</p>
<p>this function should be called from VMX non-root mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">HookFunction</td><td>The function that will be called when hook triggered </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id to translate based on that process's cr3</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1546</span>{</div>
<div class="line"><span class="lineno"> 1547</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_EPTHOOK2</a> HookingDetail = {0};</div>
<div class="line"><span class="lineno"> 1548</span> </div>
<div class="line"><span class="lineno"> 1549</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1550</span>    <span class="comment">// Should be called from vmx non-root</span></div>
<div class="line"><span class="lineno"> 1551</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1552</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 1553</span>    {</div>
<div class="line"><span class="lineno"> 1554</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1555</span>    }</div>
<div class="line"><span class="lineno"> 1556</span> </div>
<div class="line"><span class="lineno"> 1557</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1558</span>    <span class="comment">// Set the hooking details</span></div>
<div class="line"><span class="lineno"> 1559</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1560</span>    HookingDetail.<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html#a86ce3be9080e5a7a523df38986704b49">TargetAddress</a> = TargetAddress;</div>
<div class="line"><span class="lineno"> 1561</span>    HookingDetail.<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html#a49268184bad5f46f916924c4344e96f5">HookFunction</a>  = HookFunction;</div>
<div class="line"><span class="lineno"> 1562</span> </div>
<div class="line"><span class="lineno"> 1563</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="#a55a664f6c354dacfe2dd66c1ae4415e8">EptHookPerformMemoryOrInlineHook</a>(VCpu,</div>
<div class="line"><span class="lineno"> 1564</span>                                            &amp;HookingDetail,</div>
<div class="line"><span class="lineno"> 1565</span>                                            NULL,</div>
<div class="line"><span class="lineno"> 1566</span>                                            ProcessId,</div>
<div class="line"><span class="lineno"> 1567</span>                                            <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,</div>
<div class="line"><span class="lineno"> 1568</span>                                            <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div>
<div class="line"><span class="lineno"> 1569</span>}</div>
<div class="ttc" id="a_ept_hook_8c_html_a55a664f6c354dacfe2dd66c1ae4415e8"><div class="ttname"><a href="#a55a664f6c354dacfe2dd66c1ae4415e8">EptHookPerformMemoryOrInlineHook</a></div><div class="ttdeci">BOOLEAN EptHookPerformMemoryOrInlineHook(VIRTUAL_MACHINE_STATE *VCpu, EPT_HOOKS_ADDRESS_DETAILS_FOR_EPTHOOK2 *EptHook2AddressDetails, EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR *MemoryAddressDetails, UINT32 ProcessId, BOOLEAN EptHiddenHook2, BOOLEAN ApplyDirectlyFromVmxRoot)</div><div class="ttdoc">This function allocates a buffer in VMX Non Root Mode and then invokes a VMCALL to set the hook.</div><div class="ttdef"><b>Definition</b> EptHook.c:1370</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2_html"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html">_EPT_HOOKS_ADDRESS_DETAILS_FOR_EPTHOOK2</a></div><div class="ttdoc">Setting details for EPT Hooks (!epthook2)</div><div class="ttdef"><b>Definition</b> DataTypes.h:347</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2_html_a49268184bad5f46f916924c4344e96f5"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html#a49268184bad5f46f916924c4344e96f5">_EPT_HOOKS_ADDRESS_DETAILS_FOR_EPTHOOK2::HookFunction</a></div><div class="ttdeci">PVOID HookFunction</div><div class="ttdef"><b>Definition</b> DataTypes.h:349</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2_html_a86ce3be9080e5a7a523df38986704b49"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html#a86ce3be9080e5a7a523df38986704b49">_EPT_HOOKS_ADDRESS_DETAILS_FOR_EPTHOOK2::TargetAddress</a></div><div class="ttdeci">PVOID TargetAddress</div><div class="ttdef"><b>Definition</b> DataTypes.h:348</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a5b9714c9baeabde116049cd66622a00a" name="a5b9714c9baeabde116049cd66622a00a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5b9714c9baeabde116049cd66622a00a">&#9670;&#160;</a></span>EptHookInlineHookFromVmxRoot()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookInlineHookFromVmxRoot </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>TargetAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>HookFunction</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function applies EPT inline to the target EPT table. </p>
<p>Hook in VMX root-mode (hidden detours)</p>
<p>this function should be called from VMX root-mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">HookFunction</td><td>The function that will be called when hook triggered</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1616</span>{</div>
<div class="line"><span class="lineno"> 1617</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_EPTHOOK2</a> HookingDetail = {0};</div>
<div class="line"><span class="lineno"> 1618</span> </div>
<div class="line"><span class="lineno"> 1619</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1620</span>    <span class="comment">// Should be called from vmx root-mode</span></div>
<div class="line"><span class="lineno"> 1621</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1622</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno"> 1623</span>    {</div>
<div class="line"><span class="lineno"> 1624</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1625</span>    }</div>
<div class="line"><span class="lineno"> 1626</span> </div>
<div class="line"><span class="lineno"> 1627</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1628</span>    <span class="comment">// Configure the details</span></div>
<div class="line"><span class="lineno"> 1629</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1630</span>    HookingDetail.<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html#a86ce3be9080e5a7a523df38986704b49">TargetAddress</a> = TargetAddress;</div>
<div class="line"><span class="lineno"> 1631</span>    HookingDetail.<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html#a49268184bad5f46f916924c4344e96f5">HookFunction</a>  = HookFunction;</div>
<div class="line"><span class="lineno"> 1632</span> </div>
<div class="line"><span class="lineno"> 1633</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="#a55a664f6c354dacfe2dd66c1ae4415e8">EptHookPerformMemoryOrInlineHook</a>(VCpu,</div>
<div class="line"><span class="lineno"> 1634</span>                                            &amp;HookingDetail,</div>
<div class="line"><span class="lineno"> 1635</span>                                            NULL,</div>
<div class="line"><span class="lineno"> 1636</span>                                            <a class="code hl_define" href="_basic_types_8h.html#a32ab457827837bf5ac123dd0fd8326ae">NULL_ZERO</a>,</div>
<div class="line"><span class="lineno"> 1637</span>                                            <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,</div>
<div class="line"><span class="lineno"> 1638</span>                                            <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div>
<div class="line"><span class="lineno"> 1639</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a1a97cf8a3d1243edf02539139bbfb617" name="a1a97cf8a3d1243edf02539139bbfb617"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1a97cf8a3d1243edf02539139bbfb617">&#9670;&#160;</a></span>EptHookInstructionMemory()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookInstructionMemory </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a></td>          <td class="paramname"><span class="paramname"><em>Hook</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a></td>          <td class="paramname"><span class="paramname"><em>ProcessCr3</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>TargetFunction</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>TargetFunctionInSafeMemory</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>HookFunction</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Hook instructions. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Hook</td><td>The details of hooked pages </td></tr>
    <tr><td class="paramname">ProcessCr3</td><td>The target Process CR3 </td></tr>
    <tr><td class="paramname">TargetFunction</td><td>Target function that needs to be hooked </td></tr>
    <tr><td class="paramname">TargetFunctionInSafeMemory</td><td>Target content in the safe memory (used in Length Disassembler Engine) </td></tr>
    <tr><td class="paramname">HookFunction</td><td>The function that will be called when hook triggered </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or returns false if it was not successful </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  839</span>{</div>
<div class="line"><span class="lineno">  840</span>    <a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">PHIDDEN_HOOKS_DETOUR_DETAILS</a> DetourHookDetails;</div>
<div class="line"><span class="lineno">  841</span>    SIZE_T                       SizeOfHookedInstructions;</div>
<div class="line"><span class="lineno">  842</span>    SIZE_T                       OffsetIntoPage;</div>
<div class="line"><span class="lineno">  843</span>    <a class="code hl_struct" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a>                     Cr3OfCurrentProcess;</div>
<div class="line"><span class="lineno">  844</span> </div>
<div class="line"><span class="lineno">  845</span>    OffsetIntoPage = <a class="code hl_define" href="_ept_8h.html#a2faab1a93d36f8a2d9ae5c79de293300">ADDRMASK_EPT_PML1_OFFSET</a>((SIZE_T)TargetFunction);</div>
<div class="line"><span class="lineno">  846</span> </div>
<div class="line"><span class="lineno">  847</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  848</span>    <span class="comment">// Log offset</span></div>
<div class="line"><span class="lineno">  849</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  850</span>    <span class="comment">// LogInfo(&quot;OffsetIntoPage: 0x%llx&quot;, OffsetIntoPage);</span></div>
<div class="line"><span class="lineno">  851</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  852</span> </div>
<div class="line"><span class="lineno">  853</span>    <span class="keywordflow">if</span> ((OffsetIntoPage + 19) &gt; <a class="code hl_define" href="libhyperdbg_2header_2_common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a> - 1)</div>
<div class="line"><span class="lineno">  854</span>    {</div>
<div class="line"><span class="lineno">  855</span>        <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, function extends past a page boundary&quot;</span>);</div>
<div class="line"><span class="lineno">  856</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  857</span>    }</div>
<div class="line"><span class="lineno">  858</span> </div>
<div class="line"><span class="lineno">  859</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  860</span>    <span class="comment">// Determine the number of instructions necessary to overwrite using Length Disassembler Engine</span></div>
<div class="line"><span class="lineno">  861</span>    <span class="comment">// EPTHOOK2 only supports 64-bit kernel (32-bit LDE is not supported)</span></div>
<div class="line"><span class="lineno">  862</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  863</span>    <span class="keywordflow">for</span> (SizeOfHookedInstructions = 0;</div>
<div class="line"><span class="lineno">  864</span>         SizeOfHookedInstructions &lt; 19;</div>
<div class="line"><span class="lineno">  865</span>         SizeOfHookedInstructions += <a class="code hl_function" href="_disassembler_8c.html#a387718dcee35d796938ad5f9b9fb1820">DisassemblerLengthDisassembleEngineInVmxRootOnTargetProcess</a>(</div>
<div class="line"><span class="lineno">  866</span>             (PVOID)((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)TargetFunctionInSafeMemory + SizeOfHookedInstructions),</div>
<div class="line"><span class="lineno">  867</span>             <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>))</div>
<div class="line"><span class="lineno">  868</span>    {</div>
<div class="line"><span class="lineno">  869</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  870</span>        <span class="comment">// Get the full size of instructions necessary to copy</span></div>
<div class="line"><span class="lineno">  871</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  872</span>    }</div>
<div class="line"><span class="lineno">  873</span> </div>
<div class="line"><span class="lineno">  874</span>    <span class="comment">// for (SizeOfHookedInstructions = 0;</span></div>
<div class="line"><span class="lineno">  875</span>    <span class="comment">//      SizeOfHookedInstructions &lt; 19;</span></div>
<div class="line"><span class="lineno">  876</span>    <span class="comment">//      SizeOfHookedInstructions += ZydisLde(((UINT64)TargetFunctionInSafeMemory + SizeOfHookedInstructions), TRUE))</span></div>
<div class="line"><span class="lineno">  877</span>    <span class="comment">//{</span></div>
<div class="line"><span class="lineno">  878</span>    <span class="comment">//     //</span></div>
<div class="line"><span class="lineno">  879</span>    <span class="comment">//     // Get the full size of instructions necessary to copy</span></div>
<div class="line"><span class="lineno">  880</span>    <span class="comment">//     //</span></div>
<div class="line"><span class="lineno">  881</span>    <span class="comment">// }</span></div>
<div class="line"><span class="lineno">  882</span> </div>
<div class="line"><span class="lineno">  883</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  884</span>    <span class="comment">// For logging purpose</span></div>
<div class="line"><span class="lineno">  885</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  886</span>    <span class="comment">// LogInfo(&quot;Number of bytes of instruction mem: %x&quot;, SizeOfHookedInstructions);</span></div>
<div class="line"><span class="lineno">  887</span> </div>
<div class="line"><span class="lineno">  888</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  889</span>    <span class="comment">// Build a trampoline</span></div>
<div class="line"><span class="lineno">  890</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  891</span> </div>
<div class="line"><span class="lineno">  892</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  893</span>    <span class="comment">// Allocate some executable memory for the trampoline</span></div>
<div class="line"><span class="lineno">  894</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  895</span>    Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">Trampoline</a> = (<a class="code hl_typedef" href="_basic_types_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a> *)<a class="code hl_function" href="_pool_manager_8c.html#a065841edb44331344b1a71a2ea397923">PoolManagerRequestPool</a>(<a class="code hl_enumvalue" href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a18c553f48bd909ebfea72c42edeea43d">EXEC_TRAMPOLINE</a>, <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code hl_define" href="_hooks_8h.html#a9b5b17233c5031bc6d520227b440e01a">MAX_EXEC_TRAMPOLINE_SIZE</a>);</div>
<div class="line"><span class="lineno">  896</span> </div>
<div class="line"><span class="lineno">  897</span>    <span class="keywordflow">if</span> (!Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">Trampoline</a>)</div>
<div class="line"><span class="lineno">  898</span>    {</div>
<div class="line"><span class="lineno">  899</span>        <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, could not allocate trampoline function buffer&quot;</span>);</div>
<div class="line"><span class="lineno">  900</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  901</span>    }</div>
<div class="line"><span class="lineno">  902</span> </div>
<div class="line"><span class="lineno">  903</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  904</span>    <span class="comment">// Copy the trampoline instructions in</span></div>
<div class="line"><span class="lineno">  905</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  906</span> </div>
<div class="line"><span class="lineno">  907</span>    <span class="comment">// Switch to target process</span></div>
<div class="line"><span class="lineno">  908</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  909</span>    Cr3OfCurrentProcess = <a class="code hl_function" href="_switch_layout_8c.html#a25d1e7a8c5f5c7dd0c77e160c03b6d5d">SwitchToProcessMemoryLayoutByCr3</a>(ProcessCr3);</div>
<div class="line"><span class="lineno">  910</span> </div>
<div class="line"><span class="lineno">  911</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  912</span>    <span class="comment">// The following line can&#39;t be used in user mode addresses</span></div>
<div class="line"><span class="lineno">  913</span>    <span class="comment">// RtlCopyMemory(Hook-&gt;Trampoline, TargetFunction, SizeOfHookedInstructions);</span></div>
<div class="line"><span class="lineno">  914</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  915</span>    <a class="code hl_function" href="_memory_mapper_8c.html#ac3c23d5644111a6be18ca274f448e9ff">MemoryMapperReadMemorySafe</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)TargetFunction, Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">Trampoline</a>, SizeOfHookedInstructions);</div>
<div class="line"><span class="lineno">  916</span> </div>
<div class="line"><span class="lineno">  917</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  918</span>    <span class="comment">// Restore to original process</span></div>
<div class="line"><span class="lineno">  919</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  920</span>    <a class="code hl_function" href="_switch_layout_8c.html#a1cf82918f5f7b7fe06a46a3e8418761d">SwitchToPreviousProcess</a>(Cr3OfCurrentProcess);</div>
<div class="line"><span class="lineno">  921</span> </div>
<div class="line"><span class="lineno">  922</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  923</span>    <span class="comment">// Add the absolute jump back to the original function</span></div>
<div class="line"><span class="lineno">  924</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  925</span>    <a class="code hl_function" href="#a8767a6d054fe785e66068e32b4466b87">EptHookWriteAbsoluteJump2</a>(&amp;Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">Trampoline</a>[SizeOfHookedInstructions], (SIZE_T)TargetFunction + SizeOfHookedInstructions);</div>
<div class="line"><span class="lineno">  926</span> </div>
<div class="line"><span class="lineno">  927</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  928</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  929</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  930</span>    <span class="comment">// LogInfo(&quot;Trampoline: 0x%llx&quot;, Hook-&gt;Trampoline);</span></div>
<div class="line"><span class="lineno">  931</span>    <span class="comment">// LogInfo(&quot;HookFunction: 0x%llx&quot;, HookFunction);</span></div>
<div class="line"><span class="lineno">  932</span> </div>
<div class="line"><span class="lineno">  933</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  934</span>    <span class="comment">// Let the hook function call the original function</span></div>
<div class="line"><span class="lineno">  935</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  936</span>    <span class="comment">// *OrigFunction = Hook-&gt;Trampoline;</span></div>
<div class="line"><span class="lineno">  937</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  938</span> </div>
<div class="line"><span class="lineno">  939</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  940</span>    <span class="comment">// Create the structure to return for the debugger, we do it here because it&#39;s the first</span></div>
<div class="line"><span class="lineno">  941</span>    <span class="comment">// function that changes the original function and if our structure is no ready after this</span></div>
<div class="line"><span class="lineno">  942</span>    <span class="comment">// function then we probably see BSOD on other cores</span></div>
<div class="line"><span class="lineno">  943</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  944</span>    DetourHookDetails                        = (<a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">HIDDEN_HOOKS_DETOUR_DETAILS</a> *)<a class="code hl_function" href="_pool_manager_8c.html#a065841edb44331344b1a71a2ea397923">PoolManagerRequestPool</a>(<a class="code hl_enumvalue" href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a898d2549c3e40191c8e23e4ee687663b">DETOUR_HOOK_DETAILS</a>, <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">HIDDEN_HOOKS_DETOUR_DETAILS</a>));</div>
<div class="line"><span class="lineno">  945</span>    DetourHookDetails-&gt;<a class="code hl_variable" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a5b7e945d9dd258586acd7e0268c8f11a">HookedFunctionAddress</a> = TargetFunction;</div>
<div class="line"><span class="lineno">  946</span>    DetourHookDetails-&gt;<a class="code hl_variable" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a89757e40877fd300bf09ab3b45642f28">ReturnAddress</a>         = Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">Trampoline</a>;</div>
<div class="line"><span class="lineno">  947</span> </div>
<div class="line"><span class="lineno">  948</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  949</span>    <span class="comment">// Save the address of DetourHookDetails because we want to</span></div>
<div class="line"><span class="lineno">  950</span>    <span class="comment">// deallocate it when the hook is finished</span></div>
<div class="line"><span class="lineno">  951</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  952</span>    Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a20c61155569f9c8a3e3fd4a670e231f7">AddressOfEptHook2sDetourListEntry</a> = (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)DetourHookDetails;</div>
<div class="line"><span class="lineno">  953</span> </div>
<div class="line"><span class="lineno">  954</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  955</span>    <span class="comment">// Insert it to the list of hooked pages</span></div>
<div class="line"><span class="lineno">  956</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  957</span>    <a class="code hl_function" href="_windows_8h.html#ad311db6648e5e4e2860aab6164cdb6c1">InsertHeadList</a>(&amp;<a class="code hl_variable" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a>, &amp;(DetourHookDetails-&gt;<a class="code hl_variable" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#aa47949f02b08a654dbe910d6d107fa94">OtherHooksList</a>));</div>
<div class="line"><span class="lineno">  958</span> </div>
<div class="line"><span class="lineno">  959</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  960</span>    <span class="comment">// Write the absolute jump to our shadow page memory to jump to our hook</span></div>
<div class="line"><span class="lineno">  961</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  962</span>    <a class="code hl_function" href="#a50935db932e916707520e63212e9e688">EptHookWriteAbsoluteJump</a>(&amp;Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>[OffsetIntoPage], (SIZE_T)HookFunction);</div>
<div class="line"><span class="lineno">  963</span> </div>
<div class="line"><span class="lineno">  964</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  965</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_aebb9e13210d88d43e32e735ada43a425"><div class="ttname"><a href="_basic_types_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a></div><div class="ttdeci">char CHAR</div><div class="ttdef"><b>Definition</b> BasicTypes.h:31</div></div>
<div class="ttc" id="a_data_types_8h_html_ad130f0bae4db97169873223d0aad9a63a18c553f48bd909ebfea72c42edeea43d"><div class="ttname"><a href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a18c553f48bd909ebfea72c42edeea43d">EXEC_TRAMPOLINE</a></div><div class="ttdeci">@ EXEC_TRAMPOLINE</div><div class="ttdef"><b>Definition</b> DataTypes.h:42</div></div>
<div class="ttc" id="a_data_types_8h_html_ad130f0bae4db97169873223d0aad9a63a898d2549c3e40191c8e23e4ee687663b"><div class="ttname"><a href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a898d2549c3e40191c8e23e4ee687663b">DETOUR_HOOK_DETAILS</a></div><div class="ttdeci">@ DETOUR_HOOK_DETAILS</div><div class="ttdef"><b>Definition</b> DataTypes.h:44</div></div>
<div class="ttc" id="a_disassembler_8c_html_a387718dcee35d796938ad5f9b9fb1820"><div class="ttname"><a href="_disassembler_8c.html#a387718dcee35d796938ad5f9b9fb1820">DisassemblerLengthDisassembleEngineInVmxRootOnTargetProcess</a></div><div class="ttdeci">UINT32 DisassemblerLengthDisassembleEngineInVmxRootOnTargetProcess(PVOID Address, BOOLEAN Is32Bit)</div><div class="ttdoc">Disassembler length disassembler engine.</div><div class="ttdef"><b>Definition</b> Disassembler.c:297</div></div>
<div class="ttc" id="a_ept_8h_html_a2faab1a93d36f8a2d9ae5c79de293300"><div class="ttname"><a href="_ept_8h.html#a2faab1a93d36f8a2d9ae5c79de293300">ADDRMASK_EPT_PML1_OFFSET</a></div><div class="ttdeci">#define ADDRMASK_EPT_PML1_OFFSET(_VAR_)</div><div class="ttdoc">Offset into the 1st paging structure (4096 byte)</div><div class="ttdef"><b>Definition</b> Ept.h:37</div></div>
<div class="ttc" id="a_ept_hook_8c_html_a50935db932e916707520e63212e9e688"><div class="ttname"><a href="#a50935db932e916707520e63212e9e688">EptHookWriteAbsoluteJump</a></div><div class="ttdeci">VOID EptHookWriteAbsoluteJump(PCHAR TargetBuffer, SIZE_T TargetAddress)</div><div class="ttdoc">Write an absolute x64 jump to an arbitrary address to a buffer.</div><div class="ttdef"><b>Definition</b> EptHook.c:743</div></div>
<div class="ttc" id="a_ept_hook_8c_html_a8767a6d054fe785e66068e32b4466b87"><div class="ttname"><a href="#a8767a6d054fe785e66068e32b4466b87">EptHookWriteAbsoluteJump2</a></div><div class="ttdeci">VOID EptHookWriteAbsoluteJump2(PCHAR TargetBuffer, SIZE_T TargetAddress)</div><div class="ttdoc">Write an absolute x64 jump to an arbitrary address to a buffer.</div><div class="ttdef"><b>Definition</b> EptHook.c:792</div></div>
<div class="ttc" id="a_hooks_8h_html_a9b5b17233c5031bc6d520227b440e01a"><div class="ttname"><a href="_hooks_8h.html#a9b5b17233c5031bc6d520227b440e01a">MAX_EXEC_TRAMPOLINE_SIZE</a></div><div class="ttdeci">#define MAX_EXEC_TRAMPOLINE_SIZE</div><div class="ttdoc">Maximum number of supported execution trampoline.</div><div class="ttdef"><b>Definition</b> Hooks.h:174</div></div>
<div class="ttc" id="a_hyper_dbg_hyper_log_intrinsics_8h_html_a459b19922fecfbb9438dd56b66930d16"><div class="ttname"><a href="_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a></div><div class="ttdeci">#define LogError(format,...)</div><div class="ttdoc">Log in the case of error.</div><div class="ttdef"><b>Definition</b> HyperDbgHyperLogIntrinsics.h:113</div></div>
<div class="ttc" id="a_memory_mapper_8c_html_ac3c23d5644111a6be18ca274f448e9ff"><div class="ttname"><a href="_memory_mapper_8c.html#ac3c23d5644111a6be18ca274f448e9ff">MemoryMapperReadMemorySafe</a></div><div class="ttdeci">_Use_decl_annotations_ BOOLEAN MemoryMapperReadMemorySafe(UINT64 VaAddressToRead, PVOID BufferToSaveMemory, SIZE_T SizeToRead)</div><div class="ttdoc">Read memory safely by mapping the buffer (It's a wrapper)</div><div class="ttdef"><b>Definition</b> MemoryMapper.c:1101</div></div>
<div class="ttc" id="a_pool_manager_8c_html_a065841edb44331344b1a71a2ea397923"><div class="ttname"><a href="_pool_manager_8c.html#a065841edb44331344b1a71a2ea397923">PoolManagerRequestPool</a></div><div class="ttdeci">UINT64 PoolManagerRequestPool(POOL_ALLOCATION_INTENTION Intention, BOOLEAN RequestNewPool, UINT32 Size)</div><div class="ttdoc">This function should be called from vmx-root in order to get a pool from the list.</div><div class="ttdef"><b>Definition</b> PoolManager.c:212</div></div>
<div class="ttc" id="a_switch_layout_8c_html_a1cf82918f5f7b7fe06a46a3e8418761d"><div class="ttname"><a href="_switch_layout_8c.html#a1cf82918f5f7b7fe06a46a3e8418761d">SwitchToPreviousProcess</a></div><div class="ttdeci">_Use_decl_annotations_ VOID SwitchToPreviousProcess(CR3_TYPE PreviousProcess)</div><div class="ttdoc">Switch to previous process's cr3.</div><div class="ttdef"><b>Definition</b> SwitchLayout.c:125</div></div>
<div class="ttc" id="a_switch_layout_8c_html_a25d1e7a8c5f5c7dd0c77e160c03b6d5d"><div class="ttname"><a href="_switch_layout_8c.html#a25d1e7a8c5f5c7dd0c77e160c03b6d5d">SwitchToProcessMemoryLayoutByCr3</a></div><div class="ttdeci">_Use_decl_annotations_ CR3_TYPE SwitchToProcessMemoryLayoutByCr3(CR3_TYPE TargetCr3)</div><div class="ttdoc">Switch to another process's cr3.</div><div class="ttdef"><b>Definition</b> SwitchLayout.c:99</div></div>
<div class="ttc" id="a_windows_8h_html_ad311db6648e5e4e2860aab6164cdb6c1"><div class="ttname"><a href="_windows_8h.html#ad311db6648e5e4e2860aab6164cdb6c1">InsertHeadList</a></div><div class="ttdeci">FORCEINLINE VOID InsertHeadList(_Inout_ PLIST_ENTRY ListHead, _Inout_ PLIST_ENTRY Entry)</div><div class="ttdef"><b>Definition</b> Windows.h:115</div></div>
<div class="ttc" id="alibhyperdbg_2header_2_common_8h_html_a7d467c1d283fdfa1f2081ba1e0d01b6e"><div class="ttname"><a href="libhyperdbg_2header_2_common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a></div><div class="ttdeci">#define PAGE_SIZE</div><div class="ttdoc">Size of each page (4096 bytes)</div><div class="ttdef"><b>Definition</b> common.h:69</div></div>
<div class="ttc" id="astruct___c_r3___t_y_p_e_html"><div class="ttname"><a href="struct___c_r3___t_y_p_e.html">_CR3_TYPE</a></div><div class="ttdoc">CR3 Structure.</div><div class="ttdef"><b>Definition</b> BasicTypes.h:130</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a20c61155569f9c8a3e3fd4a670e231f7"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a20c61155569f9c8a3e3fd4a670e231f7">_EPT_HOOKED_PAGE_DETAIL::AddressOfEptHook2sDetourListEntry</a></div><div class="ttdeci">UINT64 AddressOfEptHook2sDetourListEntry</div><div class="ttdoc">The virtual address of it's entry on g_EptHook2sDetourListHead this way we can de-allocate the list w...</div><div class="ttdef"><b>Definition</b> State.h:181</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a4c523ca3a1b46bf34681abfec4fef75e"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">_EPT_HOOKED_PAGE_DETAIL::FakePageContents</a></div><div class="ttdeci">CHAR FakePageContents[PAGE_SIZE]</div><div class="ttdef"><b>Definition</b> State.h:165</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a7db42bbe2d48d142bd18747fc53f903f"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">_EPT_HOOKED_PAGE_DETAIL::Trampoline</a></div><div class="ttdeci">PCHAR Trampoline</div><div class="ttdoc">The buffer of the trampoline function which is used in the inline hook.</div><div class="ttdef"><b>Definition</b> State.h:224</div></div>
<div class="ttc" id="astruct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s_html_aa47949f02b08a654dbe910d6d107fa94"><div class="ttname"><a href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#aa47949f02b08a654dbe910d6d107fa94">_HIDDEN_HOOKS_DETOUR_DETAILS::OtherHooksList</a></div><div class="ttdeci">LIST_ENTRY OtherHooksList</div><div class="ttdef"><b>Definition</b> Hooks.h:75</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a54499f05708f5cf69df924d7cf92ba89" name="a54499f05708f5cf69df924d7cf92ba89"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a54499f05708f5cf69df924d7cf92ba89">&#9670;&#160;</a></span>EptHookModifyInstructionFetchState()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookModifyInstructionFetchState </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>PhysicalAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></td>          <td class="paramname"><span class="paramname"><em>IsUnset</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Change PML EPT state for execution (execute) @detail should be called from VMX-root. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">PhysicalAddress</td><td>Target physical address </td></tr>
    <tr><td class="paramname">IsUnset</td><td>Is unsetting bit or setting bit</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 2569</span>{</div>
<div class="line"><span class="lineno"> 2570</span>    PVOID   PmlEntry    = <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno"> 2571</span>    <a class="code hl_typedef" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsLargePage = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2572</span> </div>
<div class="line"><span class="lineno"> 2573</span>    PmlEntry = <a class="code hl_function" href="_ept_8c.html#abcf5b515cfa04b93d52480ee9c0b1dd1">EptGetPml1OrPml2Entry</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">EptPageTable</a>, (SIZE_T)PhysicalAddress, &amp;IsLargePage);</div>
<div class="line"><span class="lineno"> 2574</span> </div>
<div class="line"><span class="lineno"> 2575</span>    <span class="keywordflow">if</span> (PmlEntry)</div>
<div class="line"><span class="lineno"> 2576</span>    {</div>
<div class="line"><span class="lineno"> 2577</span>        <span class="keywordflow">if</span> (IsLargePage)</div>
<div class="line"><span class="lineno"> 2578</span>        {</div>
<div class="line"><span class="lineno"> 2579</span>            <span class="keywordflow">if</span> (IsUnset)</div>
<div class="line"><span class="lineno"> 2580</span>            {</div>
<div class="line"><span class="lineno"> 2581</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a28288ee344c5e7e99c55200a5eb8dafd">PEPT_PML2_ENTRY</a>)PmlEntry)-&gt;ExecuteAccess = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2582</span>            }</div>
<div class="line"><span class="lineno"> 2583</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2584</span>            {</div>
<div class="line"><span class="lineno"> 2585</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a28288ee344c5e7e99c55200a5eb8dafd">PEPT_PML2_ENTRY</a>)PmlEntry)-&gt;ExecuteAccess = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2586</span>            }</div>
<div class="line"><span class="lineno"> 2587</span>        }</div>
<div class="line"><span class="lineno"> 2588</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2589</span>        {</div>
<div class="line"><span class="lineno"> 2590</span>            <span class="keywordflow">if</span> (IsUnset)</div>
<div class="line"><span class="lineno"> 2591</span>            {</div>
<div class="line"><span class="lineno"> 2592</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a>)PmlEntry)-&gt;ExecuteAccess = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2593</span>            }</div>
<div class="line"><span class="lineno"> 2594</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2595</span>            {</div>
<div class="line"><span class="lineno"> 2596</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a>)PmlEntry)-&gt;ExecuteAccess = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2597</span>            }</div>
<div class="line"><span class="lineno"> 2598</span>        }</div>
<div class="line"><span class="lineno"> 2599</span>    }</div>
<div class="line"><span class="lineno"> 2600</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2601</span>    {</div>
<div class="line"><span class="lineno"> 2602</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2603</span>    }</div>
<div class="line"><span class="lineno"> 2604</span> </div>
<div class="line"><span class="lineno"> 2605</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2606</span>    <span class="comment">// Invalidate the EPTP (single-context)</span></div>
<div class="line"><span class="lineno"> 2607</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2608</span>    <a class="code hl_function" href="_invept_8c.html#a7c73091dea8c657cef945340f4bd2808">EptInveptSingleContext</a>(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a4c5c6fd61c83853d21e270e87cdea179">EptPointer</a>.AsUInt);</div>
<div class="line"><span class="lineno"> 2609</span> </div>
<div class="line"><span class="lineno"> 2610</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2611</span>}</div>
<div class="ttc" id="a_ept_8c_html_abcf5b515cfa04b93d52480ee9c0b1dd1"><div class="ttname"><a href="_ept_8c.html#abcf5b515cfa04b93d52480ee9c0b1dd1">EptGetPml1OrPml2Entry</a></div><div class="ttdeci">PVOID EptGetPml1OrPml2Entry(PVMM_EPT_PAGE_TABLE EptPageTable, SIZE_T PhysicalAddress, BOOLEAN *IsLargePage)</div><div class="ttdoc">Get the PML1 entry for this physical address if the large page is available then large page of Pml2 i...</div><div class="ttdef"><b>Definition</b> Ept.c:368</div></div>
<div class="ttc" id="a_invept_8c_html_a7c73091dea8c657cef945340f4bd2808"><div class="ttname"><a href="_invept_8c.html#a7c73091dea8c657cef945340f4bd2808">EptInveptSingleContext</a></div><div class="ttdeci">UCHAR EptInveptSingleContext(_In_ UINT64 EptPointer)</div><div class="ttdoc">Invalidates a single context in ept cache table.</div><div class="ttdef"><b>Definition</b> Invept.c:40</div></div>
<div class="ttc" id="ahyperhv_2header_2common_2_state_8h_html_a03c563d9799bc8f374809f48c73c7175"><div class="ttname"><a href="hyperhv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a></div><div class="ttdeci">EPT_PTE * PEPT_PML1_ENTRY</div><div class="ttdef"><b>Definition</b> State.h:22</div></div>
<div class="ttc" id="ahyperhv_2header_2common_2_state_8h_html_a28288ee344c5e7e99c55200a5eb8dafd"><div class="ttname"><a href="hyperhv_2header_2common_2_state_8h.html#a28288ee344c5e7e99c55200a5eb8dafd">PEPT_PML2_ENTRY</a></div><div class="ttdeci">EPT_PDE_2MB * PEPT_PML2_ENTRY</div><div class="ttdef"><b>Definition</b> State.h:20</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a63cb7b9ebbfafeb6f69caa76f755c7bd"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">_EPT_STATE::EptPageTable</a></div><div class="ttdeci">PVMM_EPT_PAGE_TABLE EptPageTable</div><div class="ttdef"><b>Definition</b> Ept.h:121</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a4c5c6fd61c83853d21e270e87cdea179"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a4c5c6fd61c83853d21e270e87cdea179">_VIRTUAL_MACHINE_STATE::EptPointer</a></div><div class="ttdeci">EPT_POINTER EptPointer</div><div class="ttdef"><b>Definition</b> State.h:341</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1dc01f084128845b23788d6f384df6ab" name="a1dc01f084128845b23788d6f384df6ab"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1dc01f084128845b23788d6f384df6ab">&#9670;&#160;</a></span>EptHookModifyPageReadState()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookModifyPageReadState </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>PhysicalAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></td>          <td class="paramname"><span class="paramname"><em>IsUnset</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Change PML EPT state for read @detail should be called from VMX-root. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">PhysicalAddress</td><td>Target physical address </td></tr>
    <tr><td class="paramname">IsUnset</td><td>Is unsetting bit or setting bit</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 2627</span>{</div>
<div class="line"><span class="lineno"> 2628</span>    PVOID   PmlEntry    = <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno"> 2629</span>    <a class="code hl_typedef" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsLargePage = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2630</span> </div>
<div class="line"><span class="lineno"> 2631</span>    PmlEntry = <a class="code hl_function" href="_ept_8c.html#abcf5b515cfa04b93d52480ee9c0b1dd1">EptGetPml1OrPml2Entry</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">EptPageTable</a>, (SIZE_T)PhysicalAddress, &amp;IsLargePage);</div>
<div class="line"><span class="lineno"> 2632</span> </div>
<div class="line"><span class="lineno"> 2633</span>    <span class="keywordflow">if</span> (PmlEntry)</div>
<div class="line"><span class="lineno"> 2634</span>    {</div>
<div class="line"><span class="lineno"> 2635</span>        <span class="keywordflow">if</span> (IsLargePage)</div>
<div class="line"><span class="lineno"> 2636</span>        {</div>
<div class="line"><span class="lineno"> 2637</span>            <span class="keywordflow">if</span> (IsUnset)</div>
<div class="line"><span class="lineno"> 2638</span>            {</div>
<div class="line"><span class="lineno"> 2639</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a28288ee344c5e7e99c55200a5eb8dafd">PEPT_PML2_ENTRY</a>)PmlEntry)-&gt;ReadAccess = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2640</span>            }</div>
<div class="line"><span class="lineno"> 2641</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2642</span>            {</div>
<div class="line"><span class="lineno"> 2643</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a28288ee344c5e7e99c55200a5eb8dafd">PEPT_PML2_ENTRY</a>)PmlEntry)-&gt;ReadAccess = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2644</span>            }</div>
<div class="line"><span class="lineno"> 2645</span>        }</div>
<div class="line"><span class="lineno"> 2646</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2647</span>        {</div>
<div class="line"><span class="lineno"> 2648</span>            <span class="keywordflow">if</span> (IsUnset)</div>
<div class="line"><span class="lineno"> 2649</span>            {</div>
<div class="line"><span class="lineno"> 2650</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a>)PmlEntry)-&gt;ReadAccess = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2651</span>            }</div>
<div class="line"><span class="lineno"> 2652</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2653</span>            {</div>
<div class="line"><span class="lineno"> 2654</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a>)PmlEntry)-&gt;ReadAccess = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2655</span>            }</div>
<div class="line"><span class="lineno"> 2656</span>        }</div>
<div class="line"><span class="lineno"> 2657</span>    }</div>
<div class="line"><span class="lineno"> 2658</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2659</span>    {</div>
<div class="line"><span class="lineno"> 2660</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2661</span>    }</div>
<div class="line"><span class="lineno"> 2662</span> </div>
<div class="line"><span class="lineno"> 2663</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2664</span>    <span class="comment">// Invalidate the EPTP (single-context)</span></div>
<div class="line"><span class="lineno"> 2665</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2666</span>    <a class="code hl_function" href="_invept_8c.html#a7c73091dea8c657cef945340f4bd2808">EptInveptSingleContext</a>(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a4c5c6fd61c83853d21e270e87cdea179">EptPointer</a>.AsUInt);</div>
<div class="line"><span class="lineno"> 2667</span> </div>
<div class="line"><span class="lineno"> 2668</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2669</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a04587a27698f5cc43cd9c2c13a6736c5" name="a04587a27698f5cc43cd9c2c13a6736c5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a04587a27698f5cc43cd9c2c13a6736c5">&#9670;&#160;</a></span>EptHookModifyPageWriteState()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookModifyPageWriteState </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>PhysicalAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></td>          <td class="paramname"><span class="paramname"><em>IsUnset</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Change PML EPT state for write @detail should be called from VMX-root. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">PhysicalAddress</td><td>Target physical address </td></tr>
    <tr><td class="paramname">IsUnset</td><td>Is unsetting bit or setting bit</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 2685</span>{</div>
<div class="line"><span class="lineno"> 2686</span>    PVOID   PmlEntry    = <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno"> 2687</span>    <a class="code hl_typedef" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsLargePage = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2688</span> </div>
<div class="line"><span class="lineno"> 2689</span>    PmlEntry = <a class="code hl_function" href="_ept_8c.html#abcf5b515cfa04b93d52480ee9c0b1dd1">EptGetPml1OrPml2Entry</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">EptPageTable</a>, (SIZE_T)PhysicalAddress, &amp;IsLargePage);</div>
<div class="line"><span class="lineno"> 2690</span> </div>
<div class="line"><span class="lineno"> 2691</span>    <span class="keywordflow">if</span> (PmlEntry)</div>
<div class="line"><span class="lineno"> 2692</span>    {</div>
<div class="line"><span class="lineno"> 2693</span>        <span class="keywordflow">if</span> (IsLargePage)</div>
<div class="line"><span class="lineno"> 2694</span>        {</div>
<div class="line"><span class="lineno"> 2695</span>            <span class="keywordflow">if</span> (IsUnset)</div>
<div class="line"><span class="lineno"> 2696</span>            {</div>
<div class="line"><span class="lineno"> 2697</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a28288ee344c5e7e99c55200a5eb8dafd">PEPT_PML2_ENTRY</a>)PmlEntry)-&gt;WriteAccess = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2698</span>            }</div>
<div class="line"><span class="lineno"> 2699</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2700</span>            {</div>
<div class="line"><span class="lineno"> 2701</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a28288ee344c5e7e99c55200a5eb8dafd">PEPT_PML2_ENTRY</a>)PmlEntry)-&gt;WriteAccess = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2702</span>            }</div>
<div class="line"><span class="lineno"> 2703</span>        }</div>
<div class="line"><span class="lineno"> 2704</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2705</span>        {</div>
<div class="line"><span class="lineno"> 2706</span>            <span class="keywordflow">if</span> (IsUnset)</div>
<div class="line"><span class="lineno"> 2707</span>            {</div>
<div class="line"><span class="lineno"> 2708</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a>)PmlEntry)-&gt;WriteAccess = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2709</span>            }</div>
<div class="line"><span class="lineno"> 2710</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2711</span>            {</div>
<div class="line"><span class="lineno"> 2712</span>                ((<a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a>)PmlEntry)-&gt;WriteAccess = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2713</span>            }</div>
<div class="line"><span class="lineno"> 2714</span>        }</div>
<div class="line"><span class="lineno"> 2715</span>    }</div>
<div class="line"><span class="lineno"> 2716</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2717</span>    {</div>
<div class="line"><span class="lineno"> 2718</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2719</span>    }</div>
<div class="line"><span class="lineno"> 2720</span> </div>
<div class="line"><span class="lineno"> 2721</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2722</span>    <span class="comment">// Invalidate the EPTP (single-context)</span></div>
<div class="line"><span class="lineno"> 2723</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2724</span>    <a class="code hl_function" href="_invept_8c.html#a7c73091dea8c657cef945340f4bd2808">EptInveptSingleContext</a>(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a4c5c6fd61c83853d21e270e87cdea179">EptPointer</a>.AsUInt);</div>
<div class="line"><span class="lineno"> 2725</span> </div>
<div class="line"><span class="lineno"> 2726</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2727</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a308b3a4a443a479190f2f09599eae906" name="a308b3a4a443a479190f2f09599eae906"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a308b3a4a443a479190f2f09599eae906">&#9670;&#160;</a></span>EptHookMonitorFromVmxRoot()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookMonitorFromVmxRoot </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_data_types_8h.html#ad14bc163543c2acede2c878c50aeca14">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *</td>          <td class="paramname"><span class="paramname"><em>MemoryAddressDetails</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function applies EPT monitor hooks to the target EPT table. </p>
<p>this function should be called from VMX root-mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">MemoryAddressDetails</td><td>details of the target memory</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1653</span>{</div>
<div class="line"><span class="lineno"> 1654</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1655</span>    <span class="comment">// Should be called from vmx root-mode</span></div>
<div class="line"><span class="lineno"> 1656</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1657</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno"> 1658</span>    {</div>
<div class="line"><span class="lineno"> 1659</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1660</span>    }</div>
<div class="line"><span class="lineno"> 1661</span> </div>
<div class="line"><span class="lineno"> 1662</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="#a55a664f6c354dacfe2dd66c1ae4415e8">EptHookPerformMemoryOrInlineHook</a>(VCpu,</div>
<div class="line"><span class="lineno"> 1663</span>                                            NULL,</div>
<div class="line"><span class="lineno"> 1664</span>                                            MemoryAddressDetails,</div>
<div class="line"><span class="lineno"> 1665</span>                                            <a class="code hl_define" href="_basic_types_8h.html#a32ab457827837bf5ac123dd0fd8326ae">NULL_ZERO</a>,</div>
<div class="line"><span class="lineno"> 1666</span>                                            <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,</div>
<div class="line"><span class="lineno"> 1667</span>                                            <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div>
<div class="line"><span class="lineno"> 1668</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="acc6e339c3d8b2700e46862591cd5458b" name="acc6e339c3d8b2700e46862591cd5458b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acc6e339c3d8b2700e46862591cd5458b">&#9670;&#160;</a></span>EptHookMonitorHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookMonitorHook </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_data_types_8h.html#ad14bc163543c2acede2c878c50aeca14">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *</td>          <td class="paramname"><span class="paramname"><em>HookingDetails</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>ProcessId</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function applies monitor hooks to the target EPT table. </p>
<p>this function should be called from VMX non-root mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">HookingDetails</td><td>Monitor hooking details </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id to translate based on that process's cr3</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1585</span>{</div>
<div class="line"><span class="lineno"> 1586</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1587</span>    <span class="comment">// Should be called from vmx non-root</span></div>
<div class="line"><span class="lineno"> 1588</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1589</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 1590</span>    {</div>
<div class="line"><span class="lineno"> 1591</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1592</span>    }</div>
<div class="line"><span class="lineno"> 1593</span> </div>
<div class="line"><span class="lineno"> 1594</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="#a55a664f6c354dacfe2dd66c1ae4415e8">EptHookPerformMemoryOrInlineHook</a>(VCpu,</div>
<div class="line"><span class="lineno"> 1595</span>                                            NULL,</div>
<div class="line"><span class="lineno"> 1596</span>                                            HookingDetails,</div>
<div class="line"><span class="lineno"> 1597</span>                                            ProcessId,</div>
<div class="line"><span class="lineno"> 1598</span>                                            <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,</div>
<div class="line"><span class="lineno"> 1599</span>                                            <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div>
<div class="line"><span class="lineno"> 1600</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="acb85a5366d63e1484261f3c32dfb4f64" name="acb85a5366d63e1484261f3c32dfb4f64"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acb85a5366d63e1484261f3c32dfb4f64">&#9670;&#160;</a></span>EptHookPerformHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookPerformHook </td>
          <td>(</td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>TargetAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>ProcessId</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></td>          <td class="paramname"><span class="paramname"><em>ApplyDirectlyFromVmxRoot</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function invokes a VMCALL to set the hook and broadcast the exiting for the breakpoints on exception bitmap. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id to translate based on that process's cr3 </td></tr>
    <tr><td class="paramname">ApplyDirectlyFromVmxRoot</td><td>should it be directly applied from VMX-root mode or not</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  536</span>{</div>
<div class="line"><span class="lineno">  537</span>    <span class="keywordflow">if</span> (ApplyDirectlyFromVmxRoot)</div>
<div class="line"><span class="lineno">  538</span>    {</div>
<div class="line"><span class="lineno">  539</span>        <a class="code hl_struct" href="struct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s.html">DIRECT_VMCALL_PARAMETERS</a> DirectVmcallOptions = {0};</div>
<div class="line"><span class="lineno">  540</span> </div>
<div class="line"><span class="lineno">  541</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  542</span>        <span class="comment">// Set VMCALL options</span></div>
<div class="line"><span class="lineno">  543</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  544</span>        DirectVmcallOptions.<a class="code hl_variable" href="struct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s.html#afa70a893c4cfe5cb7db3e8647ddc032e">OptionalParam1</a> = (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)TargetAddress;</div>
<div class="line"><span class="lineno">  545</span>        DirectVmcallOptions.<a class="code hl_variable" href="struct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s.html#a39944d056bfb507eee85169f70d88ef8">OptionalParam2</a> = <a class="code hl_function" href="_layout_8c.html#af74e610cf3ad5dd8c972f536f2809429">LayoutGetCurrentProcessCr3</a>().<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>;</div>
<div class="line"><span class="lineno">  546</span> </div>
<div class="line"><span class="lineno">  547</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  548</span>        <span class="comment">// Perform the direct VMCALL</span></div>
<div class="line"><span class="lineno">  549</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  550</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="_direct_vmcall_8c.html#ae44aeaa8fd5d1f06a6b546811ebd18bb">DirectVmcallSetHiddenBreakpointHook</a>(KeGetCurrentProcessorNumberEx(NULL), &amp;DirectVmcallOptions) == STATUS_SUCCESS)</div>
<div class="line"><span class="lineno">  551</span>        {</div>
<div class="line"><span class="lineno">  552</span>            <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Hidden breakpoint hook applied from VMX Root Mode&quot;</span>);</div>
<div class="line"><span class="lineno">  553</span> </div>
<div class="line"><span class="lineno">  554</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  555</span>        }</div>
<div class="line"><span class="lineno">  556</span>    }</div>
<div class="line"><span class="lineno">  557</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  558</span>    {</div>
<div class="line"><span class="lineno">  559</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  560</span>        <span class="comment">// Broadcast to all cores to enable vm-exit for breakpoints (exception bitmaps)</span></div>
<div class="line"><span class="lineno">  561</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  562</span>        <a class="code hl_function" href="_broadcast_8c.html#ad3f6212e75c6a7fa25e423c71d9dc1d9">BroadcastEnableBreakpointExitingOnExceptionBitmapAllCores</a>();</div>
<div class="line"><span class="lineno">  563</span> </div>
<div class="line"><span class="lineno">  564</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a>(<a class="code hl_define" href="_vmcall_8h.html#aa23cf4e06f34a78d1efc1049c0c7c9a3">VMCALL_SET_HIDDEN_CC_BREAKPOINT</a>,</div>
<div class="line"><span class="lineno">  565</span>                         (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)TargetAddress,</div>
<div class="line"><span class="lineno">  566</span>                         <a class="code hl_function" href="_layout_8c.html#aba0911b8d51a6f7b74dd2bb70845c4b2">LayoutGetCr3ByProcessId</a>(ProcessId).Flags,</div>
<div class="line"><span class="lineno">  567</span>                         (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_define" href="_basic_types_8h.html#a8a9df53f35cb95dddbe3c564259e01ad">NULL64_ZERO</a>) == STATUS_SUCCESS)</div>
<div class="line"><span class="lineno">  568</span>        {</div>
<div class="line"><span class="lineno">  569</span>            <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Hidden breakpoint hook applied from VMX Root Mode&quot;</span>);</div>
<div class="line"><span class="lineno">  570</span> </div>
<div class="line"><span class="lineno">  571</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno">  572</span>            <span class="comment">// Now we have to notify all the core to invalidate their EPT</span></div>
<div class="line"><span class="lineno">  573</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno">  574</span>            <a class="code hl_function" href="_broadcast_8c.html#a5be99a073a6003a06347aa85b832060f">BroadcastNotifyAllToInvalidateEptAllCores</a>();</div>
<div class="line"><span class="lineno">  575</span> </div>
<div class="line"><span class="lineno">  576</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  577</span>        }</div>
<div class="line"><span class="lineno">  578</span>    }</div>
<div class="line"><span class="lineno">  579</span> </div>
<div class="line"><span class="lineno">  580</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  581</span>    <span class="comment">// sth went wrong as we&#39;re here</span></div>
<div class="line"><span class="lineno">  582</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  583</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  584</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_a8a9df53f35cb95dddbe3c564259e01ad"><div class="ttname"><a href="_basic_types_8h.html#a8a9df53f35cb95dddbe3c564259e01ad">NULL64_ZERO</a></div><div class="ttdeci">#define NULL64_ZERO</div><div class="ttdef"><b>Definition</b> BasicTypes.h:52</div></div>
<div class="ttc" id="a_broadcast_8c_html_a5be99a073a6003a06347aa85b832060f"><div class="ttname"><a href="_broadcast_8c.html#a5be99a073a6003a06347aa85b832060f">BroadcastNotifyAllToInvalidateEptAllCores</a></div><div class="ttdeci">VOID BroadcastNotifyAllToInvalidateEptAllCores()</div><div class="ttdoc">routines to notify to invalidate their ept on all cores</div><div class="ttdef"><b>Definition</b> Broadcast.c:119</div></div>
<div class="ttc" id="a_broadcast_8c_html_ad3f6212e75c6a7fa25e423c71d9dc1d9"><div class="ttname"><a href="_broadcast_8c.html#ad3f6212e75c6a7fa25e423c71d9dc1d9">BroadcastEnableBreakpointExitingOnExceptionBitmapAllCores</a></div><div class="ttdeci">VOID BroadcastEnableBreakpointExitingOnExceptionBitmapAllCores()</div><div class="ttdoc">routines to enable vm-exit for breakpoints (exception bitmap)</div><div class="ttdef"><b>Definition</b> Broadcast.c:63</div></div>
<div class="ttc" id="a_direct_vmcall_8c_html_ae44aeaa8fd5d1f06a6b546811ebd18bb"><div class="ttname"><a href="_direct_vmcall_8c.html#ae44aeaa8fd5d1f06a6b546811ebd18bb">DirectVmcallSetHiddenBreakpointHook</a></div><div class="ttdeci">NTSTATUS DirectVmcallSetHiddenBreakpointHook(UINT32 CoreId, DIRECT_VMCALL_PARAMETERS *DirectVmcallOptions)</div><div class="ttdoc">routines for putting hidden breakpoints (using EPT)</div><div class="ttdef"><b>Definition</b> DirectVmcall.c:255</div></div>
<div class="ttc" id="a_hyper_dbg_hyper_log_intrinsics_8h_html_a108126279e46f4d46d25abe24da43fdc"><div class="ttname"><a href="_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a></div><div class="ttdeci">#define LogDebugInfo(format,...)</div><div class="ttdoc">Log, initialize boot information and debug information.</div><div class="ttdef"><b>Definition</b> HyperDbgHyperLogIntrinsics.h:155</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a0fd87b88c03b3c10883f0ad70239bf6c"><div class="ttname"><a href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a></div><div class="ttdeci">NTSTATUS AsmVmxVmcall(unsigned long long VmcallNumber, unsigned long long OptionalParam1, unsigned long long OptionalParam2, long long OptionalParam3)</div><div class="ttdoc">Request Vmcall.</div></div>
<div class="ttc" id="a_layout_8c_html_aba0911b8d51a6f7b74dd2bb70845c4b2"><div class="ttname"><a href="_layout_8c.html#aba0911b8d51a6f7b74dd2bb70845c4b2">LayoutGetCr3ByProcessId</a></div><div class="ttdeci">_Use_decl_annotations_ CR3_TYPE LayoutGetCr3ByProcessId(UINT32 ProcessId)</div><div class="ttdoc">Converts pid to kernel cr3.</div><div class="ttdef"><b>Definition</b> Layout.c:24</div></div>
<div class="ttc" id="a_layout_8c_html_af74e610cf3ad5dd8c972f536f2809429"><div class="ttname"><a href="_layout_8c.html#af74e610cf3ad5dd8c972f536f2809429">LayoutGetCurrentProcessCr3</a></div><div class="ttdeci">CR3_TYPE LayoutGetCurrentProcessCr3()</div><div class="ttdoc">Get cr3 of the target running process.</div><div class="ttdef"><b>Definition</b> Layout.c:55</div></div>
<div class="ttc" id="a_vmcall_8h_html_aa23cf4e06f34a78d1efc1049c0c7c9a3"><div class="ttname"><a href="_vmcall_8h.html#aa23cf4e06f34a78d1efc1049c0c7c9a3">VMCALL_SET_HIDDEN_CC_BREAKPOINT</a></div><div class="ttdeci">#define VMCALL_SET_HIDDEN_CC_BREAKPOINT</div><div class="ttdoc">VMCALL to put hidden breakpoints (using EPT)</div><div class="ttdef"><b>Definition</b> Vmcall.h:124</div></div>
<div class="ttc" id="astruct___c_r3___t_y_p_e_html_a04eb96cc99b0458be739bcc9c640e08b"><div class="ttname"><a href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">_CR3_TYPE::Flags</a></div><div class="ttdeci">UINT64 Flags</div><div class="ttdef"><b>Definition</b> BasicTypes.h:133</div></div>
<div class="ttc" id="astruct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s_html"><div class="ttname"><a href="struct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s.html">_DIRECT_VMCALL_PARAMETERS</a></div><div class="ttdoc">Used for sending direct VMCALLs on the VMX root-mode.</div><div class="ttdef"><b>Definition</b> DataTypes.h:294</div></div>
<div class="ttc" id="astruct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s_html_a39944d056bfb507eee85169f70d88ef8"><div class="ttname"><a href="struct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s.html#a39944d056bfb507eee85169f70d88ef8">_DIRECT_VMCALL_PARAMETERS::OptionalParam2</a></div><div class="ttdeci">UINT64 OptionalParam2</div><div class="ttdef"><b>Definition</b> DataTypes.h:296</div></div>
<div class="ttc" id="astruct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s_html_afa70a893c4cfe5cb7db3e8647ddc032e"><div class="ttname"><a href="struct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s.html#afa70a893c4cfe5cb7db3e8647ddc032e">_DIRECT_VMCALL_PARAMETERS::OptionalParam1</a></div><div class="ttdeci">UINT64 OptionalParam1</div><div class="ttdef"><b>Definition</b> DataTypes.h:295</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a55a664f6c354dacfe2dd66c1ae4415e8" name="a55a664f6c354dacfe2dd66c1ae4415e8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a55a664f6c354dacfe2dd66c1ae4415e8">&#9670;&#160;</a></span>EptHookPerformMemoryOrInlineHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookPerformMemoryOrInlineHook </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_data_types_8h.html#ab19c4c1932f3ad9dfeb7168bab678ee0">EPT_HOOKS_ADDRESS_DETAILS_FOR_EPTHOOK2</a> *</td>          <td class="paramname"><span class="paramname"><em>EptHook2AddressDetails</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_data_types_8h.html#ad14bc163543c2acede2c878c50aeca14">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *</td>          <td class="paramname"><span class="paramname"><em>MemoryAddressDetails</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>ProcessId</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></td>          <td class="paramname"><span class="paramname"><em>EptHiddenHook2</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></td>          <td class="paramname"><span class="paramname"><em>ApplyDirectlyFromVmxRoot</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function allocates a buffer in VMX Non Root Mode and then invokes a VMCALL to set the hook. </p>
<p>this command uses hidden detours, if it calls from VMX root-mode directly, it should also invalidate EPT caches (by the caller)</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">EptHook2AddressDetails</td><td>The address details for inline EPT hooks </td></tr>
    <tr><td class="paramname">MemoryAddressDetails</td><td>The address details for monitor EPT hooks </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id to translate based on that process's cr3 </td></tr>
    <tr><td class="paramname">EptHiddenHook2</td><td>epthook2 style hook </td></tr>
    <tr><td class="paramname">ApplyDirectlyFromVmxRoot</td><td>should it be directly applied from VMX-root mode or not</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1376</span>{</div>
<div class="line"><span class="lineno"> 1377</span>    <a class="code hl_typedef" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> PageHookMask        = 0;</div>
<div class="line"><span class="lineno"> 1378</span>    PVOID  HookDetailsToVmcall = <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno"> 1379</span> </div>
<div class="line"><span class="lineno"> 1380</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1381</span>    <span class="comment">// Check for the features to avoid EPT Violation problems</span></div>
<div class="line"><span class="lineno"> 1382</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1383</span>    <span class="keywordflow">if</span> (MemoryAddressDetails != NULL)</div>
<div class="line"><span class="lineno"> 1384</span>    {</div>
<div class="line"><span class="lineno"> 1385</span>        HookDetailsToVmcall = MemoryAddressDetails;</div>
<div class="line"><span class="lineno"> 1386</span> </div>
<div class="line"><span class="lineno"> 1387</span>        <span class="keywordflow">if</span> (MemoryAddressDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html#af1b3604662e0d10b28c02b4f985621da">SetHookForExec</a> &amp;&amp;</div>
<div class="line"><span class="lineno"> 1388</span>            !<a class="code hl_variable" href="_global_variables_8h.html#a3c92f787270f29f40a4fb1b3440a3baa">g_CompatibilityCheck</a>.<a class="code hl_variable" href="struct___c_o_m_p_a_t_i_b_i_l_i_t_y___c_h_e_c_k_s___s_t_a_t_u_s.html#af68dba0dd8b9469e42d344f82fca8417">ExecuteOnlySupport</a>)</div>
<div class="line"><span class="lineno"> 1389</span>        {</div>
<div class="line"><span class="lineno"> 1390</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1391</span>            <span class="comment">// In the current design of hyperdbg we use execute-only pages</span></div>
<div class="line"><span class="lineno"> 1392</span>            <span class="comment">// to implement hidden hooks for exec page, so your processor doesn&#39;t</span></div>
<div class="line"><span class="lineno"> 1393</span>            <span class="comment">// have this feature and you have to implement it in other ways :(</span></div>
<div class="line"><span class="lineno"> 1394</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1395</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1396</span>        }</div>
<div class="line"><span class="lineno"> 1397</span> </div>
<div class="line"><span class="lineno"> 1398</span>        <span class="keywordflow">if</span> (!MemoryAddressDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html#a524bb61dcc2c90eb0bb237b793cac170">SetHookForWrite</a> &amp;&amp; MemoryAddressDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html#a1f367f5b7efe248dbd47274bef74234d">SetHookForRead</a>)</div>
<div class="line"><span class="lineno"> 1399</span>        {</div>
<div class="line"><span class="lineno"> 1400</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1401</span>            <span class="comment">// The hidden hook with Write Enable and Read Disabled will cause EPT violation!</span></div>
<div class="line"><span class="lineno"> 1402</span>            <span class="comment">// fixed</span></div>
<div class="line"><span class="lineno"> 1403</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1404</span>        }</div>
<div class="line"><span class="lineno"> 1405</span> </div>
<div class="line"><span class="lineno"> 1406</span>        <span class="keywordflow">if</span> (MemoryAddressDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html#a1f367f5b7efe248dbd47274bef74234d">SetHookForRead</a>)</div>
<div class="line"><span class="lineno"> 1407</span>        {</div>
<div class="line"><span class="lineno"> 1408</span>            PageHookMask |= <a class="code hl_define" href="_ept_8h.html#a57f919b94c67edb76b752a2ca83b534a">PAGE_ATTRIB_READ</a>;</div>
<div class="line"><span class="lineno"> 1409</span>        }</div>
<div class="line"><span class="lineno"> 1410</span>        <span class="keywordflow">if</span> (MemoryAddressDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html#a524bb61dcc2c90eb0bb237b793cac170">SetHookForWrite</a>)</div>
<div class="line"><span class="lineno"> 1411</span>        {</div>
<div class="line"><span class="lineno"> 1412</span>            PageHookMask |= <a class="code hl_define" href="_ept_8h.html#a6a23c222f617b62cc621b5482a378d8a">PAGE_ATTRIB_WRITE</a>;</div>
<div class="line"><span class="lineno"> 1413</span>        }</div>
<div class="line"><span class="lineno"> 1414</span>        <span class="keywordflow">if</span> (MemoryAddressDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html#af1b3604662e0d10b28c02b4f985621da">SetHookForExec</a>)</div>
<div class="line"><span class="lineno"> 1415</span>        {</div>
<div class="line"><span class="lineno"> 1416</span>            PageHookMask |= <a class="code hl_define" href="_ept_8h.html#a31b07aec49a907dc08696d9595c08e5f">PAGE_ATTRIB_EXEC</a>;</div>
<div class="line"><span class="lineno"> 1417</span>        }</div>
<div class="line"><span class="lineno"> 1418</span>    }</div>
<div class="line"><span class="lineno"> 1419</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (EptHook2AddressDetails != NULL)</div>
<div class="line"><span class="lineno"> 1420</span>    {</div>
<div class="line"><span class="lineno"> 1421</span>        HookDetailsToVmcall = EptHook2AddressDetails;</div>
<div class="line"><span class="lineno"> 1422</span> </div>
<div class="line"><span class="lineno"> 1423</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1424</span>        <span class="comment">// Initialize the list of ept hook detours if it&#39;s not already initialized</span></div>
<div class="line"><span class="lineno"> 1425</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1426</span>        <span class="keywordflow">if</span> (!<a class="code hl_variable" href="_global_variables_8h.html#a6e5074e59b6770a1b187d7e2d50f00bb">g_IsEptHook2sDetourListInitialized</a>)</div>
<div class="line"><span class="lineno"> 1427</span>        {</div>
<div class="line"><span class="lineno"> 1428</span>            <a class="code hl_variable" href="_global_variables_8h.html#a6e5074e59b6770a1b187d7e2d50f00bb">g_IsEptHook2sDetourListInitialized</a> = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1429</span> </div>
<div class="line"><span class="lineno"> 1430</span>            <a class="code hl_function" href="_windows_8h.html#ad211c1678754ed394322f51a9e909c4a">InitializeListHead</a>(&amp;<a class="code hl_variable" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a>);</div>
<div class="line"><span class="lineno"> 1431</span>        }</div>
<div class="line"><span class="lineno"> 1432</span> </div>
<div class="line"><span class="lineno"> 1433</span>        <span class="keywordflow">if</span> (EptHiddenHook2)</div>
<div class="line"><span class="lineno"> 1434</span>        {</div>
<div class="line"><span class="lineno"> 1435</span>            PageHookMask |= <a class="code hl_define" href="_ept_8h.html#a64a62553738e173543798af94f3958fb">PAGE_ATTRIB_EXEC_HIDDEN_HOOK</a>;</div>
<div class="line"><span class="lineno"> 1436</span>        }</div>
<div class="line"><span class="lineno"> 1437</span>    }</div>
<div class="line"><span class="lineno"> 1438</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1439</span>    {</div>
<div class="line"><span class="lineno"> 1440</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1441</span>        <span class="comment">// No details provided</span></div>
<div class="line"><span class="lineno"> 1442</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1443</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1444</span>    }</div>
<div class="line"><span class="lineno"> 1445</span> </div>
<div class="line"><span class="lineno"> 1446</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1447</span>    <span class="comment">// Check if mask is valid or not</span></div>
<div class="line"><span class="lineno"> 1448</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1449</span>    <span class="keywordflow">if</span> (PageHookMask == 0)</div>
<div class="line"><span class="lineno"> 1450</span>    {</div>
<div class="line"><span class="lineno"> 1451</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1452</span>        <span class="comment">// nothing to hook</span></div>
<div class="line"><span class="lineno"> 1453</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1454</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1455</span>    }</div>
<div class="line"><span class="lineno"> 1456</span> </div>
<div class="line"><span class="lineno"> 1457</span>    <span class="keywordflow">if</span> (ApplyDirectlyFromVmxRoot)</div>
<div class="line"><span class="lineno"> 1458</span>    {</div>
<div class="line"><span class="lineno"> 1459</span>        <a class="code hl_struct" href="struct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s.html">DIRECT_VMCALL_PARAMETERS</a> DirectVmcallOptions = {0};</div>
<div class="line"><span class="lineno"> 1460</span>        DirectVmcallOptions.<a class="code hl_variable" href="struct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s.html#afa70a893c4cfe5cb7db3e8647ddc032e">OptionalParam1</a>           = (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)HookDetailsToVmcall;</div>
<div class="line"><span class="lineno"> 1461</span>        DirectVmcallOptions.<a class="code hl_variable" href="struct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s.html#a39944d056bfb507eee85169f70d88ef8">OptionalParam2</a>           = PageHookMask;</div>
<div class="line"><span class="lineno"> 1462</span>        DirectVmcallOptions.<a class="code hl_variable" href="struct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s.html#a96645e12e6930efdcb96156de9ef9a74">OptionalParam3</a>           = <a class="code hl_function" href="_layout_8c.html#af74e610cf3ad5dd8c972f536f2809429">LayoutGetCurrentProcessCr3</a>().<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>; <span class="comment">// Process id is ignored while applied directly</span></div>
<div class="line"><span class="lineno"> 1463</span> </div>
<div class="line"><span class="lineno"> 1464</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="_direct_vmcall_8c.html#a8257be7d8db97cb55135f208ab58e7eb">DirectVmcallPerformVmcall</a>(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#ad166851f334095bff309813f73ea394e">CoreId</a>, <a class="code hl_define" href="_vmcall_8h.html#a2f893b27a9a2cedec9f4c499011dce0a">VMCALL_CHANGE_PAGE_ATTRIB</a>, &amp;DirectVmcallOptions) == STATUS_SUCCESS)</div>
<div class="line"><span class="lineno"> 1465</span>        {</div>
<div class="line"><span class="lineno"> 1466</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1467</span>        }</div>
<div class="line"><span class="lineno"> 1468</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1469</span>        {</div>
<div class="line"><span class="lineno"> 1470</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1471</span>        }</div>
<div class="line"><span class="lineno"> 1472</span>    }</div>
<div class="line"><span class="lineno"> 1473</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1474</span>    {</div>
<div class="line"><span class="lineno"> 1475</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a54291454c7d99c90bf5e19a939825634">VmxGetCurrentLaunchState</a>())</div>
<div class="line"><span class="lineno"> 1476</span>        {</div>
<div class="line"><span class="lineno"> 1477</span>            <span class="keywordflow">if</span> (<a class="code hl_function" href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a>(<a class="code hl_define" href="_vmcall_8h.html#a2f893b27a9a2cedec9f4c499011dce0a">VMCALL_CHANGE_PAGE_ATTRIB</a>,</div>
<div class="line"><span class="lineno"> 1478</span>                             (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)HookDetailsToVmcall,</div>
<div class="line"><span class="lineno"> 1479</span>                             PageHookMask,</div>
<div class="line"><span class="lineno"> 1480</span>                             <a class="code hl_function" href="_layout_8c.html#aba0911b8d51a6f7b74dd2bb70845c4b2">LayoutGetCr3ByProcessId</a>(ProcessId).Flags) == STATUS_SUCCESS)</div>
<div class="line"><span class="lineno"> 1481</span>            {</div>
<div class="line"><span class="lineno"> 1482</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1483</span>                <span class="comment">// Test log</span></div>
<div class="line"><span class="lineno"> 1484</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1485</span>                <span class="comment">// LogInfo(&quot;Hook applied from VMX Root Mode&quot;);</span></div>
<div class="line"><span class="lineno"> 1486</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1487</span> </div>
<div class="line"><span class="lineno"> 1488</span>                <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno"> 1489</span>                {</div>
<div class="line"><span class="lineno"> 1490</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1491</span>                    <span class="comment">// Now we have to notify all the core to invalidate their EPT</span></div>
<div class="line"><span class="lineno"> 1492</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1493</span>                    <a class="code hl_function" href="_broadcast_8c.html#a5be99a073a6003a06347aa85b832060f">BroadcastNotifyAllToInvalidateEptAllCores</a>();</div>
<div class="line"><span class="lineno"> 1494</span>                }</div>
<div class="line"><span class="lineno"> 1495</span>                <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1496</span>                {</div>
<div class="line"><span class="lineno"> 1497</span>                    <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a>(<span class="stringliteral">&quot;Err, unable to notify all cores to invalidate their TLB &quot;</span></div>
<div class="line"><span class="lineno"> 1498</span>                            <span class="stringliteral">&quot;caches as you called hook on vmx-root mode, however, the &quot;</span></div>
<div class="line"><span class="lineno"> 1499</span>                            <span class="stringliteral">&quot;hook is still works&quot;</span>);</div>
<div class="line"><span class="lineno"> 1500</span>                }</div>
<div class="line"><span class="lineno"> 1501</span> </div>
<div class="line"><span class="lineno"> 1502</span>                <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1503</span>            }</div>
<div class="line"><span class="lineno"> 1504</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1505</span>            {</div>
<div class="line"><span class="lineno"> 1506</span>                <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1507</span>            }</div>
<div class="line"><span class="lineno"> 1508</span>        }</div>
<div class="line"><span class="lineno"> 1509</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1510</span>        {</div>
<div class="line"><span class="lineno"> 1511</span>            <span class="keywordflow">if</span> (<a class="code hl_function" href="#aadbcf1945213c68375c8871dbecc3971">EptHookPerformPageHookMonitorAndInlineHook</a>(VCpu,</div>
<div class="line"><span class="lineno"> 1512</span>                                                           HookDetailsToVmcall,</div>
<div class="line"><span class="lineno"> 1513</span>                                                           <a class="code hl_function" href="_layout_8c.html#aba0911b8d51a6f7b74dd2bb70845c4b2">LayoutGetCr3ByProcessId</a>(ProcessId),</div>
<div class="line"><span class="lineno"> 1514</span>                                                           PageHookMask) == <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 1515</span>            {</div>
<div class="line"><span class="lineno"> 1516</span>                <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#abf506c814a6f717a87b5d808b828ef56">LogWarning</a>(<span class="stringliteral">&quot;Hook applied (VM has not launched)&quot;</span>);</div>
<div class="line"><span class="lineno"> 1517</span>                <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1518</span>            }</div>
<div class="line"><span class="lineno"> 1519</span>        }</div>
<div class="line"><span class="lineno"> 1520</span>    }</div>
<div class="line"><span class="lineno"> 1521</span> </div>
<div class="line"><span class="lineno"> 1522</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1523</span>    <span class="comment">// There was a error, we shouldn&#39;t reach here</span></div>
<div class="line"><span class="lineno"> 1524</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1525</span>    <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#abf506c814a6f717a87b5d808b828ef56">LogWarning</a>(<span class="stringliteral">&quot;Err, hook was not applied&quot;</span>);</div>
<div class="line"><span class="lineno"> 1526</span> </div>
<div class="line"><span class="lineno"> 1527</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1528</span>}</div>
<div class="ttc" id="a_direct_vmcall_8c_html_a8257be7d8db97cb55135f208ab58e7eb"><div class="ttname"><a href="_direct_vmcall_8c.html#a8257be7d8db97cb55135f208ab58e7eb">DirectVmcallPerformVmcall</a></div><div class="ttdeci">NTSTATUS DirectVmcallPerformVmcall(UINT32 CoreId, UINT64 VmcallNumber, DIRECT_VMCALL_PARAMETERS *DirectVmcallOptions)</div><div class="ttdoc">routines for performing a direct VMCALL</div><div class="ttdef"><b>Definition</b> DirectVmcall.c:45</div></div>
<div class="ttc" id="a_ept_8h_html_a31b07aec49a907dc08696d9595c08e5f"><div class="ttname"><a href="_ept_8h.html#a31b07aec49a907dc08696d9595c08e5f">PAGE_ATTRIB_EXEC</a></div><div class="ttdeci">#define PAGE_ATTRIB_EXEC</div><div class="ttdef"><b>Definition</b> Ept.h:24</div></div>
<div class="ttc" id="a_ept_8h_html_a57f919b94c67edb76b752a2ca83b534a"><div class="ttname"><a href="_ept_8h.html#a57f919b94c67edb76b752a2ca83b534a">PAGE_ATTRIB_READ</a></div><div class="ttdeci">#define PAGE_ATTRIB_READ</div><div class="ttdoc">Page attributes for internal use.</div><div class="ttdef"><b>Definition</b> Ept.h:22</div></div>
<div class="ttc" id="a_ept_8h_html_a64a62553738e173543798af94f3958fb"><div class="ttname"><a href="_ept_8h.html#a64a62553738e173543798af94f3958fb">PAGE_ATTRIB_EXEC_HIDDEN_HOOK</a></div><div class="ttdeci">#define PAGE_ATTRIB_EXEC_HIDDEN_HOOK</div><div class="ttdef"><b>Definition</b> Ept.h:25</div></div>
<div class="ttc" id="a_ept_8h_html_a6a23c222f617b62cc621b5482a378d8a"><div class="ttname"><a href="_ept_8h.html#a6a23c222f617b62cc621b5482a378d8a">PAGE_ATTRIB_WRITE</a></div><div class="ttdeci">#define PAGE_ATTRIB_WRITE</div><div class="ttdef"><b>Definition</b> Ept.h:23</div></div>
<div class="ttc" id="a_ept_hook_8c_html_aadbcf1945213c68375c8871dbecc3971"><div class="ttname"><a href="#aadbcf1945213c68375c8871dbecc3971">EptHookPerformPageHookMonitorAndInlineHook</a></div><div class="ttdeci">BOOLEAN EptHookPerformPageHookMonitorAndInlineHook(VIRTUAL_MACHINE_STATE *VCpu, PVOID HookingDetails, CR3_TYPE ProcessCr3, UINT32 PageHookMask)</div><div class="ttdoc">The main function that performs EPT page hook with hidden detours and monitor.</div><div class="ttdef"><b>Definition</b> EptHook.c:980</div></div>
<div class="ttc" id="a_global_variables_8h_html_a3c92f787270f29f40a4fb1b3440a3baa"><div class="ttname"><a href="_global_variables_8h.html#a3c92f787270f29f40a4fb1b3440a3baa">g_CompatibilityCheck</a></div><div class="ttdeci">COMPATIBILITY_CHECKS_STATUS g_CompatibilityCheck</div><div class="ttdoc">Different attributes and compatibility checks of the current processor.</div><div class="ttdef"><b>Definition</b> GlobalVariables.h:26</div></div>
<div class="ttc" id="a_global_variables_8h_html_a6e5074e59b6770a1b187d7e2d50f00bb"><div class="ttname"><a href="_global_variables_8h.html#a6e5074e59b6770a1b187d7e2d50f00bb">g_IsEptHook2sDetourListInitialized</a></div><div class="ttdeci">BOOLEAN g_IsEptHook2sDetourListInitialized</div><div class="ttdoc">List header of hidden hooks detour.</div><div class="ttdef"><b>Definition</b> GlobalVariables.h:68</div></div>
<div class="ttc" id="a_hyper_dbg_hyper_log_intrinsics_8h_html_a97b0adbd65790fb90734daa8e5245a04"><div class="ttname"><a href="_hyper_dbg_hyper_log_intrinsics_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a></div><div class="ttdeci">#define LogInfo(format,...)</div><div class="ttdoc">Define log variables.</div><div class="ttdef"><b>Definition</b> HyperDbgHyperLogIntrinsics.h:71</div></div>
<div class="ttc" id="a_hyper_dbg_hyper_log_intrinsics_8h_html_abf506c814a6f717a87b5d808b828ef56"><div class="ttname"><a href="_hyper_dbg_hyper_log_intrinsics_8h.html#abf506c814a6f717a87b5d808b828ef56">LogWarning</a></div><div class="ttdeci">#define LogWarning(format,...)</div><div class="ttdoc">Log in the case of warning.</div><div class="ttdef"><b>Definition</b> HyperDbgHyperLogIntrinsics.h:99</div></div>
<div class="ttc" id="a_vmcall_8h_html_a2f893b27a9a2cedec9f4c499011dce0a"><div class="ttname"><a href="_vmcall_8h.html#a2f893b27a9a2cedec9f4c499011dce0a">VMCALL_CHANGE_PAGE_ATTRIB</a></div><div class="ttdeci">#define VMCALL_CHANGE_PAGE_ATTRIB</div><div class="ttdoc">VMCALL to Hook Change the attribute bits of the EPT Table.</div><div class="ttdef"><b>Definition</b> Vmcall.h:34</div></div>
<div class="ttc" id="a_vmx_8c_html_a54291454c7d99c90bf5e19a939825634"><div class="ttname"><a href="_vmx_8c.html#a54291454c7d99c90bf5e19a939825634">VmxGetCurrentLaunchState</a></div><div class="ttdeci">BOOLEAN VmxGetCurrentLaunchState()</div><div class="ttdoc">Check if the VMX is launched or not.</div><div class="ttdef"><b>Definition</b> Vmx.c:246</div></div>
<div class="ttc" id="a_windows_8h_html_ad211c1678754ed394322f51a9e909c4a"><div class="ttname"><a href="_windows_8h.html#ad211c1678754ed394322f51a9e909c4a">InitializeListHead</a></div><div class="ttdeci">FORCEINLINE VOID InitializeListHead(_Out_ PLIST_ENTRY ListHead)</div><div class="ttdef"><b>Definition</b> Windows.h:41</div></div>
<div class="ttc" id="astruct___c_o_m_p_a_t_i_b_i_l_i_t_y___c_h_e_c_k_s___s_t_a_t_u_s_html_af68dba0dd8b9469e42d344f82fca8417"><div class="ttname"><a href="struct___c_o_m_p_a_t_i_b_i_l_i_t_y___c_h_e_c_k_s___s_t_a_t_u_s.html#af68dba0dd8b9469e42d344f82fca8417">_COMPATIBILITY_CHECKS_STATUS::ExecuteOnlySupport</a></div><div class="ttdeci">BOOLEAN ExecuteOnlySupport</div><div class="ttdef"><b>Definition</b> CompatibilityChecks.h:29</div></div>
<div class="ttc" id="astruct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s_html_a96645e12e6930efdcb96156de9ef9a74"><div class="ttname"><a href="struct___d_i_r_e_c_t___v_m_c_a_l_l___p_a_r_a_m_e_t_e_r_s.html#a96645e12e6930efdcb96156de9ef9a74">_DIRECT_VMCALL_PARAMETERS::OptionalParam3</a></div><div class="ttdeci">UINT64 OptionalParam3</div><div class="ttdef"><b>Definition</b> DataTypes.h:297</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r_html_a1f367f5b7efe248dbd47274bef74234d"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html#a1f367f5b7efe248dbd47274bef74234d">_EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR::SetHookForRead</a></div><div class="ttdeci">BOOLEAN SetHookForRead</div><div class="ttdef"><b>Definition</b> DataTypes.h:334</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r_html_a524bb61dcc2c90eb0bb237b793cac170"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html#a524bb61dcc2c90eb0bb237b793cac170">_EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR::SetHookForWrite</a></div><div class="ttdeci">BOOLEAN SetHookForWrite</div><div class="ttdef"><b>Definition</b> DataTypes.h:335</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r_html_af1b3604662e0d10b28c02b4f985621da"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html#af1b3604662e0d10b28c02b4f985621da">_EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR::SetHookForExec</a></div><div class="ttdeci">BOOLEAN SetHookForExec</div><div class="ttdef"><b>Definition</b> DataTypes.h:336</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a32f950fc6247cece400187114bac26ab" name="a32f950fc6247cece400187114bac26ab"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a32f950fc6247cece400187114bac26ab">&#9670;&#160;</a></span>EptHookPerformPageHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookPerformPageHook </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>TargetAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a></td>          <td class="paramname"><span class="paramname"><em>ProcessCr3</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The main function that performs EPT page hook with hidden breakpoint. </p>
<p>Hook in VMX Root Mode with hidden breakpoints (A pre-allocated buffer should be available)</p>
<p>This function returns false in VMX Non-Root Mode if the VM is already initialized This function have to be called through a VMCALL in VMX Root Mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">ProcessCr3</td><td>The process cr3 to translate based on that process's cr3 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  477</span>{</div>
<div class="line"><span class="lineno">  478</span>    SIZE_T                   PhysicalBaseAddress;</div>
<div class="line"><span class="lineno">  479</span>    PVOID                    VirtualTarget;</div>
<div class="line"><span class="lineno">  480</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a> * HookedEntry = <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno">  481</span> </div>
<div class="line"><span class="lineno">  482</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  483</span>    <span class="comment">// Translate the page from a physical address to virtual so we can read its memory.</span></div>
<div class="line"><span class="lineno">  484</span>    <span class="comment">// This function will return NULL if the physical address was not already mapped in</span></div>
<div class="line"><span class="lineno">  485</span>    <span class="comment">// virtual memory.</span></div>
<div class="line"><span class="lineno">  486</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  487</span>    VirtualTarget = <a class="code hl_define" href="libhyperdbg_2header_2_common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(TargetAddress);</div>
<div class="line"><span class="lineno">  488</span> </div>
<div class="line"><span class="lineno">  489</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  490</span>    <span class="comment">// Here we have to change the CR3, it is because we are in SYSTEM process</span></div>
<div class="line"><span class="lineno">  491</span>    <span class="comment">// and if the target address is not mapped in SYSTEM address space (e.g</span></div>
<div class="line"><span class="lineno">  492</span>    <span class="comment">// user mode address of another process) then the translation is invalid</span></div>
<div class="line"><span class="lineno">  493</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  494</span> </div>
<div class="line"><span class="lineno">  495</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  496</span>    <span class="comment">// Find cr3 of target core</span></div>
<div class="line"><span class="lineno">  497</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  498</span>    PhysicalBaseAddress = (SIZE_T)<a class="code hl_function" href="_conversion_8c.html#ace32f507228d4b1b3b8e53f82ac09402">VirtualAddressToPhysicalAddressByProcessCr3</a>(VirtualTarget, ProcessCr3);</div>
<div class="line"><span class="lineno">  499</span> </div>
<div class="line"><span class="lineno">  500</span>    <span class="keywordflow">if</span> (!PhysicalBaseAddress)</div>
<div class="line"><span class="lineno">  501</span>    {</div>
<div class="line"><span class="lineno">  502</span>        <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="_error_codes_8h.html#ac1b8dbae6748b88abe05844e42c29952">DEBUGGER_ERROR_INVALID_ADDRESS</a>);</div>
<div class="line"><span class="lineno">  503</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  504</span>    }</div>
<div class="line"><span class="lineno">  505</span> </div>
<div class="line"><span class="lineno">  506</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  507</span>    <span class="comment">// try to see if we can find the address</span></div>
<div class="line"><span class="lineno">  508</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  509</span> </div>
<div class="line"><span class="lineno">  510</span>    HookedEntry = EptHookFindByPhysAddress(PhysicalBaseAddress);</div>
<div class="line"><span class="lineno">  511</span> </div>
<div class="line"><span class="lineno">  512</span>    <span class="keywordflow">if</span> (HookedEntry != NULL)</div>
<div class="line"><span class="lineno">  513</span>    {</div>
<div class="line"><span class="lineno">  514</span>        <span class="keywordflow">return</span> EptHookUpdateHookPage(TargetAddress, HookedEntry);</div>
<div class="line"><span class="lineno">  515</span>    }</div>
<div class="line"><span class="lineno">  516</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  517</span>    {</div>
<div class="line"><span class="lineno">  518</span>        <span class="keywordflow">return</span> EptHookCreateHookPage(VCpu, TargetAddress, ProcessCr3);</div>
<div class="line"><span class="lineno">  519</span>    }</div>
<div class="line"><span class="lineno">  520</span>}</div>
<div class="ttc" id="a_callback_8c_html_a68d4847c16adb5d0d6f8a5513a299029"><div class="ttname"><a href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a></div><div class="ttdeci">VOID VmmCallbackSetLastError(UINT32 LastError)</div><div class="ttdoc">routine callback to set last error</div><div class="ttdef"><b>Definition</b> Callback.c:175</div></div>
<div class="ttc" id="a_conversion_8c_html_ace32f507228d4b1b3b8e53f82ac09402"><div class="ttname"><a href="_conversion_8c.html#ace32f507228d4b1b3b8e53f82ac09402">VirtualAddressToPhysicalAddressByProcessCr3</a></div><div class="ttdeci">_Use_decl_annotations_ UINT64 VirtualAddressToPhysicalAddressByProcessCr3(PVOID VirtualAddress, CR3_TYPE TargetCr3)</div><div class="ttdoc">Converts Virtual Address to Physical Address based on a specific process's kernel cr3.</div><div class="ttdef"><b>Definition</b> Conversion.c:215</div></div>
<div class="ttc" id="a_error_codes_8h_html_ac1b8dbae6748b88abe05844e42c29952"><div class="ttname"><a href="_error_codes_8h.html#ac1b8dbae6748b88abe05844e42c29952">DEBUGGER_ERROR_INVALID_ADDRESS</a></div><div class="ttdeci">#define DEBUGGER_ERROR_INVALID_ADDRESS</div><div class="ttdoc">error, invalid address specified for debugger</div><div class="ttdef"><b>Definition</b> ErrorCodes.h:63</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="aadbcf1945213c68375c8871dbecc3971" name="aadbcf1945213c68375c8871dbecc3971"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aadbcf1945213c68375c8871dbecc3971">&#9670;&#160;</a></span>EptHookPerformPageHookMonitorAndInlineHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookPerformPageHookMonitorAndInlineHook </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID</td>          <td class="paramname"><span class="paramname"><em>HookingDetails</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a></td>          <td class="paramname"><span class="paramname"><em>ProcessCr3</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>PageHookMask</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The main function that performs EPT page hook with hidden detours and monitor. </p>
<p>Hook in VMX Root Mode with hidden detours and monitor (A pre-allocated buffer should be available)</p>
<p>This function returns false in VMX Non-Root Mode if the VM is already initialized This function have to be called through a VMCALL in VMX Root Mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">HookingDetails</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">ProcessCr3</td><td>The process cr3 to translate based on that process's cr3 </td></tr>
    <tr><td class="paramname">PageHookMask</td><td>Mask hook of the page</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  984</span>{</div>
<div class="line"><span class="lineno">  985</span>    <a class="code hl_typedef" href="_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                   ProcessorsCount;</div>
<div class="line"><span class="lineno">  986</span>    <a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a7f2689338799db6564d2b9cb35d7d596">EPT_PML1_ENTRY</a>          ChangedEntry;</div>
<div class="line"><span class="lineno">  987</span>    SIZE_T                  PhysicalBaseAddress;</div>
<div class="line"><span class="lineno">  988</span>    PVOID                   AlignedTargetVaOrPa;</div>
<div class="line"><span class="lineno">  989</span>    PVOID                   TargetBuffer;</div>
<div class="line"><span class="lineno">  990</span>    PVOID                   TargetAddress;</div>
<div class="line"><span class="lineno">  991</span>    PVOID                   HookFunction;</div>
<div class="line"><span class="lineno">  992</span>    <a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>                  TargetAddressInSafeMemory;</div>
<div class="line"><span class="lineno">  993</span>    <a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a>         TargetPage;</div>
<div class="line"><span class="lineno">  994</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedPage;</div>
<div class="line"><span class="lineno">  995</span>    <a class="code hl_struct" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a>                Cr3OfCurrentProcess;</div>
<div class="line"><span class="lineno">  996</span>    PLIST_ENTRY             TempList      = 0;</div>
<div class="line"><span class="lineno">  997</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry   = <a class="code hl_function" href="namespacetest-case-generator.html#a9a4eff80432bb93d2796381610dd86c3">NULL</a>;</div>
<div class="line"><span class="lineno">  998</span>    <a class="code hl_typedef" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>                 UnsetExecute  = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  999</span>    <a class="code hl_typedef" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>                 UnsetRead     = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1000</span>    <a class="code hl_typedef" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>                 UnsetWrite    = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1001</span>    <a class="code hl_typedef" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>                 EptHiddenHook = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1002</span> </div>
<div class="line"><span class="lineno"> 1003</span>    UnsetRead     = (PageHookMask &amp; <a class="code hl_define" href="_ept_8h.html#a57f919b94c67edb76b752a2ca83b534a">PAGE_ATTRIB_READ</a>) ? <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> : <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1004</span>    UnsetWrite    = (PageHookMask &amp; <a class="code hl_define" href="_ept_8h.html#a6a23c222f617b62cc621b5482a378d8a">PAGE_ATTRIB_WRITE</a>) ? <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> : <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1005</span>    UnsetExecute  = (PageHookMask &amp; <a class="code hl_define" href="_ept_8h.html#a31b07aec49a907dc08696d9595c08e5f">PAGE_ATTRIB_EXEC</a>) ? <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> : <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1006</span>    EptHiddenHook = (PageHookMask &amp; <a class="code hl_define" href="_ept_8h.html#a64a62553738e173543798af94f3958fb">PAGE_ATTRIB_EXEC_HIDDEN_HOOK</a>) ? <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> : <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1007</span> </div>
<div class="line"><span class="lineno"> 1008</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1009</span>    <span class="comment">// Get number of processors</span></div>
<div class="line"><span class="lineno"> 1010</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1011</span>    ProcessorsCount = KeQueryActiveProcessorCount(0);</div>
<div class="line"><span class="lineno"> 1012</span> </div>
<div class="line"><span class="lineno"> 1013</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1014</span>    <span class="comment">// Translate the page from a physical address to virtual so we can read its memory.</span></div>
<div class="line"><span class="lineno"> 1015</span>    <span class="comment">// This function will return NULL if the physical address was not already mapped in</span></div>
<div class="line"><span class="lineno"> 1016</span>    <span class="comment">// virtual memory.</span></div>
<div class="line"><span class="lineno"> 1017</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1018</span>    <span class="keywordflow">if</span> (EptHiddenHook)</div>
<div class="line"><span class="lineno"> 1019</span>    {</div>
<div class="line"><span class="lineno"> 1020</span>        TargetAddress = ((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_EPTHOOK2</a> *)HookingDetails)-&gt;TargetAddress;</div>
<div class="line"><span class="lineno"> 1021</span>    }</div>
<div class="line"><span class="lineno"> 1022</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1023</span>    {</div>
<div class="line"><span class="lineno"> 1024</span>        TargetAddress = (PVOID)((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *)HookingDetails)-&gt;StartAddress;</div>
<div class="line"><span class="lineno"> 1025</span>    }</div>
<div class="line"><span class="lineno"> 1026</span> </div>
<div class="line"><span class="lineno"> 1027</span>    AlignedTargetVaOrPa = <a class="code hl_define" href="libhyperdbg_2header_2_common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(TargetAddress);</div>
<div class="line"><span class="lineno"> 1028</span> </div>
<div class="line"><span class="lineno"> 1029</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1030</span>    <span class="comment">// Here we have to change the CR3, it is because we are in SYSTEM process</span></div>
<div class="line"><span class="lineno"> 1031</span>    <span class="comment">// and if the target address is not mapped in SYSTEM address space (e.g</span></div>
<div class="line"><span class="lineno"> 1032</span>    <span class="comment">// user mode address of another process) then the translation is invalid</span></div>
<div class="line"><span class="lineno"> 1033</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1034</span> </div>
<div class="line"><span class="lineno"> 1035</span>    <span class="keywordflow">if</span> (!EptHiddenHook &amp;&amp;</div>
<div class="line"><span class="lineno"> 1036</span>        ((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *)HookingDetails)-&gt;MemoryType == <a class="code hl_enumvalue" href="_data_types_8h.html#a16edc968c8587e5c31a8b065c390a3c0ac22f516e18d6e5e5b364e2c6e9f07993">DEBUGGER_MEMORY_HOOK_PHYSICAL_ADDRESS</a>)</div>
<div class="line"><span class="lineno"> 1037</span>    {</div>
<div class="line"><span class="lineno"> 1038</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1039</span>        <span class="comment">// The address itself is a physical address, no need for conversion</span></div>
<div class="line"><span class="lineno"> 1040</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1041</span>        PhysicalBaseAddress = (SIZE_T)AlignedTargetVaOrPa;</div>
<div class="line"><span class="lineno"> 1042</span>    }</div>
<div class="line"><span class="lineno"> 1043</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1044</span>    {</div>
<div class="line"><span class="lineno"> 1045</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1046</span>        <span class="comment">// based on the CR3 of target core</span></div>
<div class="line"><span class="lineno"> 1047</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1048</span>        PhysicalBaseAddress = (SIZE_T)<a class="code hl_function" href="_conversion_8c.html#ace32f507228d4b1b3b8e53f82ac09402">VirtualAddressToPhysicalAddressByProcessCr3</a>(AlignedTargetVaOrPa, ProcessCr3);</div>
<div class="line"><span class="lineno"> 1049</span>    }</div>
<div class="line"><span class="lineno"> 1050</span> </div>
<div class="line"><span class="lineno"> 1051</span>    <span class="keywordflow">if</span> (!PhysicalBaseAddress)</div>
<div class="line"><span class="lineno"> 1052</span>    {</div>
<div class="line"><span class="lineno"> 1053</span>        <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="_error_codes_8h.html#ac1b8dbae6748b88abe05844e42c29952">DEBUGGER_ERROR_INVALID_ADDRESS</a>);</div>
<div class="line"><span class="lineno"> 1054</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1055</span>    }</div>
<div class="line"><span class="lineno"> 1056</span> </div>
<div class="line"><span class="lineno"> 1057</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1058</span>    <span class="comment">// try to see if we can find the address</span></div>
<div class="line"><span class="lineno"> 1059</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1060</span>    TempList = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>;</div>
<div class="line"><span class="lineno"> 1061</span> </div>
<div class="line"><span class="lineno"> 1062</span>    <span class="keywordflow">while</span> (&amp;<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a> != TempList-&gt;Flink)</div>
<div class="line"><span class="lineno"> 1063</span>    {</div>
<div class="line"><span class="lineno"> 1064</span>        TempList    = TempList-&gt;Flink;</div>
<div class="line"><span class="lineno"> 1065</span>        HookedEntry = CONTAINING_RECORD(TempList, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList);</div>
<div class="line"><span class="lineno"> 1066</span> </div>
<div class="line"><span class="lineno"> 1067</span>        <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a> == PhysicalBaseAddress)</div>
<div class="line"><span class="lineno"> 1068</span>        {</div>
<div class="line"><span class="lineno"> 1069</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1070</span>            <span class="comment">// Means that we find the address and !epthook2 doesn&#39;t support</span></div>
<div class="line"><span class="lineno"> 1071</span>            <span class="comment">// multiple breakpoints in on page</span></div>
<div class="line"><span class="lineno"> 1072</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1073</span>            <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="_error_codes_8h.html#a9697a726e353b61b5e02c10395f3f382">DEBUGGER_ERROR_EPT_MULTIPLE_HOOKS_IN_A_SINGLE_PAGE</a>);</div>
<div class="line"><span class="lineno"> 1074</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1075</span>        }</div>
<div class="line"><span class="lineno"> 1076</span>    }</div>
<div class="line"><span class="lineno"> 1077</span> </div>
<div class="line"><span class="lineno"> 1078</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1079</span>    <span class="comment">// Save the detail of hooked page to keep track of it</span></div>
<div class="line"><span class="lineno"> 1080</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1081</span>    HookedPage = (<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a> *)<a class="code hl_function" href="_pool_manager_8c.html#a065841edb44331344b1a71a2ea397923">PoolManagerRequestPool</a>(<a class="code hl_enumvalue" href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a1c4249f84cf779cd4cdd72ee27de08c1">TRACKING_HOOKED_PAGES</a>, <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>));</div>
<div class="line"><span class="lineno"> 1082</span> </div>
<div class="line"><span class="lineno"> 1083</span>    <span class="keywordflow">if</span> (!HookedPage)</div>
<div class="line"><span class="lineno"> 1084</span>    {</div>
<div class="line"><span class="lineno"> 1085</span>        <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="_error_codes_8h.html#a35966c13fc80dc6d9055d5b7f46f6ef6">DEBUGGER_ERROR_PRE_ALLOCATED_BUFFER_IS_EMPTY</a>);</div>
<div class="line"><span class="lineno"> 1086</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1087</span>    }</div>
<div class="line"><span class="lineno"> 1088</span> </div>
<div class="line"><span class="lineno"> 1089</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1090</span>    <span class="comment">// Save the virtual address</span></div>
<div class="line"><span class="lineno"> 1091</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1092</span>    HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">VirtualAddress</a> = (<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)TargetAddress;</div>
<div class="line"><span class="lineno"> 1093</span> </div>
<div class="line"><span class="lineno"> 1094</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1095</span>    <span class="comment">// Save the physical address</span></div>
<div class="line"><span class="lineno"> 1096</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1097</span>    HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a> = PhysicalBaseAddress;</div>
<div class="line"><span class="lineno"> 1098</span> </div>
<div class="line"><span class="lineno"> 1099</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1100</span>    <span class="comment">// If it&#39;s a monitor hook, then we need to hold the address of the start</span></div>
<div class="line"><span class="lineno"> 1101</span>    <span class="comment">// physical address as well as the end physical address, plus tagging information</span></div>
<div class="line"><span class="lineno"> 1102</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1103</span>    <span class="keywordflow">if</span> (!EptHiddenHook)</div>
<div class="line"><span class="lineno"> 1104</span>    {</div>
<div class="line"><span class="lineno"> 1105</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1106</span>        <span class="comment">// Save the target tag</span></div>
<div class="line"><span class="lineno"> 1107</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1108</span>        HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac39ed4ba1bfdc7f59b54cd3b0675c007">HookingTag</a> = ((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *)HookingDetails)-&gt;Tag;</div>
<div class="line"><span class="lineno"> 1109</span> </div>
<div class="line"><span class="lineno"> 1110</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1111</span>        <span class="comment">// Save the start of the target physical address</span></div>
<div class="line"><span class="lineno"> 1112</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1113</span>        <span class="keywordflow">if</span> (((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *)HookingDetails)-&gt;MemoryType == <a class="code hl_enumvalue" href="_data_types_8h.html#a16edc968c8587e5c31a8b065c390a3c0ac22f516e18d6e5e5b364e2c6e9f07993">DEBUGGER_MEMORY_HOOK_PHYSICAL_ADDRESS</a>)</div>
<div class="line"><span class="lineno"> 1114</span>        {</div>
<div class="line"><span class="lineno"> 1115</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1116</span>            <span class="comment">// Physical address</span></div>
<div class="line"><span class="lineno"> 1117</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1118</span>            HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aa0bf8c2c8384010e9ed9f2e24bf2f3e4">StartOfTargetPhysicalAddress</a> = (SIZE_T)(((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *)HookingDetails)-&gt;StartAddress);</div>
<div class="line"><span class="lineno"> 1119</span>        }</div>
<div class="line"><span class="lineno"> 1120</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1121</span>        {</div>
<div class="line"><span class="lineno"> 1122</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1123</span>            <span class="comment">// Virtual address</span></div>
<div class="line"><span class="lineno"> 1124</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1125</span>            HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aa0bf8c2c8384010e9ed9f2e24bf2f3e4">StartOfTargetPhysicalAddress</a> = (SIZE_T)<a class="code hl_function" href="_conversion_8c.html#ace32f507228d4b1b3b8e53f82ac09402">VirtualAddressToPhysicalAddressByProcessCr3</a>(</div>
<div class="line"><span class="lineno"> 1126</span>                (PVOID)(((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *)HookingDetails)-&gt;StartAddress),</div>
<div class="line"><span class="lineno"> 1127</span>                ProcessCr3);</div>
<div class="line"><span class="lineno"> 1128</span>        }</div>
<div class="line"><span class="lineno"> 1129</span> </div>
<div class="line"><span class="lineno"> 1130</span>        <span class="keywordflow">if</span> (!HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aa0bf8c2c8384010e9ed9f2e24bf2f3e4">StartOfTargetPhysicalAddress</a>)</div>
<div class="line"><span class="lineno"> 1131</span>        {</div>
<div class="line"><span class="lineno"> 1132</span>            <a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)HookedPage);</div>
<div class="line"><span class="lineno"> 1133</span> </div>
<div class="line"><span class="lineno"> 1134</span>            <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="_error_codes_8h.html#ac1b8dbae6748b88abe05844e42c29952">DEBUGGER_ERROR_INVALID_ADDRESS</a>);</div>
<div class="line"><span class="lineno"> 1135</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1136</span>        }</div>
<div class="line"><span class="lineno"> 1137</span> </div>
<div class="line"><span class="lineno"> 1138</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1139</span>        <span class="comment">// Save the end of the target physical address</span></div>
<div class="line"><span class="lineno"> 1140</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1141</span>        <span class="keywordflow">if</span> (((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *)HookingDetails)-&gt;MemoryType == <a class="code hl_enumvalue" href="_data_types_8h.html#a16edc968c8587e5c31a8b065c390a3c0ac22f516e18d6e5e5b364e2c6e9f07993">DEBUGGER_MEMORY_HOOK_PHYSICAL_ADDRESS</a>)</div>
<div class="line"><span class="lineno"> 1142</span>        {</div>
<div class="line"><span class="lineno"> 1143</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1144</span>            <span class="comment">// Physical address</span></div>
<div class="line"><span class="lineno"> 1145</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1146</span>            HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aa01091e78a33ffed5bc4c6936ca0e736">EndOfTargetPhysicalAddress</a> = (SIZE_T)(((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *)HookingDetails)-&gt;EndAddress);</div>
<div class="line"><span class="lineno"> 1147</span>        }</div>
<div class="line"><span class="lineno"> 1148</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1149</span>        {</div>
<div class="line"><span class="lineno"> 1150</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1151</span>            <span class="comment">// Virtual address</span></div>
<div class="line"><span class="lineno"> 1152</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1153</span>            HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aa01091e78a33ffed5bc4c6936ca0e736">EndOfTargetPhysicalAddress</a> = (SIZE_T)<a class="code hl_function" href="_conversion_8c.html#ace32f507228d4b1b3b8e53f82ac09402">VirtualAddressToPhysicalAddressByProcessCr3</a>(</div>
<div class="line"><span class="lineno"> 1154</span>                (PVOID)(((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a> *)HookingDetails)-&gt;EndAddress),</div>
<div class="line"><span class="lineno"> 1155</span>                ProcessCr3);</div>
<div class="line"><span class="lineno"> 1156</span>        }</div>
<div class="line"><span class="lineno"> 1157</span> </div>
<div class="line"><span class="lineno"> 1158</span>        <span class="keywordflow">if</span> (!HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aa01091e78a33ffed5bc4c6936ca0e736">EndOfTargetPhysicalAddress</a>)</div>
<div class="line"><span class="lineno"> 1159</span>        {</div>
<div class="line"><span class="lineno"> 1160</span>            <a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)HookedPage);</div>
<div class="line"><span class="lineno"> 1161</span> </div>
<div class="line"><span class="lineno"> 1162</span>            <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="_error_codes_8h.html#ac1b8dbae6748b88abe05844e42c29952">DEBUGGER_ERROR_INVALID_ADDRESS</a>);</div>
<div class="line"><span class="lineno"> 1163</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1164</span>        }</div>
<div class="line"><span class="lineno"> 1165</span>    }</div>
<div class="line"><span class="lineno"> 1166</span> </div>
<div class="line"><span class="lineno"> 1167</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1168</span>    <span class="comment">// Fake page content physical address</span></div>
<div class="line"><span class="lineno"> 1169</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1170</span>    HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a325edda9c8d49c2f44319627d86d4a88">PhysicalBaseAddressOfFakePageContents</a> = (SIZE_T)<a class="code hl_function" href="_conversion_8c.html#ab7aedff95075e77cd8fbe128f01d2853">VirtualAddressToPhysicalAddress</a>(&amp;HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>[0]) / <a class="code hl_define" href="libhyperdbg_2header_2_common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a>;</div>
<div class="line"><span class="lineno"> 1171</span> </div>
<div class="line"><span class="lineno"> 1172</span>    <span class="keywordflow">if</span> (EptHiddenHook)</div>
<div class="line"><span class="lineno"> 1173</span>    {</div>
<div class="line"><span class="lineno"> 1174</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1175</span>        <span class="comment">// Show that entry has hidden hooks for execution</span></div>
<div class="line"><span class="lineno"> 1176</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1177</span>        HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a40f5606fe57295d12c430ce08421e544">IsExecutionHook</a> = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1178</span> </div>
<div class="line"><span class="lineno"> 1179</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1180</span>        <span class="comment">// Switch to target process</span></div>
<div class="line"><span class="lineno"> 1181</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1182</span>        Cr3OfCurrentProcess = <a class="code hl_function" href="_switch_layout_8c.html#a25d1e7a8c5f5c7dd0c77e160c03b6d5d">SwitchToProcessMemoryLayoutByCr3</a>(ProcessCr3);</div>
<div class="line"><span class="lineno"> 1183</span> </div>
<div class="line"><span class="lineno"> 1184</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1185</span>        <span class="comment">// Copy the content to the fake page</span></div>
<div class="line"><span class="lineno"> 1186</span>        <span class="comment">// The following line can&#39;t be used in user mode addresses</span></div>
<div class="line"><span class="lineno"> 1187</span>        <span class="comment">// RtlCopyBytes(&amp;HookedPage-&gt;FakePageContents, VirtualTarget, PAGE_SIZE);</span></div>
<div class="line"><span class="lineno"> 1188</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1189</span>        <a class="code hl_function" href="_memory_mapper_8c.html#ac3c23d5644111a6be18ca274f448e9ff">MemoryMapperReadMemorySafe</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)AlignedTargetVaOrPa, &amp;HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>, <a class="code hl_define" href="libhyperdbg_2header_2_common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a>);</div>
<div class="line"><span class="lineno"> 1190</span> </div>
<div class="line"><span class="lineno"> 1191</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1192</span>        <span class="comment">// Restore to original process</span></div>
<div class="line"><span class="lineno"> 1193</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1194</span>        <a class="code hl_function" href="_switch_layout_8c.html#a1cf82918f5f7b7fe06a46a3e8418761d">SwitchToPreviousProcess</a>(Cr3OfCurrentProcess);</div>
<div class="line"><span class="lineno"> 1195</span> </div>
<div class="line"><span class="lineno"> 1196</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1197</span>        <span class="comment">// Compute new offset of target offset into a safe bufferr</span></div>
<div class="line"><span class="lineno"> 1198</span>        <span class="comment">// It will be used to compute the length of the detours</span></div>
<div class="line"><span class="lineno"> 1199</span>        <span class="comment">// address because we might have a user mode code</span></div>
<div class="line"><span class="lineno"> 1200</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1201</span>        TargetAddressInSafeMemory = EptHookCalcBreakpointOffset(TargetAddress, HookedPage);</div>
<div class="line"><span class="lineno"> 1202</span> </div>
<div class="line"><span class="lineno"> 1203</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1204</span>        <span class="comment">// Make sure if handler function is valid or if it&#39;s default</span></div>
<div class="line"><span class="lineno"> 1205</span>        <span class="comment">// then we set it to the default handler</span></div>
<div class="line"><span class="lineno"> 1206</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1207</span>        <span class="keywordflow">if</span> (((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_EPTHOOK2</a> *)HookingDetails)-&gt;HookFunction == NULL)</div>
<div class="line"><span class="lineno"> 1208</span>        {</div>
<div class="line"><span class="lineno"> 1209</span>            HookFunction = (PVOID)<a class="code hl_function" href="_inline_asm_8h.html#ab0e909131196cbec54246cc925e89251">AsmGeneralDetourHook</a>;</div>
<div class="line"><span class="lineno"> 1210</span>        }</div>
<div class="line"><span class="lineno"> 1211</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1212</span>        {</div>
<div class="line"><span class="lineno"> 1213</span>            HookFunction = ((<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___e_p_t_h_o_o_k2.html">EPT_HOOKS_ADDRESS_DETAILS_FOR_EPTHOOK2</a> *)HookingDetails)-&gt;HookFunction;</div>
<div class="line"><span class="lineno"> 1214</span>        }</div>
<div class="line"><span class="lineno"> 1215</span> </div>
<div class="line"><span class="lineno"> 1216</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1217</span>        <span class="comment">// Create Hook</span></div>
<div class="line"><span class="lineno"> 1218</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1219</span>        <span class="keywordflow">if</span> (!<a class="code hl_function" href="#a1a97cf8a3d1243edf02539139bbfb617">EptHookInstructionMemory</a>(HookedPage, ProcessCr3, TargetAddress, (PVOID)TargetAddressInSafeMemory, HookFunction))</div>
<div class="line"><span class="lineno"> 1220</span>        {</div>
<div class="line"><span class="lineno"> 1221</span>            <a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)HookedPage);</div>
<div class="line"><span class="lineno"> 1222</span> </div>
<div class="line"><span class="lineno"> 1223</span>            <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="_error_codes_8h.html#aa080da83ab0982e6d13150d580e7387b">DEBUGGER_ERROR_COULD_NOT_BUILD_THE_EPT_HOOK</a>);</div>
<div class="line"><span class="lineno"> 1224</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1225</span>        }</div>
<div class="line"><span class="lineno"> 1226</span>    }</div>
<div class="line"><span class="lineno"> 1227</span> </div>
<div class="line"><span class="lineno"> 1228</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; ProcessorsCount; i++)</div>
<div class="line"><span class="lineno"> 1229</span>    {</div>
<div class="line"><span class="lineno"> 1230</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1231</span>        <span class="comment">// Set target buffer, request buffer from pool manager,</span></div>
<div class="line"><span class="lineno"> 1232</span>        <span class="comment">// we also need to allocate new page to replace the current page</span></div>
<div class="line"><span class="lineno"> 1233</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1234</span>        TargetBuffer = (PVOID)<a class="code hl_function" href="_pool_manager_8c.html#a065841edb44331344b1a71a2ea397923">PoolManagerRequestPool</a>(<a class="code hl_enumvalue" href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a09f33e69ad8e184c21efd29fa2fe7380">SPLIT_2MB_PAGING_TO_4KB_PAGE</a>, <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t.html">VMM_EPT_DYNAMIC_SPLIT</a>));</div>
<div class="line"><span class="lineno"> 1235</span> </div>
<div class="line"><span class="lineno"> 1236</span>        <span class="keywordflow">if</span> (!TargetBuffer)</div>
<div class="line"><span class="lineno"> 1237</span>        {</div>
<div class="line"><span class="lineno"> 1238</span>            <a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)HookedPage);</div>
<div class="line"><span class="lineno"> 1239</span> </div>
<div class="line"><span class="lineno"> 1240</span>            <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="_error_codes_8h.html#a35966c13fc80dc6d9055d5b7f46f6ef6">DEBUGGER_ERROR_PRE_ALLOCATED_BUFFER_IS_EMPTY</a>);</div>
<div class="line"><span class="lineno"> 1241</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1242</span>        }</div>
<div class="line"><span class="lineno"> 1243</span> </div>
<div class="line"><span class="lineno"> 1244</span>        <span class="keywordflow">if</span> (!<a class="code hl_function" href="_ept_8c.html#a186f8a530e93e585a153269cdc103f45">EptSplitLargePage</a>(<a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[i].EptPageTable, TargetBuffer, PhysicalBaseAddress))</div>
<div class="line"><span class="lineno"> 1245</span>        {</div>
<div class="line"><span class="lineno"> 1246</span>            <a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)HookedPage);</div>
<div class="line"><span class="lineno"> 1247</span>            <a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)TargetBuffer); <span class="comment">// Here also other previous pools should be specified, but we forget it for now</span></div>
<div class="line"><span class="lineno"> 1248</span> </div>
<div class="line"><span class="lineno"> 1249</span>            <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Err, could not split page for the address : 0x%llx&quot;</span>, PhysicalBaseAddress);</div>
<div class="line"><span class="lineno"> 1250</span>            <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="_error_codes_8h.html#afa580b4ad142ec96cadfdc5cec58b1b7">DEBUGGER_ERROR_EPT_COULD_NOT_SPLIT_THE_LARGE_PAGE_TO_4KB_PAGES</a>);</div>
<div class="line"><span class="lineno"> 1251</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1252</span>        }</div>
<div class="line"><span class="lineno"> 1253</span> </div>
<div class="line"><span class="lineno"> 1254</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1255</span>        <span class="comment">// Pointer to the page entry in the page table</span></div>
<div class="line"><span class="lineno"> 1256</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1257</span>        TargetPage = <a class="code hl_function" href="_ept_8c.html#aca998ecbfe4b433dbb307e5ab1fbcc41">EptGetPml1Entry</a>(<a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[i].EptPageTable, PhysicalBaseAddress);</div>
<div class="line"><span class="lineno"> 1258</span> </div>
<div class="line"><span class="lineno"> 1259</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1260</span>        <span class="comment">// Ensure the target is valid</span></div>
<div class="line"><span class="lineno"> 1261</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1262</span>        <span class="keywordflow">if</span> (!TargetPage)</div>
<div class="line"><span class="lineno"> 1263</span>        {</div>
<div class="line"><span class="lineno"> 1264</span>            <a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)HookedPage);</div>
<div class="line"><span class="lineno"> 1265</span>            <a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)TargetBuffer); <span class="comment">// Here also other previous pools should be specified, but we forget it for now</span></div>
<div class="line"><span class="lineno"> 1266</span> </div>
<div class="line"><span class="lineno"> 1267</span>            <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="_error_codes_8h.html#a06398ba01fbfbb3e3acb44a6cd97002c">DEBUGGER_ERROR_EPT_FAILED_TO_GET_PML1_ENTRY_OF_TARGET_ADDRESS</a>);</div>
<div class="line"><span class="lineno"> 1268</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1269</span>        }</div>
<div class="line"><span class="lineno"> 1270</span> </div>
<div class="line"><span class="lineno"> 1271</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1272</span>        <span class="comment">// Save the original entry (only one of the page tables as the base original entry</span></div>
<div class="line"><span class="lineno"> 1273</span>        <span class="comment">// is enough)</span></div>
<div class="line"><span class="lineno"> 1274</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1275</span>        HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">OriginalEntry</a> = *TargetPage;</div>
<div class="line"><span class="lineno"> 1276</span> </div>
<div class="line"><span class="lineno"> 1277</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1278</span>        <span class="comment">// Save the original permissions of the page</span></div>
<div class="line"><span class="lineno"> 1279</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1280</span>        ChangedEntry = *TargetPage;</div>
<div class="line"><span class="lineno"> 1281</span> </div>
<div class="line"><span class="lineno"> 1282</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1283</span>        <span class="comment">// Execution is treated differently</span></div>
<div class="line"><span class="lineno"> 1284</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1285</span>        <span class="keywordflow">if</span> (UnsetRead)</div>
<div class="line"><span class="lineno"> 1286</span>            ChangedEntry.ReadAccess = 0;</div>
<div class="line"><span class="lineno"> 1287</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1288</span>            ChangedEntry.ReadAccess = 1;</div>
<div class="line"><span class="lineno"> 1289</span> </div>
<div class="line"><span class="lineno"> 1290</span>        <span class="keywordflow">if</span> (UnsetWrite)</div>
<div class="line"><span class="lineno"> 1291</span>            ChangedEntry.WriteAccess = 0;</div>
<div class="line"><span class="lineno"> 1292</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1293</span>            ChangedEntry.WriteAccess = 1;</div>
<div class="line"><span class="lineno"> 1294</span> </div>
<div class="line"><span class="lineno"> 1295</span>        <span class="keywordflow">if</span> (UnsetExecute)</div>
<div class="line"><span class="lineno"> 1296</span>            ChangedEntry.ExecuteAccess = 0;</div>
<div class="line"><span class="lineno"> 1297</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1298</span>            ChangedEntry.ExecuteAccess = 1;</div>
<div class="line"><span class="lineno"> 1299</span> </div>
<div class="line"><span class="lineno"> 1300</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1301</span>        <span class="comment">// If it&#39;s Execution hook then we have to set extra fields</span></div>
<div class="line"><span class="lineno"> 1302</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1303</span>        <span class="keywordflow">if</span> (EptHiddenHook)</div>
<div class="line"><span class="lineno"> 1304</span>        {</div>
<div class="line"><span class="lineno"> 1305</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1306</span>            <span class="comment">// In execution hook, we have to make sure to unset read, write because</span></div>
<div class="line"><span class="lineno"> 1307</span>            <span class="comment">// an EPT violation should occur for these cases and we can swap the original page</span></div>
<div class="line"><span class="lineno"> 1308</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1309</span>            ChangedEntry.ReadAccess    = 0;</div>
<div class="line"><span class="lineno"> 1310</span>            ChangedEntry.WriteAccess   = 0;</div>
<div class="line"><span class="lineno"> 1311</span>            ChangedEntry.ExecuteAccess = 1;</div>
<div class="line"><span class="lineno"> 1312</span> </div>
<div class="line"><span class="lineno"> 1313</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1314</span>            <span class="comment">// Also set the current pfn to fake page</span></div>
<div class="line"><span class="lineno"> 1315</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1316</span>            ChangedEntry.PageFrameNumber = HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a325edda9c8d49c2f44319627d86d4a88">PhysicalBaseAddressOfFakePageContents</a>;</div>
<div class="line"><span class="lineno"> 1317</span>        }</div>
<div class="line"><span class="lineno"> 1318</span> </div>
<div class="line"><span class="lineno"> 1319</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1320</span>        <span class="comment">// Only for the first time execution of the loop, we save these details,</span></div>
<div class="line"><span class="lineno"> 1321</span>        <span class="comment">// it is because after this condition, the hook is applied and by applying</span></div>
<div class="line"><span class="lineno"> 1322</span>        <span class="comment">// the hook, we have to make sure that the address is saved g_EptState-&gt;HookedPagesList</span></div>
<div class="line"><span class="lineno"> 1323</span>        <span class="comment">// because the hook might be simultaneously triggered from other cores</span></div>
<div class="line"><span class="lineno"> 1324</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1325</span>        <span class="keywordflow">if</span> (i == 0)</div>
<div class="line"><span class="lineno"> 1326</span>        {</div>
<div class="line"><span class="lineno"> 1327</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1328</span>            <span class="comment">// Save the modified entry</span></div>
<div class="line"><span class="lineno"> 1329</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1330</span>            HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a87563a62e848638473d980314b01d28b">ChangedEntry</a> = ChangedEntry;</div>
<div class="line"><span class="lineno"> 1331</span> </div>
<div class="line"><span class="lineno"> 1332</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1333</span>            <span class="comment">// Add it to the list</span></div>
<div class="line"><span class="lineno"> 1334</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1335</span>            <a class="code hl_function" href="_windows_8h.html#ad311db6648e5e4e2860aab6164cdb6c1">InsertHeadList</a>(&amp;<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, &amp;(HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">PageHookList</a>));</div>
<div class="line"><span class="lineno"> 1336</span>        }</div>
<div class="line"><span class="lineno"> 1337</span> </div>
<div class="line"><span class="lineno"> 1338</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1339</span>        <span class="comment">// Apply the hook to EPT</span></div>
<div class="line"><span class="lineno"> 1340</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1341</span>        TargetPage-&gt;AsUInt = ChangedEntry.AsUInt;</div>
<div class="line"><span class="lineno"> 1342</span> </div>
<div class="line"><span class="lineno"> 1343</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1344</span>        <span class="comment">// If it&#39;s the current core then we invalidate the EPT</span></div>
<div class="line"><span class="lineno"> 1345</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1346</span>        <span class="keywordflow">if</span> (VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#ad166851f334095bff309813f73ea394e">CoreId</a> == i &amp;&amp; <a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[i].<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aaacba0883eec22779a564fb93aea73fd">HasLaunched</a>)</div>
<div class="line"><span class="lineno"> 1347</span>        {</div>
<div class="line"><span class="lineno"> 1348</span>            <a class="code hl_function" href="_invept_8c.html#a7c73091dea8c657cef945340f4bd2808">EptInveptSingleContext</a>(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a4c5c6fd61c83853d21e270e87cdea179">EptPointer</a>.AsUInt);</div>
<div class="line"><span class="lineno"> 1349</span>        }</div>
<div class="line"><span class="lineno"> 1350</span>    }</div>
<div class="line"><span class="lineno"> 1351</span> </div>
<div class="line"><span class="lineno"> 1352</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1353</span>}</div>
<div class="ttc" id="a_data_types_8h_html_a16edc968c8587e5c31a8b065c390a3c0ac22f516e18d6e5e5b364e2c6e9f07993"><div class="ttname"><a href="_data_types_8h.html#a16edc968c8587e5c31a8b065c390a3c0ac22f516e18d6e5e5b364e2c6e9f07993">DEBUGGER_MEMORY_HOOK_PHYSICAL_ADDRESS</a></div><div class="ttdeci">@ DEBUGGER_MEMORY_HOOK_PHYSICAL_ADDRESS</div><div class="ttdef"><b>Definition</b> DataTypes.h:312</div></div>
<div class="ttc" id="a_ept_8c_html_a186f8a530e93e585a153269cdc103f45"><div class="ttname"><a href="_ept_8c.html#a186f8a530e93e585a153269cdc103f45">EptSplitLargePage</a></div><div class="ttdeci">BOOLEAN EptSplitLargePage(PVMM_EPT_PAGE_TABLE EptPageTable, PVOID PreAllocatedBuffer, SIZE_T PhysicalAddress)</div><div class="ttdoc">Split 2MB (LargePage) into 4kb pages.</div><div class="ttdef"><b>Definition</b> Ept.c:462</div></div>
<div class="ttc" id="a_ept_hook_8c_html_a1a97cf8a3d1243edf02539139bbfb617"><div class="ttname"><a href="#a1a97cf8a3d1243edf02539139bbfb617">EptHookInstructionMemory</a></div><div class="ttdeci">BOOLEAN EptHookInstructionMemory(PEPT_HOOKED_PAGE_DETAIL Hook, CR3_TYPE ProcessCr3, PVOID TargetFunction, PVOID TargetFunctionInSafeMemory, PVOID HookFunction)</div><div class="ttdoc">Hook instructions.</div><div class="ttdef"><b>Definition</b> EptHook.c:834</div></div>
<div class="ttc" id="a_error_codes_8h_html_a06398ba01fbfbb3e3acb44a6cd97002c"><div class="ttname"><a href="_error_codes_8h.html#a06398ba01fbfbb3e3acb44a6cd97002c">DEBUGGER_ERROR_EPT_FAILED_TO_GET_PML1_ENTRY_OF_TARGET_ADDRESS</a></div><div class="ttdeci">#define DEBUGGER_ERROR_EPT_FAILED_TO_GET_PML1_ENTRY_OF_TARGET_ADDRESS</div><div class="ttdoc">error, failed to get PML1 entry of the target address</div><div class="ttdef"><b>Definition</b> ErrorCodes.h:264</div></div>
<div class="ttc" id="a_error_codes_8h_html_a35966c13fc80dc6d9055d5b7f46f6ef6"><div class="ttname"><a href="_error_codes_8h.html#a35966c13fc80dc6d9055d5b7f46f6ef6">DEBUGGER_ERROR_PRE_ALLOCATED_BUFFER_IS_EMPTY</a></div><div class="ttdeci">#define DEBUGGER_ERROR_PRE_ALLOCATED_BUFFER_IS_EMPTY</div><div class="ttdoc">error, there is no pre-allocated buffer</div><div class="ttdef"><b>Definition</b> ErrorCodes.h:251</div></div>
<div class="ttc" id="a_error_codes_8h_html_a9697a726e353b61b5e02c10395f3f382"><div class="ttname"><a href="_error_codes_8h.html#a9697a726e353b61b5e02c10395f3f382">DEBUGGER_ERROR_EPT_MULTIPLE_HOOKS_IN_A_SINGLE_PAGE</a></div><div class="ttdeci">#define DEBUGGER_ERROR_EPT_MULTIPLE_HOOKS_IN_A_SINGLE_PAGE</div><div class="ttdoc">error, multiple EPT Hooks or Monitors are applied on a single page</div><div class="ttdef"><b>Definition</b> ErrorCodes.h:270</div></div>
<div class="ttc" id="a_error_codes_8h_html_aa080da83ab0982e6d13150d580e7387b"><div class="ttname"><a href="_error_codes_8h.html#aa080da83ab0982e6d13150d580e7387b">DEBUGGER_ERROR_COULD_NOT_BUILD_THE_EPT_HOOK</a></div><div class="ttdeci">#define DEBUGGER_ERROR_COULD_NOT_BUILD_THE_EPT_HOOK</div><div class="ttdoc">error, could not build the EPT Hook</div><div class="ttdef"><b>Definition</b> ErrorCodes.h:276</div></div>
<div class="ttc" id="a_error_codes_8h_html_afa580b4ad142ec96cadfdc5cec58b1b7"><div class="ttname"><a href="_error_codes_8h.html#afa580b4ad142ec96cadfdc5cec58b1b7">DEBUGGER_ERROR_EPT_COULD_NOT_SPLIT_THE_LARGE_PAGE_TO_4KB_PAGES</a></div><div class="ttdeci">#define DEBUGGER_ERROR_EPT_COULD_NOT_SPLIT_THE_LARGE_PAGE_TO_4KB_PAGES</div><div class="ttdoc">error, in the EPT handler, it could not split the 2MB pages to 512 entries of 4 KB pages</div><div class="ttdef"><b>Definition</b> ErrorCodes.h:258</div></div>
<div class="ttc" id="a_inline_asm_8h_html_ab0e909131196cbec54246cc925e89251"><div class="ttname"><a href="_inline_asm_8h.html#ab0e909131196cbec54246cc925e89251">AsmGeneralDetourHook</a></div><div class="ttdeci">void AsmGeneralDetourHook(void)</div><div class="ttdoc">Detour hook handler.</div></div>
<div class="ttc" id="a_pool_manager_8c_html_aac1a781a8d6463b65848555355e687dd"><div class="ttname"><a href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a></div><div class="ttdeci">BOOLEAN PoolManagerFreePool(UINT64 AddressToFree)</div><div class="ttdoc">This function set a pool flag to be freed, and it will be freed on the next IOCTL when it's safe to r...</div><div class="ttdef"><b>Definition</b> PoolManager.c:136</div></div>
<div class="ttc" id="ahyperhv_2header_2common_2_state_8h_html_a7f2689338799db6564d2b9cb35d7d596"><div class="ttname"><a href="hyperhv_2header_2common_2_state_8h.html#a7f2689338799db6564d2b9cb35d7d596">EPT_PML1_ENTRY</a></div><div class="ttdeci">EPT_PTE EPT_PML1_ENTRY</div><div class="ttdef"><b>Definition</b> State.h:22</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a325edda9c8d49c2f44319627d86d4a88"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a325edda9c8d49c2f44319627d86d4a88">_EPT_HOOKED_PAGE_DETAIL::PhysicalBaseAddressOfFakePageContents</a></div><div class="ttdeci">SIZE_T PhysicalBaseAddressOfFakePageContents</div><div class="ttdoc">The base address of the page with fake contents. Used to swap page with fake contents when a hook is ...</div><div class="ttdef"><b>Definition</b> State.h:208</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a40f5606fe57295d12c430ce08421e544"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a40f5606fe57295d12c430ce08421e544">_EPT_HOOKED_PAGE_DETAIL::IsExecutionHook</a></div><div class="ttdeci">BOOLEAN IsExecutionHook</div><div class="ttdoc">This field shows whether the hook contains a hidden hook for execution or not.</div><div class="ttdef"><b>Definition</b> State.h:229</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a4450bd220c3bce95443a102aa90fc93b"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">_EPT_HOOKED_PAGE_DETAIL::PageHookList</a></div><div class="ttdeci">LIST_ENTRY PageHookList</div><div class="ttdoc">Linked list entries for each page hook.</div><div class="ttdef"><b>Definition</b> State.h:170</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_aa01091e78a33ffed5bc4c6936ca0e736"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aa01091e78a33ffed5bc4c6936ca0e736">_EPT_HOOKED_PAGE_DETAIL::EndOfTargetPhysicalAddress</a></div><div class="ttdeci">SIZE_T EndOfTargetPhysicalAddress</div><div class="ttdoc">End address of the target physical address.</div><div class="ttdef"><b>Definition</b> State.h:197</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_aa0bf8c2c8384010e9ed9f2e24bf2f3e4"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aa0bf8c2c8384010e9ed9f2e24bf2f3e4">_EPT_HOOKED_PAGE_DETAIL::StartOfTargetPhysicalAddress</a></div><div class="ttdeci">SIZE_T StartOfTargetPhysicalAddress</div><div class="ttdoc">Start address of the target physical address.</div><div class="ttdef"><b>Definition</b> State.h:192</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_acacf76428d2801be17ffb3e8b05e9374"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">_EPT_HOOKED_PAGE_DETAIL::OriginalEntry</a></div><div class="ttdeci">EPT_PML1_ENTRY OriginalEntry</div><div class="ttdoc">The original page entry. Will be copied back when the hook is removed from the page.</div><div class="ttdef"><b>Definition</b> State.h:214</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r_html"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___a_d_d_r_e_s_s___d_e_t_a_i_l_s___f_o_r___m_e_m_o_r_y___m_o_n_i_t_o_r.html">_EPT_HOOKS_ADDRESS_DETAILS_FOR_MEMORY_MONITOR</a></div><div class="ttdoc">Setting details for EPT Hooks (!monitor)</div><div class="ttdef"><b>Definition</b> DataTypes.h:331</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_aaacba0883eec22779a564fb93aea73fd"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aaacba0883eec22779a564fb93aea73fd">_VIRTUAL_MACHINE_STATE::HasLaunched</a></div><div class="ttdeci">BOOLEAN HasLaunched</div><div class="ttdef"><b>Definition</b> State.h:293</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="af8b74d71541023dd924e0a7c01a6c3c1" name="af8b74d71541023dd924e0a7c01a6c3c1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af8b74d71541023dd924e0a7c01a6c3c1">&#9670;&#160;</a></span>EptHookPerformUnHookSingleAddress()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookPerformUnHookSingleAddress </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>VirtualAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>PhysAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>HookingTag</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>ProcessId</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></td>          <td class="paramname"><span class="paramname"><em>ApplyDirectlyFromVmxRoot</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_data_types_8h.html#a27c1e2d2980e51cf66a1c72b3f08ba13">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> *</td>          <td class="paramname"><span class="paramname"><em>TargetUnhookingDetails</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove single hook from the hooked pages list and invalidate TLB. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VirtualAddress</td><td>Virtual address to unhook </td></tr>
    <tr><td class="paramname">PhysAddress</td><td>Physical address to unhook (optional) </td></tr>
    <tr><td class="paramname">HookingTag</td><td>Hooking tag (optional) </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id of target process (in unhooking for some hooks only physical address is availables) </td></tr>
    <tr><td class="paramname">ApplyDirectlyFromVmxRoot</td><td>should it be directly applied from VMX-root mode or not </td></tr>
    <tr><td class="paramname">TargetUnhookingDetails</td><td>Target data for the caller to restore EPT entry and invalidate EPT caches. Only when applied in VMX-root mode directly</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If unhook was successful it returns true or if it was not successful returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 2215</span>{</div>
<div class="line"><span class="lineno"> 2216</span>    SIZE_T PhysicalAddress = <a class="code hl_define" href="_basic_types_8h.html#a8a9df53f35cb95dddbe3c564259e01ad">NULL64_ZERO</a>;</div>
<div class="line"><span class="lineno"> 2217</span> </div>
<div class="line"><span class="lineno"> 2218</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2219</span>    <span class="comment">// Once applied directly from VMX-root mode, the process id should be the same process Id</span></div>
<div class="line"><span class="lineno"> 2220</span>    <span class="comment">// on current process</span></div>
<div class="line"><span class="lineno"> 2221</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2222</span>    <span class="keywordflow">if</span> (ApplyDirectlyFromVmxRoot || ProcessId == <a class="code hl_define" href="_constants_8h.html#ab3bb4c0d2a847e96e2988afd99c82074">DEBUGGER_EVENT_APPLY_TO_ALL_PROCESSES</a> || ProcessId == 0)</div>
<div class="line"><span class="lineno"> 2223</span>    {</div>
<div class="line"><span class="lineno"> 2224</span>        ProcessId = <a class="code hl_define" href="_meta_macros_8h.html#ad790279846c85a5a453f2e7a4e02abad">HANDLE_TO_UINT32</a>(PsGetCurrentProcessId());</div>
<div class="line"><span class="lineno"> 2225</span>    }</div>
<div class="line"><span class="lineno"> 2226</span> </div>
<div class="line"><span class="lineno"> 2227</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2228</span>    <span class="comment">// Check if the physical address is available or not</span></div>
<div class="line"><span class="lineno"> 2229</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2230</span>    <span class="keywordflow">if</span> (PhysAddress != <a class="code hl_define" href="_basic_types_8h.html#a8a9df53f35cb95dddbe3c564259e01ad">NULL64_ZERO</a>)</div>
<div class="line"><span class="lineno"> 2231</span>    {</div>
<div class="line"><span class="lineno"> 2232</span>        PhysicalAddress = (SIZE_T)<a class="code hl_define" href="libhyperdbg_2header_2_common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(PhysAddress);</div>
<div class="line"><span class="lineno"> 2233</span>    }</div>
<div class="line"><span class="lineno"> 2234</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HookingTag == <a class="code hl_define" href="_basic_types_8h.html#a8a9df53f35cb95dddbe3c564259e01ad">NULL64_ZERO</a>)</div>
<div class="line"><span class="lineno"> 2235</span>    {</div>
<div class="line"><span class="lineno"> 2236</span>        <span class="keywordflow">if</span> (ApplyDirectlyFromVmxRoot)</div>
<div class="line"><span class="lineno"> 2237</span>        {</div>
<div class="line"><span class="lineno"> 2238</span>            PhysicalAddress = (SIZE_T)(<a class="code hl_define" href="libhyperdbg_2header_2_common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(<a class="code hl_function" href="_conversion_8c.html#a63eff86102e697567fec147fc04f6248">VirtualAddressToPhysicalAddressOnTargetProcess</a>((PVOID)VirtualAddress)));</div>
<div class="line"><span class="lineno"> 2239</span>        }</div>
<div class="line"><span class="lineno"> 2240</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2241</span>        {</div>
<div class="line"><span class="lineno"> 2242</span>            PhysicalAddress = (SIZE_T)(<a class="code hl_define" href="libhyperdbg_2header_2_common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(<a class="code hl_function" href="_conversion_8c.html#a507e3ba3c1076ac38e61c34f53ef5c38">VirtualAddressToPhysicalAddressByProcessId</a>((PVOID)VirtualAddress,</div>
<div class="line"><span class="lineno"> 2243</span>                                                                                             ProcessId)));</div>
<div class="line"><span class="lineno"> 2244</span>        }</div>
<div class="line"><span class="lineno"> 2245</span>    }</div>
<div class="line"><span class="lineno"> 2246</span> </div>
<div class="line"><span class="lineno"> 2247</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList, CurrEntity)</div>
<div class="line"><span class="lineno"> 2248</span>    {</div>
<div class="line"><span class="lineno"> 2249</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2250</span>        <span class="comment">// Check if it&#39;s a hidden breakpoint or hidden detours</span></div>
<div class="line"><span class="lineno"> 2251</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2252</span>        <span class="keywordflow">if</span> (CurrEntity-&gt;IsHiddenBreakpoint)</div>
<div class="line"><span class="lineno"> 2253</span>        {</div>
<div class="line"><span class="lineno"> 2254</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2255</span>            <span class="comment">// It&#39;s a hidden breakpoint</span></div>
<div class="line"><span class="lineno"> 2256</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2257</span>            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; CurrEntity-&gt;CountOfBreakpoints; i++)</div>
<div class="line"><span class="lineno"> 2258</span>            {</div>
<div class="line"><span class="lineno"> 2259</span>                <span class="keywordflow">if</span> (CurrEntity-&gt;BreakpointAddresses[i] == VirtualAddress)</div>
<div class="line"><span class="lineno"> 2260</span>                {</div>
<div class="line"><span class="lineno"> 2261</span>                    <span class="keywordflow">return</span> <a class="code hl_function" href="#ab65f9dabbdc5421ee817b6962b4fbbc3">EptHookUnHookSingleAddressHiddenBreakpoint</a>(CurrEntity,</div>
<div class="line"><span class="lineno"> 2262</span>                                                                      VirtualAddress,</div>
<div class="line"><span class="lineno"> 2263</span>                                                                      ApplyDirectlyFromVmxRoot,</div>
<div class="line"><span class="lineno"> 2264</span>                                                                      TargetUnhookingDetails);</div>
<div class="line"><span class="lineno"> 2265</span>                }</div>
<div class="line"><span class="lineno"> 2266</span>            }</div>
<div class="line"><span class="lineno"> 2267</span>        }</div>
<div class="line"><span class="lineno"> 2268</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2269</span>        {</div>
<div class="line"><span class="lineno"> 2270</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2271</span>            <span class="comment">// It&#39;s either a hidden detours or a monitor (read/write/execute) entry</span></div>
<div class="line"><span class="lineno"> 2272</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2273</span>            <span class="keywordflow">if</span> ((HookingTag != <a class="code hl_define" href="_basic_types_8h.html#a8a9df53f35cb95dddbe3c564259e01ad">NULL64_ZERO</a> &amp;&amp; CurrEntity-&gt;HookingTag == HookingTag) || CurrEntity-&gt;PhysicalBaseAddress == PhysicalAddress)</div>
<div class="line"><span class="lineno"> 2274</span>            {</div>
<div class="line"><span class="lineno"> 2275</span>                <span class="keywordflow">return</span> <a class="code hl_function" href="#a15af39b643632343c25539a4931084ce">EptHookUnHookSingleAddressDetoursAndMonitor</a>(CurrEntity,</div>
<div class="line"><span class="lineno"> 2276</span>                                                                   ApplyDirectlyFromVmxRoot,</div>
<div class="line"><span class="lineno"> 2277</span>                                                                   TargetUnhookingDetails);</div>
<div class="line"><span class="lineno"> 2278</span>            }</div>
<div class="line"><span class="lineno"> 2279</span>        }</div>
<div class="line"><span class="lineno"> 2280</span>    }</div>
<div class="line"><span class="lineno"> 2281</span> </div>
<div class="line"><span class="lineno"> 2282</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2283</span>    <span class="comment">// Nothing found, probably the hooking detail is not found</span></div>
<div class="line"><span class="lineno"> 2284</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2285</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2286</span>}</div>
<div class="ttc" id="a_constants_8h_html_ab3bb4c0d2a847e96e2988afd99c82074"><div class="ttname"><a href="_constants_8h.html#ab3bb4c0d2a847e96e2988afd99c82074">DEBUGGER_EVENT_APPLY_TO_ALL_PROCESSES</a></div><div class="ttdeci">#define DEBUGGER_EVENT_APPLY_TO_ALL_PROCESSES</div><div class="ttdoc">Apply the event to all the processes.</div><div class="ttdef"><b>Definition</b> Constants.h:617</div></div>
<div class="ttc" id="a_conversion_8c_html_a507e3ba3c1076ac38e61c34f53ef5c38"><div class="ttname"><a href="_conversion_8c.html#a507e3ba3c1076ac38e61c34f53ef5c38">VirtualAddressToPhysicalAddressByProcessId</a></div><div class="ttdeci">_Use_decl_annotations_ UINT64 VirtualAddressToPhysicalAddressByProcessId(PVOID VirtualAddress, UINT32 ProcessId)</div><div class="ttdoc">Converts Virtual Address to Physical Address based on a specific process id's kernel cr3.</div><div class="ttdef"><b>Definition</b> Conversion.c:171</div></div>
<div class="ttc" id="a_conversion_8c_html_a63eff86102e697567fec147fc04f6248"><div class="ttname"><a href="_conversion_8c.html#a63eff86102e697567fec147fc04f6248">VirtualAddressToPhysicalAddressOnTargetProcess</a></div><div class="ttdeci">_Use_decl_annotations_ UINT64 VirtualAddressToPhysicalAddressOnTargetProcess(PVOID VirtualAddress)</div><div class="ttdoc">Converts Virtual Address to Physical Address based on the current process's kernel cr3.</div><div class="ttdef"><b>Definition</b> Conversion.c:258</div></div>
<div class="ttc" id="a_ept_hook_8c_html_a15af39b643632343c25539a4931084ce"><div class="ttname"><a href="#a15af39b643632343c25539a4931084ce">EptHookUnHookSingleAddressDetoursAndMonitor</a></div><div class="ttdeci">BOOLEAN EptHookUnHookSingleAddressDetoursAndMonitor(PEPT_HOOKED_PAGE_DETAIL HookedEntry, BOOLEAN ApplyDirectlyFromVmxRoot, EPT_SINGLE_HOOK_UNHOOKING_DETAILS *TargetUnhookingDetails)</div><div class="ttdoc">Remove single hook of detours type.</div><div class="ttdef"><b>Definition</b> EptHook.c:1902</div></div>
<div class="ttc" id="a_ept_hook_8c_html_ab65f9dabbdc5421ee817b6962b4fbbc3"><div class="ttname"><a href="#ab65f9dabbdc5421ee817b6962b4fbbc3">EptHookUnHookSingleAddressHiddenBreakpoint</a></div><div class="ttdeci">BOOLEAN EptHookUnHookSingleAddressHiddenBreakpoint(PEPT_HOOKED_PAGE_DETAIL HookedEntry, UINT64 VirtualAddress, BOOLEAN ApplyDirectlyFromVmxRoot, EPT_SINGLE_HOOK_UNHOOKING_DETAILS *TargetUnhookingDetails)</div><div class="ttdoc">Remove single hook of hidden breakpoint type.</div><div class="ttdef"><b>Definition</b> EptHook.c:2031</div></div>
<div class="ttc" id="a_meta_macros_8h_html_ad790279846c85a5a453f2e7a4e02abad"><div class="ttname"><a href="_meta_macros_8h.html#ad790279846c85a5a453f2e7a4e02abad">HANDLE_TO_UINT32</a></div><div class="ttdeci">#define HANDLE_TO_UINT32(_var)</div><div class="ttdef"><b>Definition</b> MetaMacros.h:39</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="acac4eff03b2197ae43e4c13f382e20b5" name="acac4eff03b2197ae43e4c13f382e20b5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acac4eff03b2197ae43e4c13f382e20b5">&#9670;&#160;</a></span>EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>Address</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove the entry from g_EptHook2sDetourListHead in the case of !epthook2 details. </p>
<p>Remove an entry from g_EptHook2sDetourListHead.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Address</td><td>Address to remove </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN TRUE if successfully removed and false if not found </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1827</span>{</div>
<div class="line"><span class="lineno"> 1828</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1829</span>    <span class="comment">// Iterate through the list of hooked pages details to find</span></div>
<div class="line"><span class="lineno"> 1830</span>    <span class="comment">// the entry in the list</span></div>
<div class="line"><span class="lineno"> 1831</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1832</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a>, <a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">HIDDEN_HOOKS_DETOUR_DETAILS</a>, OtherHooksList, CurrentHookedDetails)</div>
<div class="line"><span class="lineno"> 1833</span>    {</div>
<div class="line"><span class="lineno"> 1834</span>        <span class="keywordflow">if</span> (CurrentHookedDetails-&gt;HookedFunctionAddress == (PVOID)<a class="code hl_variable" href="_hyper_dbg_script_imports_8h.html#a3f7c5b71d899e923be0a80d4ac7902fe">Address</a>)</div>
<div class="line"><span class="lineno"> 1835</span>        {</div>
<div class="line"><span class="lineno"> 1836</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1837</span>            <span class="comment">// We found the address, we should remove it and add it for</span></div>
<div class="line"><span class="lineno"> 1838</span>            <span class="comment">// future deallocation</span></div>
<div class="line"><span class="lineno"> 1839</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1840</span>            <a class="code hl_function" href="_windows_8h.html#aac75b07955a17d40e91325491bbac645">RemoveEntryList</a>(&amp;CurrentHookedDetails-&gt;OtherHooksList);</div>
<div class="line"><span class="lineno"> 1841</span> </div>
<div class="line"><span class="lineno"> 1842</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1843</span>            <span class="comment">// Free the pool in next ioctl</span></div>
<div class="line"><span class="lineno"> 1844</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1845</span>            <span class="keywordflow">if</span> (!<a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)CurrentHookedDetails))</div>
<div class="line"><span class="lineno"> 1846</span>            {</div>
<div class="line"><span class="lineno"> 1847</span>                <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><span class="lineno"> 1848</span>            }</div>
<div class="line"><span class="lineno"> 1849</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1850</span>        }</div>
<div class="line"><span class="lineno"> 1851</span>    }</div>
<div class="line"><span class="lineno"> 1852</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1853</span>    <span class="comment">// No entry found !</span></div>
<div class="line"><span class="lineno"> 1854</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1855</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1856</span>}</div>
<div class="ttc" id="a_hyper_dbg_script_imports_8h_html_a3f7c5b71d899e923be0a80d4ac7902fe"><div class="ttname"><a href="_hyper_dbg_script_imports_8h.html#a3f7c5b71d899e923be0a80d4ac7902fe">Address</a></div><div class="ttdeci">UINT64 Address</div><div class="ttdef"><b>Definition</b> HyperDbgScriptImports.h:67</div></div>
<div class="ttc" id="a_windows_8h_html_aac75b07955a17d40e91325491bbac645"><div class="ttname"><a href="_windows_8h.html#aac75b07955a17d40e91325491bbac645">RemoveEntryList</a></div><div class="ttdeci">FORCEINLINE BOOLEAN RemoveEntryList(_In_ PLIST_ENTRY Entry)</div><div class="ttdef"><b>Definition</b> Windows.h:56</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a5bc373b3d6bea35f4e06a221bec6a90b" name="a5bc373b3d6bea35f4e06a221bec6a90b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5bc373b3d6bea35f4e06a221bec6a90b">&#9670;&#160;</a></span>EptHookReservePreallocatedPoolsForEptHooks()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookReservePreallocatedPoolsForEptHooks </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>Count</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Reserve pre-allocated pools for EPT hooks. </p>
<p>Allocate pre-allocated pools for EPT hooks.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Count</td><td>number of hooks</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">   71</span>{</div>
<div class="line"><span class="lineno">   72</span>    <a class="code hl_typedef" href="_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ProcessorsCount;</div>
<div class="line"><span class="lineno">   73</span> </div>
<div class="line"><span class="lineno">   74</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   75</span>    <span class="comment">// Get number of processors</span></div>
<div class="line"><span class="lineno">   76</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   77</span>    ProcessorsCount = KeQueryActiveProcessorCount(0);</div>
<div class="line"><span class="lineno">   78</span> </div>
<div class="line"><span class="lineno">   79</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   80</span>    <span class="comment">// Request pages to be allocated for converting 2MB to 4KB pages</span></div>
<div class="line"><span class="lineno">   81</span>    <span class="comment">// Each core needs its own splitting page-tables</span></div>
<div class="line"><span class="lineno">   82</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   83</span>    <a class="code hl_function" href="_pool_manager_8c.html#a3660fd340db1240d410e847fb1ffe3d8">PoolManagerRequestAllocation</a>(<span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t.html">VMM_EPT_DYNAMIC_SPLIT</a>), Count * ProcessorsCount, <a class="code hl_enumvalue" href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a09f33e69ad8e184c21efd29fa2fe7380">SPLIT_2MB_PAGING_TO_4KB_PAGE</a>);</div>
<div class="line"><span class="lineno">   84</span> </div>
<div class="line"><span class="lineno">   85</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   86</span>    <span class="comment">// Request pages to be allocated for paged hook details</span></div>
<div class="line"><span class="lineno">   87</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   88</span>    <a class="code hl_function" href="_pool_manager_8c.html#a3660fd340db1240d410e847fb1ffe3d8">PoolManagerRequestAllocation</a>(<span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>), Count, <a class="code hl_enumvalue" href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a1c4249f84cf779cd4cdd72ee27de08c1">TRACKING_HOOKED_PAGES</a>);</div>
<div class="line"><span class="lineno">   89</span> </div>
<div class="line"><span class="lineno">   90</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   91</span>    <span class="comment">// Request pages to be allocated for Trampoline of Executable hooked pages</span></div>
<div class="line"><span class="lineno">   92</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   93</span>    <a class="code hl_function" href="_pool_manager_8c.html#a3660fd340db1240d410e847fb1ffe3d8">PoolManagerRequestAllocation</a>(<a class="code hl_define" href="_hooks_8h.html#a9b5b17233c5031bc6d520227b440e01a">MAX_EXEC_TRAMPOLINE_SIZE</a>, Count, <a class="code hl_enumvalue" href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a18c553f48bd909ebfea72c42edeea43d">EXEC_TRAMPOLINE</a>);</div>
<div class="line"><span class="lineno">   94</span> </div>
<div class="line"><span class="lineno">   95</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   96</span>    <span class="comment">// Request pages to be allocated for detour hooked pages details</span></div>
<div class="line"><span class="lineno">   97</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   98</span>    <a class="code hl_function" href="_pool_manager_8c.html#a3660fd340db1240d410e847fb1ffe3d8">PoolManagerRequestAllocation</a>(<span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">HIDDEN_HOOKS_DETOUR_DETAILS</a>), Count, <a class="code hl_enumvalue" href="_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a898d2549c3e40191c8e23e4ee687663b">DETOUR_HOOK_DETAILS</a>);</div>
<div class="line"><span class="lineno">   99</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a0b2a50efc209dfa3aedcd756c7128607" name="a0b2a50efc209dfa3aedcd756c7128607"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0b2a50efc209dfa3aedcd756c7128607">&#9670;&#160;</a></span>EptHookRestoreAllHooksToOriginalEntry()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookRestoreAllHooksToOriginalEntry </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove and Invalidate Hook in TLB. </p>
<p>Remove all hooks from the hooked pages lists (Should be called in vmx-root)</p>
<dl class="section warning"><dt>Warning</dt><dd>This function won't remove entries from LIST_ENTRY, just invalidate the paging, use EptHookUnHookAll instead</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  705</span>{</div>
<div class="line"><span class="lineno">  706</span>    <a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a> TargetPage;</div>
<div class="line"><span class="lineno">  707</span> </div>
<div class="line"><span class="lineno">  708</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  709</span>    <span class="comment">// Should be called from vmx-root, for calling from vmx non-root use the corresponding VMCALL</span></div>
<div class="line"><span class="lineno">  710</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  711</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno">  712</span>    {</div>
<div class="line"><span class="lineno">  713</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  714</span>    }</div>
<div class="line"><span class="lineno">  715</span> </div>
<div class="line"><span class="lineno">  716</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList, HookedEntry)</div>
<div class="line"><span class="lineno">  717</span>    {</div>
<div class="line"><span class="lineno">  718</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  719</span>        <span class="comment">// Pointer to the page entry in the page table</span></div>
<div class="line"><span class="lineno">  720</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  721</span>        TargetPage = <a class="code hl_function" href="_ept_8c.html#aca998ecbfe4b433dbb307e5ab1fbcc41">EptGetPml1Entry</a>(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a1146a24bffa5a804261021a69cf0a00d">EptPageTable</a>, HookedEntry-&gt;PhysicalBaseAddress);</div>
<div class="line"><span class="lineno">  722</span> </div>
<div class="line"><span class="lineno">  723</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  724</span>        <span class="comment">// Apply the hook to EPT</span></div>
<div class="line"><span class="lineno">  725</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  726</span>        TargetPage-&gt;AsUInt = HookedEntry-&gt;OriginalEntry.AsUInt;</div>
<div class="line"><span class="lineno">  727</span>    }</div>
<div class="line"><span class="lineno">  728</span> </div>
<div class="line"><span class="lineno">  729</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  730</span>    <span class="comment">// Invalidate EPT Cache</span></div>
<div class="line"><span class="lineno">  731</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  732</span>    <a class="code hl_function" href="_invept_8c.html#a7c73091dea8c657cef945340f4bd2808">EptInveptSingleContext</a>(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a4c5c6fd61c83853d21e270e87cdea179">EptPointer</a>.AsUInt);</div>
<div class="line"><span class="lineno">  733</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a03c810703f75ca09341a4d70e02293c3" name="a03c810703f75ca09341a4d70e02293c3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a03c810703f75ca09341a4d70e02293c3">&#9670;&#160;</a></span>EptHookRestoreSingleHookToOriginalEntry()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookRestoreSingleHookToOriginalEntry </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *</td>          <td class="paramname"><span class="paramname"><em>VCpu</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SIZE_T</td>          <td class="paramname"><span class="paramname"><em>PhysicalAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>OriginalEntry</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove and Invalidate Hook in TLB (Hidden Detours and if counter of hidden breakpoint is zero) </p>
<p>Remove a special hook from the hooked pages lists.</p>
<dl class="section warning"><dt>Warning</dt><dd>This function won't remove entries from LIST_ENTRY, just invalidate the paging, use EptHookUnHookSingleAddress instead</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">PhysicalAddress</td><td></td></tr>
    <tr><td class="paramname">OriginalEntry</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Return false if there was an error or returns true if it was successful </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  659</span>{</div>
<div class="line"><span class="lineno">  660</span>    <a class="code hl_typedef" href="hyperhv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a> TargetPage;</div>
<div class="line"><span class="lineno">  661</span> </div>
<div class="line"><span class="lineno">  662</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  663</span>    <span class="comment">// Should be called from vmx-root, for calling from vmx non-root use the corresponding VMCALL</span></div>
<div class="line"><span class="lineno">  664</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  665</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno">  666</span>    {</div>
<div class="line"><span class="lineno">  667</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  668</span>    }</div>
<div class="line"><span class="lineno">  669</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  670</span>    <span class="comment">// Pointer to the page entry in the page table</span></div>
<div class="line"><span class="lineno">  671</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  672</span>    TargetPage = <a class="code hl_function" href="_ept_8c.html#aca998ecbfe4b433dbb307e5ab1fbcc41">EptGetPml1Entry</a>(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a1146a24bffa5a804261021a69cf0a00d">EptPageTable</a>, PhysicalAddress);</div>
<div class="line"><span class="lineno">  673</span> </div>
<div class="line"><span class="lineno">  674</span>    <span class="keywordflow">if</span> (TargetPage != NULL)</div>
<div class="line"><span class="lineno">  675</span>    {</div>
<div class="line"><span class="lineno">  676</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  677</span>        <span class="comment">// Apply the hook to EPT</span></div>
<div class="line"><span class="lineno">  678</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  679</span>        TargetPage-&gt;AsUInt = OriginalEntry;</div>
<div class="line"><span class="lineno">  680</span> </div>
<div class="line"><span class="lineno">  681</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  682</span>        <span class="comment">// Invalidate EPT Cache</span></div>
<div class="line"><span class="lineno">  683</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  684</span>        <a class="code hl_function" href="_invept_8c.html#a7c73091dea8c657cef945340f4bd2808">EptInveptSingleContext</a>(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a4c5c6fd61c83853d21e270e87cdea179">EptPointer</a>.AsUInt);</div>
<div class="line"><span class="lineno">  685</span> </div>
<div class="line"><span class="lineno">  686</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  687</span>    }</div>
<div class="line"><span class="lineno">  688</span> </div>
<div class="line"><span class="lineno">  689</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  690</span>    <span class="comment">// The PML1 entry not found</span></div>
<div class="line"><span class="lineno">  691</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  692</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  693</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ac8845ca75f3b4c267d3542d20621f547" name="ac8845ca75f3b4c267d3542d20621f547"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac8845ca75f3b4c267d3542d20621f547">&#9670;&#160;</a></span>EptHookUnHookAll()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookUnHookAll </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove all hooks from the hooked pages list and invalidate TLB @detailsShould be called from Vmx Non-root. </p>
<p>Remove all hooks from the hooked pages lists.</p>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 2432</span>{</div>
<div class="line"><span class="lineno"> 2433</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2434</span>    <span class="comment">// Should be called from vmx non-root</span></div>
<div class="line"><span class="lineno"> 2435</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2436</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 2437</span>    {</div>
<div class="line"><span class="lineno"> 2438</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno"> 2439</span>    }</div>
<div class="line"><span class="lineno"> 2440</span> </div>
<div class="line"><span class="lineno"> 2441</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2442</span>    <span class="comment">// Remove it in all the cores</span></div>
<div class="line"><span class="lineno"> 2443</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2444</span>    KeGenericCallDpc(<a class="code hl_function" href="hyperhv_2code_2broadcast_2_dpc_routines_8c.html#ac0df5b089250515279b8c348e0817977">DpcRoutineRemoveHookAndInvalidateAllEntriesOnAllCores</a>, 0x0);</div>
<div class="line"><span class="lineno"> 2445</span> </div>
<div class="line"><span class="lineno"> 2446</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2447</span>    <span class="comment">// In the case of unhooking all pages, we remove the hooked</span></div>
<div class="line"><span class="lineno"> 2448</span>    <span class="comment">// from EPT table in vmx-root and at last, we need to deallocate</span></div>
<div class="line"><span class="lineno"> 2449</span>    <span class="comment">// it from the buffers</span></div>
<div class="line"><span class="lineno"> 2450</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2451</span> </div>
<div class="line"><span class="lineno"> 2452</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList, CurrEntity)</div>
<div class="line"><span class="lineno"> 2453</span>    {</div>
<div class="line"><span class="lineno"> 2454</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2455</span>        <span class="comment">// Now that we removed this hidden detours hook, it is</span></div>
<div class="line"><span class="lineno"> 2456</span>        <span class="comment">// time to remove it from g_EptHook2sDetourListHead</span></div>
<div class="line"><span class="lineno"> 2457</span>        <span class="comment">// if the hook is detours</span></div>
<div class="line"><span class="lineno"> 2458</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2459</span>        <span class="keywordflow">if</span> (!CurrEntity-&gt;IsHiddenBreakpoint)</div>
<div class="line"><span class="lineno"> 2460</span>        {</div>
<div class="line"><span class="lineno"> 2461</span>            <a class="code hl_function" href="#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a>(CurrEntity-&gt;VirtualAddress);</div>
<div class="line"><span class="lineno"> 2462</span>        }</div>
<div class="line"><span class="lineno"> 2463</span> </div>
<div class="line"><span class="lineno"> 2464</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2465</span>        <span class="comment">// As we are in vmx-root here, we add the hooked entry to the list</span></div>
<div class="line"><span class="lineno"> 2466</span>        <span class="comment">// of pools that will be deallocated on next IOCTL</span></div>
<div class="line"><span class="lineno"> 2467</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2468</span>        <span class="keywordflow">if</span> (!<a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)CurrEntity))</div>
<div class="line"><span class="lineno"> 2469</span>        {</div>
<div class="line"><span class="lineno"> 2470</span>            <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><span class="lineno"> 2471</span>        }</div>
<div class="line"><span class="lineno"> 2472</span>    }</div>
<div class="line"><span class="lineno"> 2473</span>}</div>
<div class="ttc" id="a_ept_hook_8c_html_acac4eff03b2197ae43e4c13f382e20b5"><div class="ttname"><a href="#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a></div><div class="ttdeci">BOOLEAN EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList(UINT64 Address)</div><div class="ttdoc">Remove the entry from g_EptHook2sDetourListHead in the case of !epthook2 details.</div><div class="ttdef"><b>Definition</b> EptHook.c:1826</div></div>
<div class="ttc" id="ahyperhv_2code_2broadcast_2_dpc_routines_8c_html_ac0df5b089250515279b8c348e0817977"><div class="ttname"><a href="hyperhv_2code_2broadcast_2_dpc_routines_8c.html#ac0df5b089250515279b8c348e0817977">DpcRoutineRemoveHookAndInvalidateAllEntriesOnAllCores</a></div><div class="ttdeci">VOID DpcRoutineRemoveHookAndInvalidateAllEntriesOnAllCores(KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</div><div class="ttdoc">The broadcast function which removes all the hooks and invalidate TLB.</div><div class="ttdef"><b>Definition</b> DpcRoutines.c:1607</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a5304ad90d3cc4ecdc64a7c4868877435" name="a5304ad90d3cc4ecdc64a7c4868877435"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5304ad90d3cc4ecdc64a7c4868877435">&#9670;&#160;</a></span>EptHookUnHookAllByHookingTag()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookUnHookAllByHookingTag </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>HookingTag</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove all hooks from the hooked pages by the given hooking tag. </p>
<p>Should be called from Vmx Non-root</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">HookingTag</td><td>The hooking tag to unhook </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If unhook was successful it returns true or if it was not successful returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 2297</span>{</div>
<div class="line"><span class="lineno"> 2298</span>    <a class="code hl_struct" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> TargetUnhookingDetails; <span class="comment">// not used</span></div>
<div class="line"><span class="lineno"> 2299</span>    <a class="code hl_typedef" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>                           AtLeastOneUnhooked = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2300</span>    <a class="code hl_typedef" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>                           UnhookingResult    = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2301</span> </div>
<div class="line"><span class="lineno"> 2302</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2303</span>    <span class="comment">// Should be called from vmx non-root</span></div>
<div class="line"><span class="lineno"> 2304</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2305</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 2306</span>    {</div>
<div class="line"><span class="lineno"> 2307</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2308</span>    }</div>
<div class="line"><span class="lineno"> 2309</span> </div>
<div class="line"><span class="lineno"> 2310</span>KeepUnhooking:</div>
<div class="line"><span class="lineno"> 2311</span>    UnhookingResult = <a class="code hl_function" href="#af8b74d71541023dd924e0a7c01a6c3c1">EptHookPerformUnHookSingleAddress</a>(<a class="code hl_define" href="_basic_types_8h.html#a32ab457827837bf5ac123dd0fd8326ae">NULL_ZERO</a>,</div>
<div class="line"><span class="lineno"> 2312</span>                                                        <a class="code hl_define" href="_basic_types_8h.html#a32ab457827837bf5ac123dd0fd8326ae">NULL_ZERO</a>,</div>
<div class="line"><span class="lineno"> 2313</span>                                                        HookingTag,</div>
<div class="line"><span class="lineno"> 2314</span>                                                        <a class="code hl_define" href="_basic_types_8h.html#a32ab457827837bf5ac123dd0fd8326ae">NULL_ZERO</a>,</div>
<div class="line"><span class="lineno"> 2315</span>                                                        <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,</div>
<div class="line"><span class="lineno"> 2316</span>                                                        &amp;TargetUnhookingDetails);</div>
<div class="line"><span class="lineno"> 2317</span> </div>
<div class="line"><span class="lineno"> 2318</span>    <span class="keywordflow">if</span> (UnhookingResult)</div>
<div class="line"><span class="lineno"> 2319</span>    {</div>
<div class="line"><span class="lineno"> 2320</span>        AtLeastOneUnhooked = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2321</span> </div>
<div class="line"><span class="lineno"> 2322</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2323</span>        <span class="comment">// Keep unhooking until there is no more hooking details</span></div>
<div class="line"><span class="lineno"> 2324</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2325</span>        <span class="keywordflow">goto</span> KeepUnhooking;</div>
<div class="line"><span class="lineno"> 2326</span>    }</div>
<div class="line"><span class="lineno"> 2327</span> </div>
<div class="line"><span class="lineno"> 2328</span>    <span class="keywordflow">return</span> AtLeastOneUnhooked;</div>
<div class="line"><span class="lineno"> 2329</span>}</div>
<div class="ttc" id="a_ept_hook_8c_html_af8b74d71541023dd924e0a7c01a6c3c1"><div class="ttname"><a href="#af8b74d71541023dd924e0a7c01a6c3c1">EptHookPerformUnHookSingleAddress</a></div><div class="ttdeci">BOOLEAN EptHookPerformUnHookSingleAddress(UINT64 VirtualAddress, UINT64 PhysAddress, UINT64 HookingTag, UINT32 ProcessId, BOOLEAN ApplyDirectlyFromVmxRoot, EPT_SINGLE_HOOK_UNHOOKING_DETAILS *TargetUnhookingDetails)</div><div class="ttdoc">Remove single hook from the hooked pages list and invalidate TLB.</div><div class="ttdef"><b>Definition</b> EptHook.c:2209</div></div>
<div class="ttc" id="astruct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s_html"><div class="ttname"><a href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html">_EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a></div><div class="ttdoc">Details of unhooking single EPT hooks.</div><div class="ttdef"><b>Definition</b> DataTypes.h:358</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a24ce2115ab4514ec8eed08d0911b64d6" name="a24ce2115ab4514ec8eed08d0911b64d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a24ce2115ab4514ec8eed08d0911b64d6">&#9670;&#160;</a></span>EptHookUnHookSingleAddress()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookUnHookSingleAddress </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>VirtualAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>PhysAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></td>          <td class="paramname"><span class="paramname"><em>ProcessId</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove single hook from the hooked pages list and invalidate TLB. </p>
<p>Remove single hook from the hooked pages list and invalidate TLB From VMX non-root mode.</p>
<p>Should be called from VMX non-root</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VirtualAddress</td><td>Virtual address to unhook </td></tr>
    <tr><td class="paramname">PhysAddress</td><td>Physical address to unhook (optional) </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id of target process</td></tr>
  </table>
  </dd>
</dl>
<p>in unhooking for some hooks only physical address is availables</p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If unhook was successful it returns true or if it was not successful returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 2373</span>{</div>
<div class="line"><span class="lineno"> 2374</span>    <a class="code hl_struct" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> TargetUnhookingDetails; <span class="comment">// not used</span></div>
<div class="line"><span class="lineno"> 2375</span> </div>
<div class="line"><span class="lineno"> 2376</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2377</span>    <span class="comment">// Should be called from VMX non-root</span></div>
<div class="line"><span class="lineno"> 2378</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2379</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 2380</span>    {</div>
<div class="line"><span class="lineno"> 2381</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2382</span>    }</div>
<div class="line"><span class="lineno"> 2383</span> </div>
<div class="line"><span class="lineno"> 2384</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="#af8b74d71541023dd924e0a7c01a6c3c1">EptHookPerformUnHookSingleAddress</a>(VirtualAddress,</div>
<div class="line"><span class="lineno"> 2385</span>                                             PhysAddress,</div>
<div class="line"><span class="lineno"> 2386</span>                                             <a class="code hl_define" href="_basic_types_8h.html#a32ab457827837bf5ac123dd0fd8326ae">NULL_ZERO</a>,</div>
<div class="line"><span class="lineno"> 2387</span>                                             ProcessId,</div>
<div class="line"><span class="lineno"> 2388</span>                                             <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,</div>
<div class="line"><span class="lineno"> 2389</span>                                             &amp;TargetUnhookingDetails);</div>
<div class="line"><span class="lineno"> 2390</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a15af39b643632343c25539a4931084ce" name="a15af39b643632343c25539a4931084ce"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a15af39b643632343c25539a4931084ce">&#9670;&#160;</a></span>EptHookUnHookSingleAddressDetoursAndMonitor()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookUnHookSingleAddressDetoursAndMonitor </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a></td>          <td class="paramname"><span class="paramname"><em>HookedEntry</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></td>          <td class="paramname"><span class="paramname"><em>ApplyDirectlyFromVmxRoot</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_data_types_8h.html#a27c1e2d2980e51cf66a1c72b3f08ba13">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> *</td>          <td class="paramname"><span class="paramname"><em>TargetUnhookingDetails</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove single hook of detours type. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">HookedEntry</td><td>entry detail of hooked address </td></tr>
    <tr><td class="paramname">ApplyDirectlyFromVmxRoot</td><td>should it be directly applied from VMX-root mode or not </td></tr>
    <tr><td class="paramname">TargetUnhookingDetails</td><td>Target data for the caller to restore EPT entry and invalidate EPT caches. Only when applied in VMX-root mode directly</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If unhook was successful it returns true or if it was not successful returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1905</span>{</div>
<div class="line"><span class="lineno"> 1906</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1907</span>    <span class="comment">// Set the unhooking details</span></div>
<div class="line"><span class="lineno"> 1908</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1909</span>    TargetUnhookingDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a9e1a650400caaad2d9960952d24c123f">PhysicalAddress</a> = HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a>;</div>
<div class="line"><span class="lineno"> 1910</span>    TargetUnhookingDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#add748fa55be0a6401299d3e04085ad12">OriginalEntry</a>   = HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">OriginalEntry</a>.AsUInt;</div>
<div class="line"><span class="lineno"> 1911</span> </div>
<div class="line"><span class="lineno"> 1912</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1913</span>    <span class="comment">// If applied directly from VMX-root mode, it&#39;s the responsibility of the</span></div>
<div class="line"><span class="lineno"> 1914</span>    <span class="comment">// caller to remove the hook and invalidate EPT caches for the target physical address</span></div>
<div class="line"><span class="lineno"> 1915</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1916</span>    <span class="keywordflow">if</span> (ApplyDirectlyFromVmxRoot)</div>
<div class="line"><span class="lineno"> 1917</span>    {</div>
<div class="line"><span class="lineno"> 1918</span>        TargetUnhookingDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a57f57a8f23a7788f38ae80064447e88f">CallerNeedsToRestoreEntryAndInvalidateEpt</a> = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1919</span>    }</div>
<div class="line"><span class="lineno"> 1920</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1921</span>    {</div>
<div class="line"><span class="lineno"> 1922</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1923</span>        <span class="comment">// Remove it in all the cores</span></div>
<div class="line"><span class="lineno"> 1924</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1925</span>        TargetUnhookingDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a57f57a8f23a7788f38ae80064447e88f">CallerNeedsToRestoreEntryAndInvalidateEpt</a> = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1926</span>        KeGenericCallDpc(<a class="code hl_function" href="hyperhv_2code_2broadcast_2_dpc_routines_8c.html#ae978b3d6e7b660da69ab279da37a529e">DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores</a>, TargetUnhookingDetails);</div>
<div class="line"><span class="lineno"> 1927</span>    }</div>
<div class="line"><span class="lineno"> 1928</span> </div>
<div class="line"><span class="lineno"> 1929</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1930</span>    <span class="comment">// Now that we removed this hidden detours hook, it is</span></div>
<div class="line"><span class="lineno"> 1931</span>    <span class="comment">// time to remove it from g_EptHook2sDetourListHead</span></div>
<div class="line"><span class="lineno"> 1932</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1933</span>    <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a40f5606fe57295d12c430ce08421e544">IsExecutionHook</a>)</div>
<div class="line"><span class="lineno"> 1934</span>    {</div>
<div class="line"><span class="lineno"> 1935</span>        <a class="code hl_function" href="#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a>(HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">VirtualAddress</a>);</div>
<div class="line"><span class="lineno"> 1936</span>    }</div>
<div class="line"><span class="lineno"> 1937</span> </div>
<div class="line"><span class="lineno"> 1938</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1939</span>    <span class="comment">// remove the entry from the list</span></div>
<div class="line"><span class="lineno"> 1940</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1941</span>    <a class="code hl_function" href="_windows_8h.html#aac75b07955a17d40e91325491bbac645">RemoveEntryList</a>(&amp;HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">PageHookList</a>);</div>
<div class="line"><span class="lineno"> 1942</span> </div>
<div class="line"><span class="lineno"> 1943</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1944</span>    <span class="comment">// we add the hooked entry to the list</span></div>
<div class="line"><span class="lineno"> 1945</span>    <span class="comment">// of pools that will be deallocated on next IOCTL</span></div>
<div class="line"><span class="lineno"> 1946</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1947</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)HookedEntry))</div>
<div class="line"><span class="lineno"> 1948</span>    {</div>
<div class="line"><span class="lineno"> 1949</span>        <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><span class="lineno"> 1950</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1951</span>    }</div>
<div class="line"><span class="lineno"> 1952</span> </div>
<div class="line"><span class="lineno"> 1953</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1954</span>}</div>
<div class="ttc" id="ahyperhv_2code_2broadcast_2_dpc_routines_8c_html_ae978b3d6e7b660da69ab279da37a529e"><div class="ttname"><a href="hyperhv_2code_2broadcast_2_dpc_routines_8c.html#ae978b3d6e7b660da69ab279da37a529e">DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores</a></div><div class="ttdeci">VOID DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores(KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</div><div class="ttdoc">The broadcast function which removes the single hook and invalidate TLB.</div><div class="ttdef"><b>Definition</b> DpcRoutines.c:1638</div></div>
<div class="ttc" id="astruct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s_html_a57f57a8f23a7788f38ae80064447e88f"><div class="ttname"><a href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a57f57a8f23a7788f38ae80064447e88f">_EPT_SINGLE_HOOK_UNHOOKING_DETAILS::CallerNeedsToRestoreEntryAndInvalidateEpt</a></div><div class="ttdeci">BOOLEAN CallerNeedsToRestoreEntryAndInvalidateEpt</div><div class="ttdef"><b>Definition</b> DataTypes.h:359</div></div>
<div class="ttc" id="astruct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s_html_a9e1a650400caaad2d9960952d24c123f"><div class="ttname"><a href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a9e1a650400caaad2d9960952d24c123f">_EPT_SINGLE_HOOK_UNHOOKING_DETAILS::PhysicalAddress</a></div><div class="ttdeci">SIZE_T PhysicalAddress</div><div class="ttdef"><b>Definition</b> DataTypes.h:361</div></div>
<div class="ttc" id="astruct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s_html_add748fa55be0a6401299d3e04085ad12"><div class="ttname"><a href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#add748fa55be0a6401299d3e04085ad12">_EPT_SINGLE_HOOK_UNHOOKING_DETAILS::OriginalEntry</a></div><div class="ttdeci">UINT64 OriginalEntry</div><div class="ttdef"><b>Definition</b> DataTypes.h:362</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a80ec91bc8431e536aa32d2e182444f17" name="a80ec91bc8431e536aa32d2e182444f17"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a80ec91bc8431e536aa32d2e182444f17">&#9670;&#160;</a></span>EptHookUnHookSingleAddressFromVmxRoot()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookUnHookSingleAddressFromVmxRoot </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>VirtualAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>PhysAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_data_types_8h.html#a27c1e2d2980e51cf66a1c72b3f08ba13">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> *</td>          <td class="paramname"><span class="paramname"><em>TargetUnhookingDetails</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove single hook from the hooked pages list and invalidate TLB. </p>
<p>Remove single hook from the hooked pages list and invalidate TLB From VMX root-mode.</p>
<p>Should be called from VMX root-mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VirtualAddress</td><td>Virtual address to unhook </td></tr>
    <tr><td class="paramname">PhysAddress</td><td>Physical address to unhook (optional) </td></tr>
    <tr><td class="paramname">TargetUnhookingDetails</td><td>Target data for the caller to restore EPT entry and invalidate EPT caches. Only when applied in VMX-root mode directly</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If unhook was successful it returns true or if it was not successful returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 2407</span>{</div>
<div class="line"><span class="lineno"> 2408</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2409</span>    <span class="comment">// Should be called from VMX root-mode</span></div>
<div class="line"><span class="lineno"> 2410</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2411</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno"> 2412</span>    {</div>
<div class="line"><span class="lineno"> 2413</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2414</span>    }</div>
<div class="line"><span class="lineno"> 2415</span> </div>
<div class="line"><span class="lineno"> 2416</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="#af8b74d71541023dd924e0a7c01a6c3c1">EptHookPerformUnHookSingleAddress</a>(VirtualAddress,</div>
<div class="line"><span class="lineno"> 2417</span>                                             PhysAddress,</div>
<div class="line"><span class="lineno"> 2418</span>                                             <a class="code hl_define" href="_basic_types_8h.html#a8a9df53f35cb95dddbe3c564259e01ad">NULL64_ZERO</a>,</div>
<div class="line"><span class="lineno"> 2419</span>                                             <a class="code hl_define" href="_basic_types_8h.html#a32ab457827837bf5ac123dd0fd8326ae">NULL_ZERO</a>,</div>
<div class="line"><span class="lineno"> 2420</span>                                             <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,</div>
<div class="line"><span class="lineno"> 2421</span>                                             TargetUnhookingDetails);</div>
<div class="line"><span class="lineno"> 2422</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ab65f9dabbdc5421ee817b6962b4fbbc3" name="ab65f9dabbdc5421ee817b6962b4fbbc3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab65f9dabbdc5421ee817b6962b4fbbc3">&#9670;&#160;</a></span>EptHookUnHookSingleAddressHiddenBreakpoint()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookUnHookSingleAddressHiddenBreakpoint </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hyperhv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a></td>          <td class="paramname"><span class="paramname"><em>HookedEntry</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>VirtualAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></td>          <td class="paramname"><span class="paramname"><em>ApplyDirectlyFromVmxRoot</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_data_types_8h.html#a27c1e2d2980e51cf66a1c72b3f08ba13">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> *</td>          <td class="paramname"><span class="paramname"><em>TargetUnhookingDetails</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove single hook of hidden breakpoint type. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">HookedEntry</td><td>entry detail of hooked address </td></tr>
    <tr><td class="paramname">VirtualAddress</td><td>virtual address to unhook </td></tr>
    <tr><td class="paramname">ApplyDirectlyFromVmxRoot</td><td>should it be directly applied from VMX-root mode or not </td></tr>
    <tr><td class="paramname">TargetUnhookingDetails</td><td>Target data for the caller to restore EPT entry and invalidate EPT caches. Only when applied in VMX-root mode directly</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If unhook was successful it returns true or if it was not successful returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 2035</span>{</div>
<div class="line"><span class="lineno"> 2036</span>    <a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> TargetAddressInFakePageContent;</div>
<div class="line"><span class="lineno"> 2037</span>    <a class="code hl_typedef" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> CountOfEntriesWithSameAddr = 0;</div>
<div class="line"><span class="lineno"> 2038</span> </div>
<div class="line"><span class="lineno"> 2039</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2040</span>    <span class="comment">// By default, the caller doesn&#39;t need to remove #BPs interceptions if directly</span></div>
<div class="line"><span class="lineno"> 2041</span>    <span class="comment">// applied from VMX-root mode</span></div>
<div class="line"><span class="lineno"> 2042</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2043</span>    TargetUnhookingDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a9ee915d175d8e13d20873388aa81ca8a">RemoveBreakpointInterception</a> = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2044</span> </div>
<div class="line"><span class="lineno"> 2045</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2046</span>    <span class="comment">// It&#39;s a hidden breakpoint (we have to search through an array of addresses)</span></div>
<div class="line"><span class="lineno"> 2047</span>    <span class="comment">// We count it from top to down because if there are two ept hooks at the</span></div>
<div class="line"><span class="lineno"> 2048</span>    <span class="comment">// same address, then the last one has an invalid PreviousByte and this</span></div>
<div class="line"><span class="lineno"> 2049</span>    <span class="comment">// is the HookedEntry that should be remove (not the first one as it has the</span></div>
<div class="line"><span class="lineno"> 2050</span>    <span class="comment">// correct PreviousByte)</span></div>
<div class="line"><span class="lineno"> 2051</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2052</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a>; i++)</div>
<div class="line"><span class="lineno"> 2053</span>    {</div>
<div class="line"><span class="lineno"> 2054</span>        <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[i] == VirtualAddress)</div>
<div class="line"><span class="lineno"> 2055</span>        {</div>
<div class="line"><span class="lineno"> 2056</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2057</span>            <span class="comment">// Check if it&#39;s a single breakpoint</span></div>
<div class="line"><span class="lineno"> 2058</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2059</span>            <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a> == 1)</div>
<div class="line"><span class="lineno"> 2060</span>            {</div>
<div class="line"><span class="lineno"> 2061</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2062</span>                <span class="comment">// Set the unhooking details</span></div>
<div class="line"><span class="lineno"> 2063</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2064</span>                TargetUnhookingDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a9e1a650400caaad2d9960952d24c123f">PhysicalAddress</a> = HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a>;</div>
<div class="line"><span class="lineno"> 2065</span>                TargetUnhookingDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#add748fa55be0a6401299d3e04085ad12">OriginalEntry</a>   = HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">OriginalEntry</a>.AsUInt;</div>
<div class="line"><span class="lineno"> 2066</span> </div>
<div class="line"><span class="lineno"> 2067</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2068</span>                <span class="comment">// If applied directly from VMX-root mode, it&#39;s the responsibility of the</span></div>
<div class="line"><span class="lineno"> 2069</span>                <span class="comment">// caller to remove the hook and invalidate EPT caches for the target physical address</span></div>
<div class="line"><span class="lineno"> 2070</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2071</span>                <span class="keywordflow">if</span> (ApplyDirectlyFromVmxRoot)</div>
<div class="line"><span class="lineno"> 2072</span>                {</div>
<div class="line"><span class="lineno"> 2073</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2074</span>                    <span class="comment">// The caller is responsible for restoring EPT entry and invalidate caches</span></div>
<div class="line"><span class="lineno"> 2075</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2076</span>                    TargetUnhookingDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a57f57a8f23a7788f38ae80064447e88f">CallerNeedsToRestoreEntryAndInvalidateEpt</a> = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2077</span>                }</div>
<div class="line"><span class="lineno"> 2078</span>                <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2079</span>                {</div>
<div class="line"><span class="lineno"> 2080</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2081</span>                    <span class="comment">// Remove the hook entirely on all cores</span></div>
<div class="line"><span class="lineno"> 2082</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2083</span>                    TargetUnhookingDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a57f57a8f23a7788f38ae80064447e88f">CallerNeedsToRestoreEntryAndInvalidateEpt</a> = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2084</span>                    KeGenericCallDpc(<a class="code hl_function" href="hyperhv_2code_2broadcast_2_dpc_routines_8c.html#ae978b3d6e7b660da69ab279da37a529e">DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores</a>, TargetUnhookingDetails);</div>
<div class="line"><span class="lineno"> 2085</span>                }</div>
<div class="line"><span class="lineno"> 2086</span> </div>
<div class="line"><span class="lineno"> 2087</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2088</span>                <span class="comment">// remove the entry from the list</span></div>
<div class="line"><span class="lineno"> 2089</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2090</span>                <a class="code hl_function" href="_windows_8h.html#aac75b07955a17d40e91325491bbac645">RemoveEntryList</a>(&amp;HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">PageHookList</a>);</div>
<div class="line"><span class="lineno"> 2091</span> </div>
<div class="line"><span class="lineno"> 2092</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2093</span>                <span class="comment">// we add the hooked entry to the list</span></div>
<div class="line"><span class="lineno"> 2094</span>                <span class="comment">// of pools that will be deallocated on next IOCTL</span></div>
<div class="line"><span class="lineno"> 2095</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2096</span>                <span class="keywordflow">if</span> (!<a class="code hl_function" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>((<a class="code hl_typedef" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)HookedEntry))</div>
<div class="line"><span class="lineno"> 2097</span>                {</div>
<div class="line"><span class="lineno"> 2098</span>                    <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><span class="lineno"> 2099</span>                }</div>
<div class="line"><span class="lineno"> 2100</span> </div>
<div class="line"><span class="lineno"> 2101</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2102</span>                <span class="comment">// Check if there is any other breakpoints, if no then we have to disable</span></div>
<div class="line"><span class="lineno"> 2103</span>                <span class="comment">// exception bitmaps on vm-exits for breakpoint, for this purpose, we have</span></div>
<div class="line"><span class="lineno"> 2104</span>                <span class="comment">// to visit all the entries to see if there is any entries</span></div>
<div class="line"><span class="lineno"> 2105</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2106</span>                <span class="keywordflow">if</span> (<a class="code hl_function" href="#acd0179b7c5730f636141dfea2afcdc5a">EptHookGetCountOfEpthooks</a>(<a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) == 0)</div>
<div class="line"><span class="lineno"> 2107</span>                {</div>
<div class="line"><span class="lineno"> 2108</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2109</span>                    <span class="comment">// If applied directly from VMX-root mode, it&#39;s the responsibility of the</span></div>
<div class="line"><span class="lineno"> 2110</span>                    <span class="comment">// caller to broadcast to disable breakpoint exceptions on all cores</span></div>
<div class="line"><span class="lineno"> 2111</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2112</span>                    <span class="keywordflow">if</span> (ApplyDirectlyFromVmxRoot)</div>
<div class="line"><span class="lineno"> 2113</span>                    {</div>
<div class="line"><span class="lineno"> 2114</span>                        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2115</span>                        <span class="comment">// Set whether it was the last hook (and the caller if applied from VMX-root needed</span></div>
<div class="line"><span class="lineno"> 2116</span>                        <span class="comment">// to broadcast to disable #BPs interception on exception bitmaps or not)</span></div>
<div class="line"><span class="lineno"> 2117</span>                        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2118</span>                        TargetUnhookingDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a9ee915d175d8e13d20873388aa81ca8a">RemoveBreakpointInterception</a> = <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2119</span>                    }</div>
<div class="line"><span class="lineno"> 2120</span>                    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2121</span>                    {</div>
<div class="line"><span class="lineno"> 2122</span>                        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2123</span>                        <span class="comment">// Did not find any entry, let&#39;s disable the breakpoints vm-exits</span></div>
<div class="line"><span class="lineno"> 2124</span>                        <span class="comment">// on exception bitmaps</span></div>
<div class="line"><span class="lineno"> 2125</span>                        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2126</span>                        TargetUnhookingDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a9ee915d175d8e13d20873388aa81ca8a">RemoveBreakpointInterception</a> = <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2127</span>                        <a class="code hl_function" href="_broadcast_8c.html#aa7dce498eb6cbba84d821e4a5c0e1275">BroadcastDisableBreakpointExitingOnExceptionBitmapAllCores</a>();</div>
<div class="line"><span class="lineno"> 2128</span>                    }</div>
<div class="line"><span class="lineno"> 2129</span>                }</div>
<div class="line"><span class="lineno"> 2130</span> </div>
<div class="line"><span class="lineno"> 2131</span>                <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2132</span>            }</div>
<div class="line"><span class="lineno"> 2133</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 2134</span>            {</div>
<div class="line"><span class="lineno"> 2135</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2136</span>                <span class="comment">// Set 0xcc to its previous value</span></div>
<div class="line"><span class="lineno"> 2137</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2138</span>                TargetAddressInFakePageContent = EptHookCalcBreakpointOffset((PVOID)VirtualAddress, HookedEntry);</div>
<div class="line"><span class="lineno"> 2139</span> </div>
<div class="line"><span class="lineno"> 2140</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2141</span>                <span class="comment">// We&#39;ll check if there is another hooked address with the same virtual address</span></div>
<div class="line"><span class="lineno"> 2142</span>                <span class="comment">// in the array, then we&#39;ll ignore setting the previous bit as previous bit might</span></div>
<div class="line"><span class="lineno"> 2143</span>                <span class="comment">// be modified for the previous command</span></div>
<div class="line"><span class="lineno"> 2144</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2145</span>                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; HookedEntry-&gt;CountOfBreakpoints; j++)</div>
<div class="line"><span class="lineno"> 2146</span>                {</div>
<div class="line"><span class="lineno"> 2147</span>                    <span class="keywordflow">if</span> (HookedEntry-&gt;BreakpointAddresses[j] == VirtualAddress)</div>
<div class="line"><span class="lineno"> 2148</span>                    {</div>
<div class="line"><span class="lineno"> 2149</span>                        CountOfEntriesWithSameAddr++;</div>
<div class="line"><span class="lineno"> 2150</span>                    }</div>
<div class="line"><span class="lineno"> 2151</span>                }</div>
<div class="line"><span class="lineno"> 2152</span> </div>
<div class="line"><span class="lineno"> 2153</span>                <span class="keywordflow">if</span> (CountOfEntriesWithSameAddr == 1)</div>
<div class="line"><span class="lineno"> 2154</span>                {</div>
<div class="line"><span class="lineno"> 2155</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2156</span>                    <span class="comment">// Set the previous value</span></div>
<div class="line"><span class="lineno"> 2157</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2158</span>                    *(<a class="code hl_typedef" href="_basic_types_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *)TargetAddressInFakePageContent = HookedEntry-&gt;PreviousBytesOnBreakpointAddresses[i];</div>
<div class="line"><span class="lineno"> 2159</span>                }</div>
<div class="line"><span class="lineno"> 2160</span> </div>
<div class="line"><span class="lineno"> 2161</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2162</span>                <span class="comment">// Remove just that special entry</span></div>
<div class="line"><span class="lineno"> 2163</span>                <span class="comment">// BTW, No need to remove it, it will be replaced automatically</span></div>
<div class="line"><span class="lineno"> 2164</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2165</span>                HookedEntry-&gt;BreakpointAddresses[i]                = <a class="code hl_define" href="_basic_types_8h.html#a8a9df53f35cb95dddbe3c564259e01ad">NULL64_ZERO</a>;</div>
<div class="line"><span class="lineno"> 2166</span>                HookedEntry-&gt;PreviousBytesOnBreakpointAddresses[i] = 0x0;</div>
<div class="line"><span class="lineno"> 2167</span> </div>
<div class="line"><span class="lineno"> 2168</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2169</span>                <span class="comment">// all addresses to a lower array index (because one entry is</span></div>
<div class="line"><span class="lineno"> 2170</span>                <span class="comment">// missing and might) be in the middle of the array</span></div>
<div class="line"><span class="lineno"> 2171</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2172</span>                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = i <span class="comment">/* IndexToRemove */</span>; j &lt; HookedEntry-&gt;CountOfBreakpoints - 1; j++)</div>
<div class="line"><span class="lineno"> 2173</span>                {</div>
<div class="line"><span class="lineno"> 2174</span>                    HookedEntry-&gt;BreakpointAddresses[j]                = HookedEntry-&gt;BreakpointAddresses[j + 1];</div>
<div class="line"><span class="lineno"> 2175</span>                    HookedEntry-&gt;PreviousBytesOnBreakpointAddresses[j] = HookedEntry-&gt;PreviousBytesOnBreakpointAddresses[j + 1];</div>
<div class="line"><span class="lineno"> 2176</span>                }</div>
<div class="line"><span class="lineno"> 2177</span> </div>
<div class="line"><span class="lineno"> 2178</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2179</span>                <span class="comment">// Decrease the count of breakpoints</span></div>
<div class="line"><span class="lineno"> 2180</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2181</span>                HookedEntry-&gt;CountOfBreakpoints = HookedEntry-&gt;CountOfBreakpoints - 1;</div>
<div class="line"><span class="lineno"> 2182</span> </div>
<div class="line"><span class="lineno"> 2183</span>                <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 2184</span>            }</div>
<div class="line"><span class="lineno"> 2185</span>        }</div>
<div class="line"><span class="lineno"> 2186</span>    }</div>
<div class="line"><span class="lineno"> 2187</span> </div>
<div class="line"><span class="lineno"> 2188</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2189</span>    <span class="comment">// If we reach here, sth went wrong</span></div>
<div class="line"><span class="lineno"> 2190</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2191</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2192</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_a4ae1dab0fb4b072a66584546209e7d58"><div class="ttname"><a href="_basic_types_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a></div><div class="ttdeci">unsigned char BYTE</div><div class="ttdef"><b>Definition</b> BasicTypes.h:24</div></div>
<div class="ttc" id="a_broadcast_8c_html_aa7dce498eb6cbba84d821e4a5c0e1275"><div class="ttname"><a href="_broadcast_8c.html#aa7dce498eb6cbba84d821e4a5c0e1275">BroadcastDisableBreakpointExitingOnExceptionBitmapAllCores</a></div><div class="ttdeci">VOID BroadcastDisableBreakpointExitingOnExceptionBitmapAllCores()</div><div class="ttdoc">routines to disable vm-exit for breakpoints (exception bitmap)</div><div class="ttdef"><b>Definition</b> Broadcast.c:77</div></div>
<div class="ttc" id="a_ept_hook_8c_html_acd0179b7c5730f636141dfea2afcdc5a"><div class="ttname"><a href="#acd0179b7c5730f636141dfea2afcdc5a">EptHookGetCountOfEpthooks</a></div><div class="ttdeci">UINT32 EptHookGetCountOfEpthooks(BOOLEAN IsEptHook2)</div><div class="ttdoc">get the length of active EPT hooks (!epthook and !epthook2)</div><div class="ttdef"><b>Definition</b> EptHook.c:1865</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_aaaf2650f56c9581f4724da1e833257ef"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">_EPT_HOOKED_PAGE_DETAIL::BreakpointAddresses</a></div><div class="ttdeci">UINT64 BreakpointAddresses[MaximumHiddenBreakpointsOnPage]</div><div class="ttdoc">Address of hooked pages (multiple breakpoints on a single page) this is only used in hidden breakpoin...</div><div class="ttdef"><b>Definition</b> State.h:259</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_afc5fdacf494efec054863c41f754b0a0"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">_EPT_HOOKED_PAGE_DETAIL::CountOfBreakpoints</a></div><div class="ttdeci">UINT64 CountOfBreakpoints</div><div class="ttdoc">Count of breakpoints (multiple breakpoints on a single page) this is only used in hidden breakpoints ...</div><div class="ttdef"><b>Definition</b> State.h:271</div></div>
<div class="ttc" id="astruct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s_html_a9ee915d175d8e13d20873388aa81ca8a"><div class="ttname"><a href="struct___e_p_t___s_i_n_g_l_e___h_o_o_k___u_n_h_o_o_k_i_n_g___d_e_t_a_i_l_s.html#a9ee915d175d8e13d20873388aa81ca8a">_EPT_SINGLE_HOOK_UNHOOKING_DETAILS::RemoveBreakpointInterception</a></div><div class="ttdeci">BOOLEAN RemoveBreakpointInterception</div><div class="ttdef"><b>Definition</b> DataTypes.h:360</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="af811dff7684ead032bf5439bfab2b928" name="af811dff7684ead032bf5439bfab2b928"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af811dff7684ead032bf5439bfab2b928">&#9670;&#160;</a></span>EptHookUnHookSingleHookByHookingTagFromVmxRoot()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookUnHookSingleHookByHookingTagFromVmxRoot </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></td>          <td class="paramname"><span class="paramname"><em>HookingTag</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_data_types_8h.html#a27c1e2d2980e51cf66a1c72b3f08ba13">EPT_SINGLE_HOOK_UNHOOKING_DETAILS</a> *</td>          <td class="paramname"><span class="paramname"><em>TargetUnhookingDetails</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove single hook from the hooked pages by the given hooking tag. </p>
<p>Should be called from Vmx root-mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">HookingTag</td><td>The hooking tag to unhook </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If unhook was successful it returns true or if it was not successful returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 2341</span>{</div>
<div class="line"><span class="lineno"> 2342</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2343</span>    <span class="comment">// Should be called from VMX root-mode</span></div>
<div class="line"><span class="lineno"> 2344</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 2345</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno"> 2346</span>    {</div>
<div class="line"><span class="lineno"> 2347</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 2348</span>    }</div>
<div class="line"><span class="lineno"> 2349</span> </div>
<div class="line"><span class="lineno"> 2350</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="#af8b74d71541023dd924e0a7c01a6c3c1">EptHookPerformUnHookSingleAddress</a>(<a class="code hl_define" href="_basic_types_8h.html#a8a9df53f35cb95dddbe3c564259e01ad">NULL64_ZERO</a>,</div>
<div class="line"><span class="lineno"> 2351</span>                                             <a class="code hl_define" href="_basic_types_8h.html#a8a9df53f35cb95dddbe3c564259e01ad">NULL64_ZERO</a>,</div>
<div class="line"><span class="lineno"> 2352</span>                                             HookingTag,</div>
<div class="line"><span class="lineno"> 2353</span>                                             <a class="code hl_define" href="_basic_types_8h.html#a32ab457827837bf5ac123dd0fd8326ae">NULL_ZERO</a>,</div>
<div class="line"><span class="lineno"> 2354</span>                                             <a class="code hl_define" href="_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,</div>
<div class="line"><span class="lineno"> 2355</span>                                             TargetUnhookingDetails);</div>
<div class="line"><span class="lineno"> 2356</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a50935db932e916707520e63212e9e688" name="a50935db932e916707520e63212e9e688"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a50935db932e916707520e63212e9e688">&#9670;&#160;</a></span>EptHookWriteAbsoluteJump()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookWriteAbsoluteJump </td>
          <td>(</td>
          <td class="paramtype">PCHAR</td>          <td class="paramname"><span class="paramname"><em>TargetBuffer</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SIZE_T</td>          <td class="paramname"><span class="paramname"><em>TargetAddress</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Write an absolute x64 jump to an arbitrary address to a buffer. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetBuffer</td><td></td></tr>
    <tr><td class="paramname">TargetAddress</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  744</span>{</div>
<div class="line"><span class="lineno">  745</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  746</span>    <span class="comment">// call $ + 5 ; A 64-bit call instruction is still 5 bytes wide!</span></div>
<div class="line"><span class="lineno">  747</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  748</span> </div>
<div class="line"><span class="lineno">  749</span>    TargetBuffer[0] = 0xe8;</div>
<div class="line"><span class="lineno">  750</span>    TargetBuffer[1] = 0x00;</div>
<div class="line"><span class="lineno">  751</span>    TargetBuffer[2] = 0x00;</div>
<div class="line"><span class="lineno">  752</span>    TargetBuffer[3] = 0x00;</div>
<div class="line"><span class="lineno">  753</span>    TargetBuffer[4] = 0x00;</div>
<div class="line"><span class="lineno">  754</span> </div>
<div class="line"><span class="lineno">  755</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  756</span>    <span class="comment">// push Lower 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  757</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  758</span>    TargetBuffer[5] = 0x68;</div>
<div class="line"><span class="lineno">  759</span> </div>
<div class="line"><span class="lineno">  760</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  761</span>    <span class="comment">// Lower 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  762</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  763</span>    *((<a class="code hl_typedef" href="_basic_types_8h.html#a8e3d0f172defb4e820ad5df4ec48960c">PUINT32</a>)&amp;TargetBuffer[6]) = (<a class="code hl_typedef" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)TargetAddress;</div>
<div class="line"><span class="lineno">  764</span> </div>
<div class="line"><span class="lineno">  765</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  766</span>    <span class="comment">// mov [rsp+4],High 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  767</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  768</span>    TargetBuffer[10] = 0xC7;</div>
<div class="line"><span class="lineno">  769</span>    TargetBuffer[11] = 0x44;</div>
<div class="line"><span class="lineno">  770</span>    TargetBuffer[12] = 0x24;</div>
<div class="line"><span class="lineno">  771</span>    TargetBuffer[13] = 0x04;</div>
<div class="line"><span class="lineno">  772</span> </div>
<div class="line"><span class="lineno">  773</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  774</span>    <span class="comment">// High 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  775</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  776</span>    *((<a class="code hl_typedef" href="_basic_types_8h.html#a8e3d0f172defb4e820ad5df4ec48960c">PUINT32</a>)&amp;TargetBuffer[14]) = (<a class="code hl_typedef" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)(TargetAddress &gt;&gt; 32);</div>
<div class="line"><span class="lineno">  777</span> </div>
<div class="line"><span class="lineno">  778</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  779</span>    <span class="comment">// ret</span></div>
<div class="line"><span class="lineno">  780</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  781</span>    TargetBuffer[18] = 0xC3;</div>
<div class="line"><span class="lineno">  782</span>}</div>
<div class="ttc" id="a_basic_types_8h_html_a8e3d0f172defb4e820ad5df4ec48960c"><div class="ttname"><a href="_basic_types_8h.html#a8e3d0f172defb4e820ad5df4ec48960c">PUINT32</a></div><div class="ttdeci">unsigned int * PUINT32</div><div class="ttdef"><b>Definition</b> BasicTypes.h:48</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a8767a6d054fe785e66068e32b4466b87" name="a8767a6d054fe785e66068e32b4466b87"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8767a6d054fe785e66068e32b4466b87">&#9670;&#160;</a></span>EptHookWriteAbsoluteJump2()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookWriteAbsoluteJump2 </td>
          <td>(</td>
          <td class="paramtype">PCHAR</td>          <td class="paramname"><span class="paramname"><em>TargetBuffer</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SIZE_T</td>          <td class="paramname"><span class="paramname"><em>TargetAddress</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Write an absolute x64 jump to an arbitrary address to a buffer. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetBuffer</td><td></td></tr>
    <tr><td class="paramname">TargetAddress</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  793</span>{</div>
<div class="line"><span class="lineno">  794</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  795</span>    <span class="comment">// push Lower 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  796</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  797</span>    TargetBuffer[0] = 0x68;</div>
<div class="line"><span class="lineno">  798</span> </div>
<div class="line"><span class="lineno">  799</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  800</span>    <span class="comment">// Lower 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  801</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  802</span>    *((<a class="code hl_typedef" href="_basic_types_8h.html#a8e3d0f172defb4e820ad5df4ec48960c">PUINT32</a>)&amp;TargetBuffer[1]) = (<a class="code hl_typedef" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)TargetAddress;</div>
<div class="line"><span class="lineno">  803</span> </div>
<div class="line"><span class="lineno">  804</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  805</span>    <span class="comment">// mov [rsp+4],High 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  806</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  807</span>    TargetBuffer[5] = 0xC7;</div>
<div class="line"><span class="lineno">  808</span>    TargetBuffer[6] = 0x44;</div>
<div class="line"><span class="lineno">  809</span>    TargetBuffer[7] = 0x24;</div>
<div class="line"><span class="lineno">  810</span>    TargetBuffer[8] = 0x04;</div>
<div class="line"><span class="lineno">  811</span> </div>
<div class="line"><span class="lineno">  812</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  813</span>    <span class="comment">// High 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  814</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  815</span>    *((<a class="code hl_typedef" href="_basic_types_8h.html#a8e3d0f172defb4e820ad5df4ec48960c">PUINT32</a>)&amp;TargetBuffer[9]) = (<a class="code hl_typedef" href="_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)(TargetAddress &gt;&gt; 32);</div>
<div class="line"><span class="lineno">  816</span> </div>
<div class="line"><span class="lineno">  817</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  818</span>    <span class="comment">// ret</span></div>
<div class="line"><span class="lineno">  819</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  820</span>    TargetBuffer[13] = 0xC3;</div>
<div class="line"><span class="lineno">  821</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="af62063007bc1450386954e16032ce5fd" name="af62063007bc1450386954e16032ce5fd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af62063007bc1450386954e16032ce5fd">&#9670;&#160;</a></span>ExAllocatePoolWithTagHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PVOID ExAllocatePoolWithTagHook </td>
          <td>(</td>
          <td class="paramtype">POOL_TYPE</td>          <td class="paramname"><span class="paramname"><em>PoolType</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SIZE_T</td>          <td class="paramname"><span class="paramname"><em>NumberOfBytes</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></td>          <td class="paramname"><span class="paramname"><em>Tag</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Hook function that HooksExAllocatePoolWithTag. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PoolType</td><td></td></tr>
    <tr><td class="paramname">NumberOfBytes</td><td></td></tr>
    <tr><td class="paramname">Tag</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PVOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  454</span>{</div>
<div class="line"><span class="lineno">  455</span>    <a class="code hl_define" href="_hyper_dbg_hyper_log_intrinsics_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a>(<span class="stringliteral">&quot;ExAllocatePoolWithTag Called with : Tag = 0x%x, Number Of Bytes = 0x%x, Pool Type = 0x%x &quot;</span>,</div>
<div class="line"><span class="lineno">  456</span>            <a class="code hl_variable" href="_hooks_8h.html#aba7c9f3767dcc5232354d3d17ceedb61">Tag</a>,</div>
<div class="line"><span class="lineno">  457</span>            <a class="code hl_variable" href="_hooks_8h.html#a61083d5dde730c2afd10a336322aaaac">NumberOfBytes</a>,</div>
<div class="line"><span class="lineno">  458</span>            <a class="code hl_variable" href="_hooks_8h.html#a5d405dff9ba7e6c73d78857f415965f4">PoolType</a>);</div>
<div class="line"><span class="lineno">  459</span> </div>
<div class="line"><span class="lineno">  460</span>    <span class="keywordflow">return</span> ExAllocatePoolWithTagOrig(<a class="code hl_variable" href="_hooks_8h.html#a5d405dff9ba7e6c73d78857f415965f4">PoolType</a>, <a class="code hl_variable" href="_hooks_8h.html#a61083d5dde730c2afd10a336322aaaac">NumberOfBytes</a>, <a class="code hl_variable" href="_hooks_8h.html#aba7c9f3767dcc5232354d3d17ceedb61">Tag</a>);</div>
<div class="line"><span class="lineno">  461</span>}</div>
<div class="ttc" id="a_hooks_8h_html_a5d405dff9ba7e6c73d78857f415965f4"><div class="ttname"><a href="_hooks_8h.html#a5d405dff9ba7e6c73d78857f415965f4">PoolType</a></div><div class="ttdeci">POOL_TYPE PoolType</div><div class="ttdef"><b>Definition</b> Hooks.h:166</div></div>
<div class="ttc" id="a_hooks_8h_html_a61083d5dde730c2afd10a336322aaaac"><div class="ttname"><a href="_hooks_8h.html#a61083d5dde730c2afd10a336322aaaac">NumberOfBytes</a></div><div class="ttdeci">POOL_TYPE SIZE_T NumberOfBytes</div><div class="ttdef"><b>Definition</b> Hooks.h:167</div></div>
<div class="ttc" id="a_hooks_8h_html_aba7c9f3767dcc5232354d3d17ceedb61"><div class="ttname"><a href="_hooks_8h.html#aba7c9f3767dcc5232354d3d17ceedb61">Tag</a></div><div class="ttdeci">POOL_TYPE SIZE_T ULONG Tag</div><div class="ttdef"><b>Definition</b> Hooks.h:168</div></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_53a6cdbae347618e9ee76d4be5c6ea96.html">hyperdbg</a></li><li class="navelem"><a class="el" href="dir_e536aab728f7b0abbbf7dc8fdcfcc81b.html">hyperhv</a></li><li class="navelem"><a class="el" href="dir_1ae2c003efa9a319fe8e6b483281e084.html">code</a></li><li class="navelem"><a class="el" href="dir_fb51e9dce09b0ba5a7ef5d19ede36a2c.html">hooks</a></li><li class="navelem"><a class="el" href="dir_83cd24e7e8c13cec48336cb9e87e3a0d.html">ept-hook</a></li><li class="navelem"><a class="el" href="_ept_hook_8c.html">EptHook.c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
